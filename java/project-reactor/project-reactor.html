<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Project Reactor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Project Reactor</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_основные_понятия_об_асинхронном_коде">Основные понятия об асинхронном коде</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Компьютерные программы часто имеют дело с длительными процессами. Например, получают данные из базы данных или производят сложные вычисления. Пока выполняется одна операция, можно завершить еще несколько. Асинхронное программирование увеличивает эффективность, потому что не позволяет блокировать основной поток выполнения.</p>
</div>
<div class="paragraph">
<p>В синхронном коде каждая операция ожидает окончания предыдущей. Поэтому вся программа может зависнуть, если одна из команд выполняется очень долго. Асинхронный код убирает блокирующую операцию из основного потока программы, так что она продолжает выполняться, но где-то в другом месте, а обработчик может идти дальше. Проще говоря, главный процесс ставит задачу и передает ее другому независимому процессу.</p>
</div>
<div class="paragraph">
<p>Возьмем для примера приложение, которое подбирает фильм по указанным критериям. После того как пользователь выбрал параметры, программа отправляет запрос на сервер, где происходит подбор подходящих картин. Обработка может длиться довольно долго. Если приложение работает синхронно, то пользователь не сможет взаимодействовать со страницей, пока не придет результат.</p>
</div>
<div class="paragraph">
<p>Таким образом, асинхронность в программировании — выполнение процесса в неблокирующем режиме системного вызова, что позволяет потоку программы продолжить обработку.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_недостатки_синхронного_программирования">Недостатки синхронного программирования</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Рассмотрим основные недостатки синхронного программирования поподробнее.</p>
</div>
<div class="sect2">
<h3 id="_модель_поток_на_запрос">Модель поток на запрос</h3>
<div class="paragraph">
<p>Чтобы понять, что такое реактивное программирование и какие преимущества оно дает, сначала рассмотрим традиционный способ разработки веб-приложения с помощью <strong>Spring</strong> - использование <strong>Spring MVC</strong> и его развертывание в контейнере сервлетов, таком как <strong>Tomcat</strong>: контейнер сервлетов имеет выделенный пул потоков для обработки <strong>HTTP</strong>-запросов, где каждому входящему запросу будет назначен поток, и этот поток будет обрабатывать весь жизненный цикл запроса. Это означает, что приложение сможет обрабатывать количество одновременных запросов, равное размеру пула потоков. Можно настроить размер пула потоков, но поскольку каждый поток резервирует некоторую память (обычно один мегабайт), чем больший размер пула потоков настраиваем, тем выше потребление памяти.</p>
</div>
<div class="paragraph">
<p>Если приложение разработано в соответствии с архитектурой на основе микросервисов, у нас есть лучшие возможности для масштабирования в зависимости от нагрузки, но за высокое использование памяти по-прежнему приходится платить. Таким образом, модель потока на запрос может стать довольно дорогостоящей для приложений с большим количеством одновременных запросов.</p>
</div>
<div class="paragraph">
<p>Важной характеристикой архитектур на основе микросервисов является то, что приложение распределено, выполняется большое количество отдельных процессов, обычно на нескольких серверах. Использование традиционного императивного программирования с синхронными вызовами запроса/ответа для взаимодействия между службами означает, что потоки часто блокируются в ожидании ответа от другой службы, что приводит к огромной трате ресурсов.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ожидание_операций_вводавывода">Ожидание операций ввода/вывода</h3>
<div class="paragraph">
<p>При ожидании завершения операций ввода-вывода возникают потери. В таких ситуациях поток, выполняющий запрос ввода-вывода, будет заблокирован и будет ожидать, пока операция не будет завершена, это называется блокирующим вводом-выводом. Такие ситуации, когда выполняющийся поток блокируется, просто ожидая ответа, означает потерю потоков и, следовательно, потерю памяти.</p>
</div>
<div class="paragraph">
<div class="title">Демонстрация заблокированного потока в ожидании ответа</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/thread-bloking.jpeg" alt="thread bloking"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_время_ответа">Время ответа</h3>
<div class="paragraph">
<p>Другой проблемой традиционного императивного программирования является время отклика, когда службе необходимо выполнить более одного запроса ввода-вывода. Например, службе <strong>A</strong> может потребоваться вызвать службы <strong>B</strong> и <strong>C</strong>, а также выполнить поиск в базе данных, а затем вернуть в результате некоторые агрегированные данные. Это будет означать, что время ответа службы <strong>A</strong>, помимо времени ее обработки, будет суммой следующих значений:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Время отклика услуги <strong>B</strong> (задержка сети + обработка).</p>
</li>
<li>
<p>Время отклика службы <strong>C</strong> (задержка сети + обработка).</p>
</li>
<li>
<p>Время ответа на запрос к базе данных (сетевая задержка + обработка).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Если нет никакой реальной логической причины выполнять эти вызовы последовательно, то, безусловно, если эти вызовы будут выполняться параллельно, это очень положительно повлияет на время отклика службы <strong>А</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_перегрузка_клиента">Перегрузка клиента</h3>
<div class="paragraph">
<p>Другой тип проблемы, которая может возникнуть в ландшафте микросервисов, - это когда сервис <strong>A</strong> запрашивает некоторую информацию у сервиса <strong>B</strong>, скажем, например, обо всех заказах, размещенных в течение последнего месяца.
Если количество заказов окажется огромным, для службы <strong>А</strong> может возникнуть проблема получить всю эту информацию сразу.
Служба <strong>A</strong> может быть перегружена большим объемом данных, что может привести к ошибке нехватки памяти.</p>
</div>
</div>
<div class="sect2">
<h3 id="_резюме">Резюме</h3>
<div class="paragraph">
<p>Различные проблемы, описанные выше - это проблемы, которые призвано решить реактивное программирование.
Преимущества реактивного программирования заключаются в том, что разработчик может:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Отойти от модели поток на запрос и может обрабатывать больше запросов с небольшим количеством потоков.</p>
</li>
<li>
<p>Предотвратить блокировку потоков при ожидании завершения операций ввода-вывода.</p>
</li>
<li>
<p>Оптимизировать параллельные вызовы.</p>
</li>
<li>
<p>Поддерживать <strong>обратное давление</strong>, давая клиенту возможность сообщить серверу, с какой нагрузкой он может справиться.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_что_такое_реактивное_программирование">Что такое реактивное программирование</h2>
<div class="sectionbody">
<div class="paragraph">
<p>В документации <strong>Spring</strong> дано следующее краткое определение реактивного программирования:</p>
</div>
<div class="paragraph">
<p><strong>Реактивное программирование</strong> - это неблокирующие приложения, которые являются асинхронными и управляемыми событиями, и требуют небольшого количества потоков для масштабирования. Ключевым аспектом этого определения является концепция противодавления (<strong>backpressure</strong>), которая является механизмом, гарантирующим, что производители не перегружают потребителей.</p>
</div>
<div class="paragraph">
<p>Так как же всего этого достичь? Использовать асинхронные потоки данных!</p>
</div>
<div class="paragraph">
<p>Допустим, служба <strong>A</strong> хочет получить некоторые данные из службы <strong>B</strong>. При подходе в стиле реактивного программирования служба <strong>A</strong> отправит запрос службе <strong>B</strong>, которая немедленно вернет управление (неблокирующий и асинхронный запрос). Затем запрошенные данные будут доступны службе <strong>A</strong> в виде потока данных, где служба <strong>B</strong> будет публиковать событие <strong>onNext()</strong> для каждого элемента данных один за другим. Когда все данные будут опубликованы, об этом просигнализирует событие <strong>onComplete()</strong>. В случае ошибки будет опубликовано событие <strong>onError()</strong> и больше никаких элементов не будет.</p>
</div>
<div class="paragraph">
<div class="title">Реактивный поток событий</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/reactive-event-stream.jpeg" alt="reactive event stream"></span></p>
</div>
<div class="paragraph">
<p><strong>Реактивное программирование</strong> - важный метод реализации при разработке реактивных систем, концепция которого описана в <strong>Reactive Manifesto</strong> - манифесте реактивного программирования, подчеркивая требования к проектированию современных приложений, которые должны быть:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Responsive</strong> - отзывчивы (дают своевременный ответ).</p>
</li>
<li>
<p><strong>Resilient</strong> - устойчивы (остаются отзывчивыми даже в аварийных ситуациях).</p>
</li>
<li>
<p><strong>Elastic</strong> - эластичны (быстрая реакция при различной рабочей нагрузке).</p>
</li>
<li>
<p><strong>Message Driven</strong> - управляются сообщениями (на основе асинхронной передачи сообщений).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Но чтобы спроектировать систему реактивную в целом, также требуется архитектура, которая обеспечивает все эти аспекты.</p>
</div>
<div class="sect2">
<h3 id="_архитектура_обеспечения_аспектов_reactive_manifesto">Архитектура обеспечения аспектов <strong>Reactive Manifesto</strong></h3>
<div class="paragraph">
<p>В основе подхода лежит идея разделения компонентов на два типа: источник событий <strong>Publisher</strong> и обработчик событий <strong>Subscriber</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Subscriber</strong> подписывается на события, которые создаёт <strong>Publisher</strong>, а затем каким-то образом их обрабатывает. У одного <strong>Publisher</strong> может быть много подписчиков.</p>
</div>
<div class="paragraph">
<p>Существует еще одно понятие — <strong>Observer</strong>. Он может подписаться на событие объекта и выполнять какие-либо действия с полученным результатом.</p>
</div>
<div class="paragraph">
<p>Общение между <strong>Publisher</strong> и <strong>Subscriber</strong> происходит через объект <strong>Subscription</strong>.</p>
</div>
<div class="paragraph">
<div class="title">Модель взаимодействия <strong>Publisher</strong> и <strong>Subscriber</strong></div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/relationship-model.png" alt="relationship model"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_спецификация_реактивных_потоков_для_java">Спецификация реактивных потоков для <strong>Java</strong></h3>
<div class="paragraph">
<p>Для <strong>Java</strong> был разработан стандарт спецификации <strong>Reactive Streams</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Reactive Streams</strong> - это небольшая спецификация, предназначенная для реализации реактивными библиотеками, созданными для <strong>JVM</strong>. Он определяет типы, которые необходимо реализовать для достижения взаимодействия между различными реализациями. Спецификация определяет взаимодействие между асинхронными компонентами с противодавлением. Реактивные потоки были реализованы в <strong>Java 9</strong> в виде <strong>Flow API</strong>.</p>
</div>
<div class="paragraph">
<p>Спецификация <strong>Reactive Streams</strong> включает следующие интерфейсы:</p>
</div>
<div class="paragraph">
<p><strong>Publisher</strong> - он представляет производителя данных, является их источником и имеет один метод, который позволяет подписчику зарегистрироваться (подписаться) на издателя.</p>
</div>
<div class="listingblock">
<div class="title">Interface Publisher&lt;T&gt; в Java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Publisher&lt;T&gt; {
    public void subscribe(Subscriber&lt;? super T&gt; s);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Subscriber</strong> - он представляет потребителя и имеет следующие методы:</p>
</div>
<div class="listingblock">
<div class="title">Interface Subscriber&lt;T&gt;  в Java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Subscriber&lt;T&gt; {
    public void onSubscribe(Subscription s);
    public void onNext(T t);
    public void onError(Throwable t);
    public void onComplete();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onSubscribe()</code> - должен вызываться <strong>Publisher</strong> перед началом обработки и использоваться для передачи на <strong>Subscription</strong> объекта от <strong>Publisher</strong> до <strong>Subscriber</strong>.</p>
</li>
<li>
<p><code>onNext()</code> - используется для того, чтобы сигнализировать о том, что был отправлен новый элемент.</p>
</li>
<li>
<p><code>onError()</code> - используется для того, чтобы сигнализировать о том, что произошел сбой <strong>Publisher</strong> и больше никаких элементов не будет.</p>
</li>
<li>
<p><code>onComplete()</code> - используется для того, чтобы сигнализировать, что все элементы были успешно отправлены.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Subscription</strong> в свою очередь, содержит методы, которые позволяют клиенту управлять выдачей элементов <strong>Publisher</strong> (т.е. обеспечивать поддержку противодавления).</p>
</div>
<div class="listingblock">
<div class="title">Interface Subscription в Java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Subscription {
    public void request(long n);
    public void cancel();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>request()</code> - позволяет <strong>Subscriber</strong> сообщить, <strong>Publisher</strong> сколько дополнительных элементов будет опубликовано.</p>
</li>
<li>
<p><code>cancel()</code> - позволяет подписчику отменить дальнейшую отправку элементов <strong>Publisher</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Если объект должен преобразовывать входящие элементы, а затем передавать их другому <strong>Subscriber</strong>, требуется реализация интерфейса <strong>Processor</strong>. Он действует и как <strong>Subscriber</strong> и как <strong>Publisher</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Interface Processor в Java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Processor&lt;T, R&gt; extends Subscriber&lt;T&gt;, Publisher&lt;R&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Интерфейсы <strong>Publisher</strong>, <strong>Subscriber</strong> и <strong>Subscription</strong> находятся в пакете <strong>org.reactivestreams</strong>, который по умолчанию был добавлен в <strong>Java 9</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_reactor">Project REACTOR</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Project Reactor</strong> - это библиотека <strong>Reactive</strong> для создания неблокирующих приложений на <strong>JVM</strong>, основанная на спецификации <strong>Reactive Streams</strong>.</p>
</div>
<div class="sect2">
<h3 id="_возможности_reactor_core">Возможности <strong>Reactor Core</strong></h3>
<div class="paragraph">
<p><strong>Reactor Core</strong> определяет реактивные типы <strong>Flux</strong> и <strong>Mono</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Flux</strong> - это <strong>Publisher</strong>, который может испускать от <strong>0</strong> до <strong>N</strong> элементов.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Схема работы Flux</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/flux.svg" alt="flux"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Mono</strong> в свою очередь может испускать от <strong>0</strong> до <strong>1</strong> элемента.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Схема работы Mono</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/mono.svg" alt="mono"></span></p>
</div>
<div class="paragraph">
<p>Оба они завершаются либо сигналом завершения, либо ошибкой, и они вызывают методы <strong>onNext()</strong>, <strong>onComplete()</strong> и <strong>onError()</strong> нижестоящего подписчика. Помимо реализации функций, описанных в спецификации <strong>Reactive Streams</strong>, <strong>Flux</strong> и <strong>Mono</strong> предоставляют набор операторов для поддержки преобразований, фильтрации и обработки ошибок.</p>
</div>
<div class="paragraph">
<p>Приведём пример создания объекта типа <strong>Flux</strong>. Создадим пустой <strong>Flux</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Mono</strong> с помощью <strong>empty()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void getEmptyMono() {
    Mono.empty();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>Flux</strong> содержащий значения:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Mono</strong> с помощью <strong>just()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void simpleFluxExample() {
    Flux&lt;String&gt; fluxColors = Flux.just("red", "green", "blue");
    fluxColors.subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>Flux</strong> который выведет в консоль значения от <code>1</code> до <code>5</code>:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Flux</strong> с помощью <strong>range()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void range() {
    Flux.range(1, 5)
        .subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>Flux</strong>, который испускает эти же самые элементы из списка:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Flux</strong> с помощью <strong>fromIterable()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void fooBarFluxFromList() {
    Flux&lt;String&gt; fluxFromList = Flux.fromIterable(Arrays.asList("red", "green"));
    fluxFromList.subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cоздадим <strong>Flux</strong>, который испускает числа от <code>1</code> до <code>10</code> каждые <code>100</code> мс:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Flux</strong> с помощью <strong>interval()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void counter() throws InterruptedException {
    Flux&lt;Long&gt; flux = Flux.interval(Duration.ofMillis(100)).take(10);
    flux.subscribe(System.out::println);
    Thread.sleep(2000);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Эти методы создают поток, который испускает предоставленные элементы, а затем завершается. Ничего не передается, пока кто-нибудь на это не подпишется. Чтобы подписаться на него, мы вызываем метод <strong>subscribe()</strong> и в этом случае просто распечатываем отправленные элементы.</p>
</div>
<div class="paragraph">
<p>Создание <strong>Mono</strong> также может быть выполнено с помощью метода <strong>just</strong>, с той лишь разницей, что разрешен только один параметр.</p>
</div>
<div class="paragraph">
<p>Методы класса <strong>Flux</strong> возвращают <strong>Flux</strong> или <strong>Mono</strong>, что означает, что операторы могут быть связаны.</p>
</div>
<div class="paragraph">
<p>Мы можем создать <strong>Flux</strong> из <strong>Mono</strong> и наоборот:</p>
</div>
<div class="listingblock">
<div class="title">Создание <strong>Flux</strong> из <strong>Mono</strong> и наоборот</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux&lt;Integer&gt; fluxFromMono = mono.flux();
Mono&lt;Boolean&gt; monoFromFlux = flux.any(s -&gt; s.equals(1));
Mono&lt;Integer&gt; integerMono = flux.elementAt(1);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_варианты_метода_subscribe">Варианты метода Subscribe()</h3>
<div class="paragraph">
<p>У программиста есть широкий выбор вариантов метода <strong>subscribe()</strong>, которые принимают лямбда-выражения для различных комбинаций обратных вызовов, как показано в следующих сигнатурах методах:</p>
</div>
<div class="listingblock">
<div class="title">Варианты метода <strong>subscribe()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">1) subscribe();

2) subscribe(Consumer&lt;? super T&gt; consumer);

3) subscribe(Consumer&lt;? super T&gt; consumer,
          Consumer&lt;? super Throwable&gt; errorConsumer);

4) subscribe(Consumer&lt;? super T&gt; consumer,
          Consumer&lt;? super Throwable&gt; errorConsumer,
          Runnable completeConsumer);

5) subscribe(Consumer&lt;? super T&gt; consumer,
          Consumer&lt;? super Throwable&gt; errorConsumer,
          Runnable completeConsumer,
          Consumer&lt;? super Subscription&gt; subscriptionConsumer);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>1) Подписаться и активировать последовательность.</p>
</li>
<li>
<p>2) Сделайте что-нибудь с каждым полученным значением.</p>
</li>
<li>
<p>3) Работать со значениями, но также реагировать на исключительные ситуации.</p>
</li>
<li>
<p>4) Работать со значениями и ошибками, а также запускайте некоторый код после успешного завершения последовательности.</p>
</li>
<li>
<p>5) Работать со значениями, ошибками и успешным завершением, а также делайте что-то с подпиской, созданной этим вызовом подписки.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_перечень_операторов_в_reactor">Перечень операторов в <strong>Reactor</strong></h3>
<div class="paragraph">
<p>Поиск подходящего оператора <strong>Reactor</strong> предоставляет длинный список операторов и в качестве помощи в поиске подходящего оператора для конкретного варианта использования есть специальное приложение в справочной документации <strong>Reactor</strong>.
Он разделен на различные категории, как показано в таблице ниже.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Каскадные операции</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Категория оператора</th>
<th class="tableblock halign-left valign-top">Примеры</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Создание новой последовательности</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">just, fromArray, fromIterable, fromStream</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Преобразование существующей последовательности</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map, flatMap, startWith, concatWith</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Заглядывать в последовательность</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">doOnNext, doOnComplete, doOnError, doOnCancel</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Фильтрация последовательности</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filter, ignoreElements, distinct, elementAt, takeLast</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Обработка ошибок</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">onErrorReturn, onErrorResume, retry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Работаем со временем</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">elapsed, interval, timestamp, timeout</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Расщепление потока</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">buffer, groupBy, window</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Возвращаясь к синхронному миру</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">block, blockFirst, blockLast, toIterable, toStream</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Многоадресная рассылка потока нескольким подписчикам</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">publish, cache, replay</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Например, преобразуем элементы, создаваемые путем применения синхронной функции к каждому элементу:</p>
</div>
<div class="listingblock">
<div class="title">Использование функции <strong>map()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void mapExample() {
    Flux&lt;String&gt; fluxColors = Flux.just("red", "green", "blue");
    fluxColors.map(color -&gt; color.charAt(0)).subscribe(System.out::print);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат использования функции <strong>map()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">rgb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Или функция <strong>zip()</strong>, который объединяет несколько источников вместе (ожидая, пока все источники испускают один элемент, и объединяет их в кортеж):</p>
</div>
<div class="listingblock">
<div class="title">Пример использования функции <strong>zip()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void zipExample() {
    Flux&lt;String&gt; fluxFruits = Flux.just("apple", "pear", "plum");
    Flux&lt;String&gt; fluxColors = Flux.just("red", "green", "blue");
    Flux&lt;Integer&gt; fluxAmounts = Flux.just(10, 20, 30);
    Flux.zip(fluxFruits, fluxColors, fluxAmounts).subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат использования функции <strong>zip()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">[apple, red, 10]
[pear, green, 20]
[plum, blue, 30]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_обработка_ошибок">Обработка ошибок</h3>
<div class="paragraph">
<p>Создадим <strong>Flux</strong>, который испускает ошибку. Для этого есть специальный сигнал, так как мы не можем просто выбросить исключение — оно может оказаться в другом треде:</p>
</div>
<div class="listingblock">
<div class="title">Создание ошибки в объекте <strong>Flux</strong> с помощью метода <strong>error()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void errorFlux() {
    Flux&lt;Object&gt; error = Flux.error(new IllegalStateException());
    error.subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Ошибки</strong> - это терминальные события. При возникновении ошибки вся последовательность останавливается, и ошибка передается методу <strong>onError()</strong> подписчика, который всегда должен быть определен.
Если не определено, <strong>onError</strong> вызовет исключение <strong>UnsupportedOperationException</strong>.</p>
</div>
<div class="paragraph">
<p>Запустив следующий пример, третье значение никогда не генерируется, поскольку второе значение приводит к ошибке:</p>
</div>
<div class="listingblock">
<div class="title">Генерация ошибки</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void onErrorExample() {
    Flux&lt;String&gt; fluxCalc = Flux.just(-1, 0, 1)
        .map(i -&gt; "10 / " + i + " = " + (10 / i));

    fluxCalc.subscribe(value -&gt; System.out.println("Next: " + value),
                       error -&gt; System.err.println("Error: " + error));
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат генерации ошибки</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Next: 10 / -1 = -10
Error: java.lang.ArithmeticException: / by zero</code></pre>
</div>
</div>
<div class="paragraph">
<p>Также можно обрабатывать ошибки в середине реактивной цепочки, используя операторы обработки ошибок. Метод <strong>onErrorReturn()</strong> будет выдавать резервное значение, когда наблюдается ошибка указанного типа. Это можно сравнить с перехватом исключения и возвратом статического запасного значения в императивном программировании.</p>
</div>
<div class="listingblock">
<div class="title">Пример обработки ошибки</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void onErrorReturnExample() {
    Flux&lt;String&gt; fluxCalc = Flux.just(-1, 0, 1)
                                .map(i -&gt; "10 / " + i + " = " + (10 / i))
                                .onErrorReturn(ArithmeticException.class, "Division by 0 not allowed");
    fluxCalc
            .subscribe(value -&gt; System.out.println("Next: " + value),
                       error -&gt; System.err.println("Error: " + error));
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Next: 10 / -1 = -10
Next: Division by 0 not allowed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Как видите, использование оператора обработки ошибок таким образом все еще не позволяет продолжить исходную реактивную последовательность (третье значение здесь также не генерируется), а скорее заменяет ее. Если недостаточно просто вернуть какое-то значение по умолчанию, вы можете использовать этот <strong>onErrorResume()</strong> метод, чтобы подписаться на резервного издателя при возникновении ошибки. Это можно сравнить с перехватом исключения и вызовом резервного метода в императивном программировании. Если, например, вызов внешней службы завершается неудачно, реализация <strong>onErrorResume()</strong> может быть связана с извлечением данных из локального кеша.</p>
</div>
<div class="listingblock">
<div class="title">Перенаправление при возникновении ошибки</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void onErrorResume() {
    Flux&lt;Object&gt; error = Flux.error(new IllegalStateException());
    Flux&lt;Object&gt; objectFlux = error.onErrorResume(e -&gt; Flux.just(1, 2, 3));
    objectFlux.subscribe(System.out::println);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_модель_параллелизма">Модель параллелизма</h3>
<div class="paragraph">
<p>До сих пор издатель выполнялся в основном потоке так же, как подписчик. Это связано с тем, что <strong>Reactor</strong> не применяет модель параллелизма. Вместо этого выполнение большинства операторов будет продолжено в том же потоке, оставляя выбор за разработчиком. Модель выполнения определяется тем <strong>Scheduler</strong>, что используется.</p>
</div>
<div class="paragraph">
<p>С помощью <strong>Scheduler</strong> можно приказать потоку всегда выполняться в одном и том же thread или выделять новый thread при каждой подписке, или использовать собственный пул потоков и т.д.</p>
</div>
<div class="paragraph">
<p>Есть два способа переключения контекста выполнения в реактивной цепочке: <strong>publishOn()</strong> и <strong>subscribeOn()</strong>. Отличается следующее:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>publishOn(Scheduler scheduler)</code>  - если мы хотим например часть операторов выполнить в одном thread, а часть в другом. В случае с <strong>publishOn()</strong> этот оператор применяется так же, как и любой другой, посреди цепочки вызовов. Все последующие <strong>Subscriber</strong> будут выполняться в контексте указанного <strong>Scheduler</strong>.</p>
</li>
<li>
<p><code>subscribeOn(Scheduler scheduler)</code> — Чтобы изменить thread, в котором будет происходить выполнение реактивного потока. В случае с <strong>subscribeOn</strong> оператор «глобальный», срабатывает сразу на всю цепочку <strong>Subscriber</strong>. После вызова <strong>subscribe()</strong> контекстом выполнения будет указанный <strong>Scheduler</strong>. Далее контекст может изменяться с помощью оператора <strong>publishOn</strong>. Последующие вызовы <strong>subscribeOn</strong> игнорируются.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Класс <strong>Schedulers</strong> содержит статические методы, чтобы обеспечить контекст выполнения, например:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parallel()</code> — работает с пулом рабочих потоков фиксированного размера (по умолчанию размер пула ограничивается числом ядер процессора). Хорошо подходит для вычислительных задач.</p>
</li>
<li>
<p><code>single()</code> — выполнение в выделенном потоке. Он поддерживает планирование с учетом времени, поэтому может использоваться для планирования периодичес- ких событий с задержкой.</p>
</li>
<li>
<p><code>boundedElastic()</code> — динамически создает рабочие потоки и кеширует пулы потоков выполнения. Максимальное число создаваемых пулов потоков выполнения не ограничивается, поэтому этот планировщик можно использовать для организации выполнения задач, связанных с вводом/выводом. При использовании — <strong>Schedulers.newElastic()</strong> — можно указать количество <strong>workers</strong>. Это хороший выбор для обертывания синхронных, блокирующих вызовов.</p>
</li>
<li>
<p><code>immediate()</code> — выполнение будет происходить в текущем потоке.</p>
</li>
<li>
<p><code>fromExecutorService(ExecutorService)</code> - может использоваться для создания Планировщика из любого существующего <strong>ExecutorService</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим на примере:</p>
</div>
<div class="listingblock">
<div class="title">Принцип работы <strong>newParallel()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void publishSubscribeExample() {
    Scheduler schedulerA = Schedulers.newParallel("Scheduler A");
    Scheduler schedulerB = Schedulers.newParallel("Scheduler B");
    Scheduler schedulerC = Schedulers.newParallel("Scheduler C");

    Flux.just(1)
        .map(i -&gt; {
            System.out.println("First map: " + Thread.currentThread().getName());
            return i;
        })
        .subscribeOn(schedulerA)
        .map(i -&gt; {
            System.out.println("Second map: " + Thread.currentThread().getName());
            return i;
        })
        .publishOn(schedulerB)
        .map(i -&gt; {
            System.out.println("Third map: " + Thread.currentThread().getName());
            return i;
        })
        .subscribeOn(schedulerC)
        .map(i -&gt; {
            System.out.println("Fourth map: " + Thread.currentThread().getName());
            return i;
        })
        .publishOn(schedulerA)
        .map(i -&gt; {
            System.out.println("Fifth map: " + Thread.currentThread().getName());
            return i;
        })
        .blockLast();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Взглянув на вывод можно увидеть, что первая и вторая операции <strong>map()</strong> выполняются в потоке из планировщика <strong>A</strong>, поскольку первый <strong>subscribeOn()</strong> в цепочке переключается на этот планировщик, и это влияет на всю цепочку. Перед третьей операцией <strong>map()</strong> выполняется <strong>publishOn()</strong>, переключающий контекст выполнения на <strong>Scheduler B</strong>, в результате чего третья и четвертая операции <strong>map()</strong> выполняются в этом контексте (поскольку вторая <strong>subscribeOn()</strong> не будет иметь никакого эффекта). И, наконец, есть новый метод <strong>publishOn()</strong>, который переключает обратно на планировщик <strong>A</strong> перед последней операцией <strong>map()</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">First map: Scheduler A-4
Second map: Scheduler A-4
Third map: Scheduler B-3
Fourth map: Scheduler B-3
Fifth map: Scheduler A-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Некоторые операторы из <strong>Flux</strong> и <strong>Mono</strong> запускаются сразу на конкретном <strong>Scheduler</strong> (но можно передать и свой). Например <strong>Flux.interval()</strong> по умолчанию запускается на <strong>Schedulers.parallel()</strong>, но можно передать свой.</p>
</div>
<div class="listingblock">
<div class="title">Демонстрация установки собственного <strong>Schedulers</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Flux.interval(Duration.ofMillis(300), Schedulers.newSingle("test"));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_холодные_и_горячие_publisher">Холодные и горячие <strong>Publisher</strong></h3>
<div class="paragraph">
<p>Доступны два типа <strong>Publisher</strong> - <strong>cold</strong> и <strong>hot</strong> (холодные и горячие).</p>
</div>
<div class="paragraph">
<p>Как заявляли ранее, ничего не происходит, пока не подпишемся - но на самом деле это верно только для холодных издателей. <strong>Холодный Publisher</strong> генерирует новые данные для каждой подписке. Если подписки нет, данные никогда не генерируются. Напротив, <strong>hot издатель</strong> не зависит от подписчиков. Он может начать публикацию данных без подписчиков. Если подписчик подписывается после того, как издатель начал передавать значения, он получит только значения, выпущенные после его подписки.</p>
</div>
<div class="paragraph">
<p>Один из способов создания горячего <strong>Publisher</strong> - это вызвать <strong>publish()</strong> метод в <strong>Flux</strong>. Это вернет <strong>ConnectableFlux&lt;T&gt;</strong>, у которого есть метод <strong>connect()</strong> для запуска передачи значений. Подписчики должны затем подписаться на этот <strong>ConnectableFlux</strong> вместо исходного <strong>Flux</strong>.</p>
</div>
<div class="paragraph">
<p>Рассмотрим холодный и горячий <strong>Publisher</strong>, чтобы увидеть различное поведение. В приведенном ниже примере <strong>coldPublisherExample</strong> оператор <strong>interval()</strong> используется для создания потока, который генерирует значения <code>long</code>, начинающиеся с <code>0</code>.</p>
</div>
<div class="listingblock">
<div class="title">Пример использования <strong>interval()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void coldPublisherExample() throws InterruptedException {
    Flux&lt;Long&gt; intervalFlux = Flux.interval(Duration.ofSeconds(1));
    Thread.sleep(2000);
    intervalFlux.subscribe(i -&gt; System.out.println(String.format("Subscriber A, value: %d", i)));
    Thread.sleep(2000);
    intervalFlux.subscribe(i -&gt; System.out.println(String.format("Subscriber B, value: %d", i)));
    Thread.sleep(3000);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Subscriber A, value: 0
Subscriber A, value: 1
Subscriber A, value: 2
Subscriber B, value: 0
Subscriber A, value: 3
Subscriber B, value: 1
Subscriber A, value: 4
Subscriber B, value: 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь можно задаться вопросом, почему что-то происходит, когда основной поток спит, но это потому, что оператор интервала по умолчанию выполняется в планировщике <strong>Schedulers.parallel()</strong>. Как можно заметить, оба подписчика получат значения, начинающиеся с <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Теперь давайте посмотрим, что происходит, когда используем <strong>ConnectableFlux</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Использование объета типа <strong>ConnectableFlux</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void hotPublisherExample() throws InterruptedException {
    Flux&lt;Long&gt; intervalFlux = Flux.interval(Duration.ofSeconds(1));
    ConnectableFlux&lt;Long&gt; intervalCF = intervalFlux.publish();
    intervalCF.connect();
    Thread.sleep(2000);
    intervalCF.subscribe(i -&gt; System.out.println(String.format("Subscriber A, value: %d", i)));
    Thread.sleep(2000);
    intervalCF.subscribe(i -&gt; System.out.println(String.format("Subscriber B, value: %d", i)));
    Thread.sleep(3000);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Subscriber A, value: 2
Subscriber A, value: 3
Subscriber A, value: 4
Subscriber B, value: 4
Subscriber A, value: 5
Subscriber B, value: 5
Subscriber A, value: 6
Subscriber B, value: 6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Можно заметить, на этот раз ни один из подписчиков не получает исходные значения <code>0</code> и <code>1</code>. Они получают значения, которые отправляются после подписки. Вместо того чтобы вручную запускать публикацию, с помощью этого <strong>autoConnect(n)</strong> метода также можно настроить <strong>ConnectableFlux</strong> так, чтобы он запускался после <code>n</code> подписок.</p>
</div>
<div class="paragraph">
<p>Напечатаем текст на каждое действие — подписку, получение нового элемента и завершающего сигнала:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void fluxFruits() {
    Flux&lt;String&gt; fluxFruits = Flux.just("apple", "pear", "plum");

    Flux&lt;String&gt; flux = fluxFruits
        .doOnSubscribe(s -&gt; System.out.println("start"))
        .doOnNext(user -&gt; System.out.println("next value"))
        .doOnComplete(() -&gt; System.out.println("end!"));

    flux.subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">start
next value
apple
next value
pear
next value
plum
end!</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_другие_операторы">Другие операторы</h3>
<div class="sect3">
<h4 id="_функция_firstwithvalue">Функция <code>firstWithValue()</code></h4>
<div class="paragraph">
<p>Надо вернуть <strong>Flux</strong>, который испускает значение быстрее:</p>
</div>
<div class="listingblock">
<div class="title">Пример использования метода <strong>firstWithValue()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void getFirstWithValue() throws InterruptedException {
    Flux.firstWithValue(firstFlux(), secondFlux())
        .subscribe(System.out::println);
    Thread.sleep(4000);
}

public Flux&lt;Integer&gt; firstFlux() {
    return Flux.just(1, 2).delaySubscription(Duration.ofMillis(2000));
}

public Flux&lt;Integer&gt; secondFlux() {
    return Flux.just(3, 4).delaySubscription(Duration.ofMillis(1000));
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">3
4</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_функция_then">Функция <code>then()</code></h4>
<div class="paragraph">
<p>Преобразовать <strong>Flux</strong> в <strong>Mono</strong>, который испускает сигнал завершения тогда, когда приходит сигнал завершения в <strong>Flux</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Использование функции <strong>then()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void fluxToMono() {
    Flux&lt;Integer&gt; flux = Flux.just(10, 20);
    Mono&lt;Void&gt; then = flux.then();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_генерация_с_помощью_функции_generate">Генерация с помощью функции <code>generate()</code></h4>
<div class="paragraph">
<p>Реализовать бесконечный генератор можно с помощью функции <strong>generate()</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Генератор для вывода бесконечного количество раз слова:</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void generate() {
    Flux.&lt;String&gt; generate(sink -&gt; {
        sink.next("hello");
    })
    .subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Мы можем ограничить количество генерируемых значений и установить период между ними:</p>
</div>
<div class="listingblock">
<div class="title">Пример использования функции задержки с помощью метода <strong>delayElements()</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void generate() throws InterruptedException {
    Flux.&lt;String&gt;generate(sink -&gt; {
        sink.next("hello");
    })
    .delayElements(Duration.ofMillis(500))
    .take(4)
    .subscribe(System.out::println);

    Thread.sleep(4000);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Thread.sleep(4000)</code> - заставляет основной поток заснуть на <code>4</code> секунды. Дело в том, что вывод в консоль осуществляется в отдельном потоке, в свою очередь без <strong>Thread.sleep(4000)</strong> основной поток прекратит свою работу, что убьёт и дочерний поток.</p>
</div>
<div class="paragraph">
<p>Генераторы могут быть самыми разными, например такой генератор обладает интересной сигнатурой и может реализовывать самые интересные задумки:</p>
</div>
<div class="listingblock">
<div class="title">Пример генератора</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static &lt;T, S&gt; Flux&lt;T&gt; generate(Callable&lt;S&gt; stateSupplier, BiFunction&lt;S, SynchronousSink&lt;T&gt;, S&gt; generator) {
    return onAssembly(new FluxGenerate&lt;&gt;(stateSupplier, generator));
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Реализация генератора</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void generateBiFunction() {
    Flux.generate(
         () -&gt; 2354,
         (state, sink) -&gt; {
             if(state &gt; 2366) {
                sink.complete();
             } else {
                sink.next("Step: " + state);
             }
         return state + 3;
    }).subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Вывод в консоль:</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Step: 2354
Step: 2357
Step: 2360
Step: 2363
Step: 2366</code></pre>
</div>
</div>
<div class="paragraph">
<p>Метод <strong>create()</strong> принимает потребителя <strong>FluxSink&lt;T&gt;</strong>. То есть вам будет предоставлен экземпляр <strong>FluxSink</strong>, с помощью которого вы сможете продолжать испускать <code>0&#8230;&#8203;N</code> элементов нижестоящим подписчикам. Каждый подписчик получит экземпляр <strong>FluxSink</strong> для генерации элементов.</p>
</div>
<div class="paragraph">
<p>Следующий блок кода состоит из двух методов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>generateSmth()</code> - генерирует и возвращает объект <strong>Flux&lt;String&gt;</strong>.</p>
</li>
<li>
<p><code>createFlux()</code> - позволяет получить данные из другого <strong>Flux</strong> объекта с помощью подписки и манипулировать ими благодаря переопределенным методам.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Flux&lt;String&gt; generateSmth() {
    return Flux.generate(
        () -&gt; 2354,
        (state, sink) -&gt; {
            if (state &gt; 2366) {
                sink.complete();
            } else {
                sink.next("Step: " + state);
            }
        return state + 3;
        }
    );
}

public void createFlux() {
    Flux.create(sink -&gt; generateSmth().subscribe(new BaseSubscriber&lt;Object&gt;() {
    @Override
    protected void hookOnNext(Object value) {
        sink.next(value);
    }

    @Override
    protected void hookOnComplete() {
        sink.complete();
    }
    }))
    .subscribe(System.out::println);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Это хорошо работает, когда необходимо обрабатывать приходящие данные, но что если работаем с Базой Данных? Такие источники информации делятся данными только при обращении к ним. В таком случае с помощью метода <strong>onRequest()</strong> мы можем обратиться в вымешенную базу данных и запросить элемент:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void onRequest() {
    Flux.create(sink -&gt; sink.onRequest(r -&gt; {
        sink.next("DB returns: " + generateSmth().blockLast());
    }))
    .subscribe(System.out::println);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_класс_basesubscriber">Класс <code>BaseSubscriber</code></h3>
<div class="paragraph">
<p>Рассмотрим интересный класс:</p>
</div>
<div class="listingblock">
<div class="title">Пример кода с наследованием от <strong>BaseSubscriber</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void innerClass() {
    SampleSubscriber&lt;Integer&gt; ss = new SampleSubscriber&lt;Integer&gt;();
    Flux&lt;Integer&gt; ints = Flux.range(1, 4);
    ints.subscribe(ss);
}

public static class SampleSubscriber&lt;T&gt; extends BaseSubscriber&lt;T&gt; {
    public void hookOnSubscribe(Subscription subscription) {
        System.out.println("Subscribed");
        request(1);
}

    public void hookOnNext(T value) {
        System.out.println(value);
        request(1);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Subscribed
1
2
3
4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Класс <strong>SampleSubscriber</strong> расширяет <strong>BaseSubscriber</strong>, который является рекомендуемым абстрактным классом для определяемых пользователем подписчиков в <strong>Reactor</strong>. Класс предлагает <strong>hooks</strong>, которые можно переопределить, чтобы настроить поведение подписчика. По умолчанию он инициирует неограниченный запрос и ведет себя точно так же, как <strong>subscribe()</strong>. Однако расширение <strong>BaseSubscriber</strong> гораздо полезнее, благодаря своей дополнительной настройкой.</p>
</div>
<div class="paragraph">
<p>Абстрактный класс <strong>BaseSubscriber</strong> позволяет переопределить <strong>hooks</strong>-методы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hookOnSubscribe()</code> - действия при подписке на издателя.</p>
</li>
<li>
<p><code>hookOnNext()</code> - действия с переданным объектом.</p>
</li>
<li>
<p><code>hookOnComplete()</code> - действия по завершению обработки.</p>
</li>
<li>
<p><code>hookOnError()</code> - действия при ошибке.</p>
</li>
<li>
<p><code>hookOnCancel()</code> - выполняемые действия при отмене подписки путем вызова метода <strong>cancel()</strong> этого подписчика.</p>
</li>
<li>
<p><code>hookFinally()</code> - необязательный хук, выполняемый после любого из событий завершения <strong>onError()</strong>, <strong>onComplete()</strong>, <strong>cancel()</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_reactor_test">Reactor Test</h3>
<div class="paragraph">
<p>Модуль <strong>Reactor Test</strong> предоставляет служебные программы, которые могут помочь в тестировании поведения <strong>Flux</strong> или <strong>Mono</strong>. С этим помогает <strong>StepVerifier</strong>. Вы создаете <strong>StepVerifier</strong> и передаете его издателю для тестирования. <strong>StepVerifier</strong> подписывается на <strong>Publisher</strong> при вызове метода <code>verify()</code>, а затем сравнивает выданные значения с вашими определенными ожиданиями.</p>
</div>
<div class="listingblock">
<div class="title">Пример тестирования</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void stepVerifierTest() {
    Flux&lt;String&gt; fluxCalc = Flux.just(-1, 0, 1)
                                .map(i -&gt; "10 / " + i + " = " + (10 / i));

    StepVerifier.create(fluxCalc)
                .expectNextCount(1)
                .expectError(ArithmeticException.class)
                .verify();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для объекта создается <strong>StepVerifier</strong>, определяются два ожидания: сначала ожидается, что будет выдана одна строка, а затем должна быть выдана ошибка с типом <strong>ArithmeticException</strong>. С помощью вызова <code>verify()</code> <strong>StepVerifier</strong> начинает подписываться на <strong>Flux</strong>, и инициируется поток.</p>
</div>
<div class="paragraph">
<p><strong>StepVerifier</strong> также имеет другие функции, такие как включение утверждений после выполнения и поддержка виртуального времени, чтобы избежать длительного времени выполнения тестов, связанных с операторами, основанными на времени. Эти функции можно найти в документации.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_links">Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://projectreactor.io/">Project reactor official</a></p>
</li>
<li>
<p><a href="https://projectreactor.io/docs/core/release/reference/">Project reactor documentation</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/565050/">Рективное программирование со Spring</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=77-wOZs2nPE&amp;ab_channel=letsCode">Project Reactor - реактивная Java</a></p>
</li>
<li>
<p><a href="https://sysout.ru/razrabotka-reaktivnyh-prilozhenij-s-reactive-streams-i-java-8-chast-1/">Разработка реактивных приложений с Reactive Streams и Java</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-05-12 07:51:36 UTC
</div>
</div>
</body>
</html>