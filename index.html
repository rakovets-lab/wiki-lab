<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Wiki for lab</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Wiki for lab</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_application_architecture">1. Application Architecture</a></li>
<li><a href="#_java_core">2. Java Core</a></li>
<li><a href="#_spring_framework">3. Spring Framework</a>
<ul class="sectlevel2">
<li><a href="#_spring_core">3.1. Spring Core</a></li>
<li><a href="#_spring_mvc">3.2. Spring MVC</a></li>
</ul>
</li>
<li><a href="#_jakarta_servlet">4. Jakarta Servlet</a></li>
<li><a href="#_java_tools">5. Java Tools</a>
<ul class="sectlevel2">
<li><a href="#_testing_junit">5.1. Testing: JUnit</a></li>
<li><a href="#_testing_mockito">5.2. Testing: Mockito</a></li>
<li><a href="#_logging">5.3. Logging</a></li>
</ul>
</li>
<li><a href="#_orm_на_примере_hibernate">6. ORM (на примере Hibernate)</a>
<ul class="sectlevel2">
<li><a href="#_orm_на_примере_hibernate_2">6.1. ORM (на примере Hibernate)</a></li>
<li><a href="#_hibernate_cache">6.2. Hibernate cache</a></li>
</ul>
</li>
<li><a href="#_project_reactor">7. Project Reactor</a>
<ul class="sectlevel2">
<li><a href="#_основные_понятия_об_асинхронном_коде">7.1. Основные понятия об асинхронном коде</a></li>
<li><a href="#_недостатки_синхронного_программирования">7.2. Недостатки синхронного программирования</a></li>
<li><a href="#_что_такое_реактивное_программирование">7.3. Что такое реактивное программирование</a></li>
<li><a href="#_project_reactor_2">7.4. Project REACTOR</a></li>
<li><a href="#_links_5">7.5. Links</a></li>
</ul>
</li>
<li><a href="#_sql">8. SQL</a></li>
<li><a href="#_common">9. Common</a>
<ul class="sectlevel2">
<li><a href="#_github_keys">9.1. GitHub keys</a></li>
<li><a href="#_тестирование">9.2. Тестирование</a></li>
<li><a href="#_web_services">9.3. Web services</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Wiki for lab.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_architecture">1. Application Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Moved to <a href="https://github.com/rakovets/wiki" class="bare">https://github.com/rakovets/wiki</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_core">2. Java Core</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Moved to <a href="https://github.com/rakovets/wiki" class="bare">https://github.com/rakovets/wiki</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_framework">3. Spring Framework</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_spring_core">3.1. Spring Core</h3>
<div class="paragraph">
<p><strong>Spring Framework</strong> – это framework, который облегчает и ускоряет разработку приложений на Java.</p>
</div>
<div class="paragraph">
<p>Ключевым элементом <strong>Spring Framework</strong> является <strong>Spring Container</strong>, который выполняет основные функции:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>IoC</strong> – <strong>Inversion of Control</strong> (Создание и управление объектами);</p>
</li>
<li>
<p><strong>DI</strong> – <strong>Dependency Injection</strong> (внедрение зависимостей).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Container</strong> создаёт объекты, связывает их вместе, настраивает и управляет ими от создания до момента уничтожения. Эти объекты называются <strong>Spring Bean</strong>. Beans после создания помещаются в <strong>Spring Container</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/spring-container.png" alt="spring container"></span></p>
</div>
<div class="paragraph">
<p>В <strong>Spring</strong> имеется 2 различных вида контейнеров:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>BeanFactory</strong>;</p>
</li>
<li>
<p><strong>ApplicationContext</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>BeanFactory Container</strong> самый простой контейнер, обеспечивающий базовую поддержку <strong>DI</strong> и который основан на интерфейсе <code>org.springframework.beans.factory.BeanFactory</code>. Такие интерфейсы, как <code>BeanFactoryAware</code> и <code>DisposableBean</code> всё ещё присутствуют в <strong>Spring</strong> для обеспечения обратной совместимости. Наиболее часто используемая реализация интерфейса <code>BeanFactory</code> – <code>XmlBeanFactory</code>. <code>XmlBeanFactory</code> получает метаданные из конфигурационного <strong>XML</strong> файла и использует его для создания настроенного приложения или системы.</p>
</div>
<div class="paragraph">
<p><strong>BeanFactory Container</strong> обычно используется тогда, когда ресурсы ограничены (мобильные устройства). Поэтому, если ресурсы не сильно ограничены, то лучше использовать <strong>ApplicationContext</strong>.</p>
</div>
<div class="paragraph">
<p>Для того чтобы <strong>Spring Container</strong> мог создать и поместить в себя Beans необходимы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Java</strong> классы (<strong>POJO</strong>), из которых создаются Beans</p>
</li>
<li>
<p>метаданные, которые подсказывают что и как создавать</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/spring-ioc-container.png" alt="spring ioc container"></span></p>
</div>
<div class="paragraph">
<p>Эти метаданные можно сконфигурировать несколькими способами:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Xml</strong> конфигурация;</p>
</li>
<li>
<p><strong>Groovy</strong> конфигурация;</p>
</li>
<li>
<p>Конфигурация через аннотации;</p>
</li>
<li>
<p>Конфигурация через <strong>Java</strong>-код.</p>
</li>
<li>
<p>и т.д.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_bean_и_его_атрибуты">3.1.1. Bean и его атрибуты</h4>
<div class="paragraph">
<p><strong>Bean</strong> – это объект, экземпляр которого создается, собирается и иным образом управляется контейнером <strong>IoC Spring</strong> (создание, вызов методов инициализации и конфигурирование объектов путем связывания между собой).</p>
</div>
<div class="paragraph">
<p>Объекты, которые составляют основу приложения и управляются контейнером <strong>IoC Spring</strong>, называются <strong>Components</strong> (<strong>компонентами</strong> или управляемые Java-объект).</p>
</div>
<div class="paragraph">
<p>Определение <strong>Beans</strong> содержит метаданные конфигурации, которые необходимы управляющему контейнеру для получения следующей информации:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Как создать бин;</p>
</li>
<li>
<p>Информацию о жизненном цикле бина;</p>
</li>
<li>
<p>Зависимости бина.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>С помощью этих метаданных (атрибуты бина) мы можем настраивать бины.</p>
</div>
<div class="paragraph">
<p><strong>Bean</strong> имеет следующие атрибуты:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>class</strong> - этот атрибут является обязательным и указывает конкретный класс Java-приложения, который будет использоваться для создания бина.</p>
</li>
<li>
<p><strong>id</strong>/<strong>name</strong>- уникальный идентификатор бина. В случае конфигурации с помощью <strong>xml</strong>-файла, вы можете использовать свойство <code>id</code> и/или <code>name</code> для идентификации бина.</p>
</li>
<li>
<p><strong>scope</strong> - это свойство определяет область видимости создаваемых объектов.</p>
</li>
<li>
<p><strong>constructor-arg</strong> - определяет конструктор, использующийся для внедрения зависимости. Имеет атрибут <code>ref</code>, который указывает на <code>id</code> бина с которым нужно связываться.</p>
</li>
<li>
<p><strong>properties</strong> - определяет свойства внедрения зависимости.</p>
</li>
<li>
<p><strong>initialization method</strong> - здесь определяется метод инициализации бина</p>
</li>
<li>
<p><strong>destruction method</strong> - метод уничтожения бина, который будет использоваться при уничтожении контейнера, содержащего бин.</p>
</li>
<li>
<p><strong>autowiring mode</strong> - определяет режим автоматического связывания при внедрении зависимости.</p>
</li>
<li>
<p><strong>lazy-initialization mode</strong> - режим ленивой инициализации даёт контейнеру <strong>IoC</strong> команду создавать экземпляр бина при первом запросе, а не при запуске приложения.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_bean_scopes">3.1.2. Bean Scopes</h4>
<div class="paragraph">
<p>Очень важной особенностью является задание области применения бинов. По умолчанию всегда используется <strong>singleton</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Scope</strong> (область видимости) определяет:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>жизненный цикл бина;</p>
</li>
<li>
<p>возможное количество создаваемых бинов.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Разновидности <strong>bean scope</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Singleton</strong> – тип бина, при котором, создается одна сущность на <strong>Spring-контейнер</strong> (значение по умолчанию)</p>
</li>
<li>
<p><strong>Prototype</strong> – тип бина, при котором, каждый раз создается новая сущность бина.</p>
</li>
<li>
<p><strong>Request</strong> – тип бина, при котором сущность бина создается одна на request. Такой тип бина справедлив для контекста веб-приложения.</p>
</li>
<li>
<p><strong>Session</strong> – тип бина, при котором сущность бина создается только одна на объект http-session. Такой тип бина справедлив для контекста веб-приложения.</p>
</li>
<li>
<p><strong>Global-session</strong> – тип бина, при котором сущность бина одна создается на приложение. Такой тип бина справедлив для контекста портлета.</p>
</li>
<li>
<p><strong>Application</strong> – тип бина, задаваемый в единственном экземпляре на контекст сервлета. Действителен для контекста веб-приложения.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_конфигурация">3.1.3. Конфигурация</h4>
<div class="paragraph">
<p>Как указывалось выше, существует 4 вида конфигурации метаданных для создания бинов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Xml конфигурация</strong> — <code>ClassPathXmlApplicationContext("context.xml")</code>;</p>
</li>
<li>
<p><strong>Groovy конфигурация</strong> — <code>GenericGroovyApplicationContext("context.groovy")</code>;</p>
</li>
<li>
<p>Конфигурация через аннотации с указанием пакета для сканирования — <code>AnnotationConfigApplicationContext("package.name")</code>;</p>
</li>
<li>
<p><strong>JavaConfig</strong> — конфигурация через аннотации с указанием класса (или массива классов) помеченного аннотацией <code>@Configuration</code> — <code>AnnotationConfigApplicationContext(JavaConfig.class)</code>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_xml_конфигурация">Xml конфигурация</h5>
<div class="paragraph">
<p>Чтобы использовать настройку через xml-файл, необходимо создать <code>ClassPathXmlApplicationContext</code> и в параметры передать <strong>CLASSPATH</strong> xml-файла.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ниже приведен пример простого конфигурационного файла <strong>xml</strong> <code>applicationContext.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/context
    http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id =</span> <span class="s">"villain"</span> <span class="na">class =</span> <span class="s">"film.Villain"</span> <span class="na">lazy-init=</span> <span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name =</span> <span class="s">"name"</span> <span class="na">value =</span> <span class="s">"Vasily"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_groovy_конфигурация">Groovy конфигурация</h5>
<div class="paragraph">
<p>При конфигурации контекста с помощью <strong>groovy</strong>-файла, необходимо сформировать <code>GenericGroovyApplicationContext</code>, который принимает на вход строку с конфигурацией контекста. Эта конфигурация работает по сути так же, как и <strong>xml</strong>, только с <strong>groovy</strong>-файлами. К тому же, <code>GroovyApplicationContext</code> нормально работает и с <strong>xml</strong>-файлом.</p>
</div>
<div class="paragraph">
<p>Пример простого конфигурационного <strong>Groovy</strong>-файла:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">beans</span> <span class="o">{</span>
    <span class="n">goodOperator</span><span class="o">(</span><span class="n">film</span><span class="o">.</span><span class="na">Operator</span><span class="o">)</span> <span class="o">{</span><span class="n">bean</span> <span class="o">-</span> <span class="o">&gt;</span>
            <span class="n">bean</span><span class="o">.</span><span class="na">lazyInit</span> <span class="o">=</span> <span class="s1">'true'</span> <span class="o">&gt;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">'Good Oleg'</span>
         <span class="o">}</span>
    <span class="n">badOperator</span><span class="o">(</span><span class="n">film</span><span class="o">.</span><span class="na">BadOperator</span><span class="o">){</span><span class="n">bean</span> <span class="o">-</span> <span class="o">&gt;</span>
            <span class="n">bean</span><span class="o">.</span><span class="na">lazyInit</span> <span class="o">=</span> <span class="s1">'true'</span> <span class="o">&gt;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">'Bad Oleg'</span> <span class="o">/</span> <span class="o">&gt;</span>
        <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_конфигурация_через_аннотации">Конфигурация через аннотации</h5>
<div class="paragraph">
<p>При конфигурации через аннотации используются следующие аннотации:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Component</code></p>
</li>
<li>
<p><code>@Repository</code></p>
</li>
<li>
<p><code>@Service</code></p>
</li>
<li>
<p><code>@Controller</code></p>
</li>
<li>
<p><code>@RestController</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CoolDaoImpl</span> <span class="kd">implements</span> <span class="nc">CoolDao</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doCRUD</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//some logic here</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Service</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="nc">BeanDefinition</span><span class="o">.</span><span class="na">SCOPE_PROTOTYPE</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CoolServiceImpl</span> <span class="kd">implements</span> <span class="nc">CoolService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">CoolDao</span> <span class="n">dao</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//init logic here</span>
    <span class="o">}</span>

    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeResources</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//close resources here</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doWork</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">dao</span><span class="o">.</span><span class="na">doCRUD</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_конфигурация_через_java_код">Конфигурация через Java-код</h5>
<div class="paragraph">
<p>Центральными артефактами при конфигурации через <strong>Java</strong> в <strong>Spring</strong> являются <code>@Configuration</code> и <code>@Bean</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ClassName</span> <span class="nf">getClassName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ClassName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">"init"</span><span class="o">,</span> <span class="n">destroyMethod</span> <span class="o">=</span> <span class="s">"closeResources"</span><span class="o">)</span>
    <span class="nd">@Scope</span><span class="o">(</span><span class="nc">BeanDefinition</span><span class="o">.</span><span class="na">SCOPE_PROTOTYPE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ClassName2</span> <span class="nf">getClassName2</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ClassName2</span> <span class="n">className</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassName2</span><span class="o">();</span>
        <span class="n">className</span><span class="o">.</span><span class="na">getClassName</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_applicationcontext">3.1.4. ApplicationContext</h4>
<div class="paragraph">
<p><code>ApplicationContext</code> — это главный интерфейс в <strong>Spring</strong>-приложении, который предоставляет информацию о конфигурации приложения.</p>
</div>
<div class="paragraph">
<p><code>ApplicationContext</code> представляет собой <strong>Spring Container</strong>, место, где хранятся все созданные бины. Поэтому для получения бина из <strong>Spring Container</strong> нам нужно создать <code>ApplicationContext</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Чаще всего используются следующие реализации <code>ApplicationContext</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FileSystemXmlApplicationContext</code> - загружает данные о бине из xml-файла. При использовании этой реализации в конструкторе необходимо указать полный адрес конфигурационного файла.</p>
</li>
<li>
<p><code>ClassPathXmlApplicationContext</code> - этот контейнер также получает данные о бине из xml-файла. Но в отличие от <code>FileSystemApplicationContext</code>, в этом случае необходимо указать относительный адрес конфигурационного файла (<strong>CLASSPATH</strong>).</p>
</li>
<li>
<p><code>WebXmlApplicationContext</code> - эта реализация <code>ApplicationContext</code> получает необходимую информацию из веб-приложения.</p>
</li>
<li>
<p><code>AnnotationConfigApplicationContext</code> - конфигурация через аннотации с указанием пакета для сканирования</p>
</li>
<li>
<p><code>GenericGroovyApplicationContext</code> - конфигурация через <strong>groovy</strong>-файл</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>На рисунке ниже приведены этапы формирования <code>ApplicationContext</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/stages-of-context-initialization.png" alt="stages of context initialization"></span></p>
</div>
<div class="sect4">
<h5 id="_парсинг_конфигурации_и_создание_beandefinition">Парсинг конфигурации и создание <code>BeanDefinition</code></h5>
<div class="paragraph">
<p>На первом этапе происходит чтение конфигураций и создание <code>BeanDefinition</code>.</p>
</div>
<div class="paragraph">
<p><code>BeanDefinition</code> — это специальный интерфейс, через который можно получить доступ к метаданным будущего бина. В зависимости от того, какая у вас конфигурация, будет использоваться тот или иной механизм парсинга конфигурации.</p>
</div>
<div class="sect5">
<h6 id="_xml_config">XML config</h6>
<div class="paragraph">
<p>Для <strong>xml</strong> конфигурации используется класс — <code>XmlBeanDefinitionReader</code>, который реализует интерфейс <code>BeanDefinitionReader</code>. <code>XmlBeanDefinitionReader</code> получает <code>InputStream</code> и загружает <code>Document</code> через <code>DefaultDocumentLoader</code>. Далее обрабатывается каждый элемент документа и если он является бином, то создается <code>BeanDefinition</code> на основе заполненных данных (<code>id</code>, <code>name</code>, <code>class</code>, <code>alias</code>, <code>init-method</code>, <code>destroy-method</code> и др.)</p>
</div>
<div class="paragraph">
<p>Каждый <code>BeanDefinition</code> помещается в <strong>map</strong>. <strong>Map</strong> хранится в классе <code>DefaultListableBeanFactory</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_groovy_config">Groovy config</h6>
<div class="paragraph">
<p>Конфигурация через <strong>groovy</strong> очень похожа на конфигурацию через <strong>xml</strong>, за исключением того, что в файл не <strong>xml</strong>, а <strong>groovy</strong>. Чтением и парсинг <strong>groovy</strong> конфигурации занимается класс <code>GroovyBeanDefinitionReader</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_annotations_based_config">Annotations-based config</h6>
<div class="paragraph">
<p>Для конфигурации через аннотации с указанием пакета для сканирования или <strong>JavaConfig</strong> используется класс <code>AnnotationConfigApplicationContext</code>. Этот класс имеет следующие поля, с помощью которых происходит создание <code>BeanDefinition</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AnnotatedBeanDefinitionReader</code>;</p>
</li>
<li>
<p><code>ClassPathBeanDefinitionScanner</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ClassPathBeanDefinitionScanner</code> сканирует указанный пакет на наличие классов помеченных аннотацией <code>@Component</code> (или любой другой аннотацией которая включает в себя <code>@Component</code>). Найденные классы парсятся и для них создаются <code>BeanDefinition</code>.</p>
</div>
<div class="paragraph">
<p>Чтобы сканирование было запущено, в конфигурации должен быть указан пакет для сканирования. Вся магия работы с аннотациями, как в случае с <strong>xml</strong> и <strong>groovy</strong>, заключается именно в классе <code>ClassReader.class</code> из пакета <code>springframework.asm</code>. Специфика этого ридера заключается в том, что он умеет работать с байт-кодом. То есть, ридер достает <code>InputStream</code> из байт-кода, сканирует его и ищет там аннотации.</p>
</div>
<div class="paragraph">
<p><code>AnnotatedBeanDefinitionReader</code> работает в несколько этапов.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Первый этап</strong>: регистрация всех <code>@Configuration</code> для дальнейшего парсинга.<br>
Если в конфигурации используются <code>@Conditional</code>, то будут зарегистрированы только те конфигурации, для которых Condition вернет <code>true</code>. Аннотация <code>@Conditional</code> появилась в четвертой версии <strong>Spring Framework</strong>. Она используется в случае, когда на момент поднятия контекста нужно решить, создавать бин/конфигурацию или нет. Причем решение принимает специальный класс, который обязан реализовать интерфейс <code>Condition</code>.</p>
</li>
<li>
<p><strong>Второй этап</strong>: регистрация специального <code>BeanFactoryPostProcessor</code><br>
Если точнее, регистрация <code>BeanDefinitionRegistryPostProcessor</code>, который при помощи класса <code>ConfigurationClassParser</code> парсит <strong>JavaConfig</strong> и создает <code>BeanDefinition</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Каждый <code>BeanDefinition</code> помещается в <strong>map</strong>, который хранится в классе <code>DefaultListableBeanFactory</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">BeanDefinition</span><span class="o">&gt;</span> <span class="n">beanDefinitionMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">BeanDefinition</span><span class="o">&gt;();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_настройка_созданных_beandefinition_beanfactorypostprocessor">Настройка созданных <code>BeanDefinition</code> (<code>BeanFactoryPostProcessor</code>)</h5>
<div class="paragraph">
<p>После первого этапа у нас имеется <strong>map</strong>, в котором хранятся <code>BeanDefinition</code>. На этом этапе у нас есть возможность повлиять на то, какими будут наши бины еще до их фактического создания, иначе говоря мы имеем доступ к метаданным класса. Для этого существует специальный интерфейс <code>BeanFactoryPostProcessor</code>, реализовав который, мы получаем доступ к созданным <code>BeanDefinition</code> и можем их изменять.</p>
</div>
<div class="paragraph">
<p>В этом интерфейсе всего один метод:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Метод <code>postProcessBeanFactory()</code> принимает параметром <code>ConfigurableListableBeanFactory</code>. Данная фабрика содержит много полезных методов, в том числе <code>getBeanDefinitionNames()</code>, через который мы можем получить все <code>BeanDefinitionNames</code>, а уже потом по конкретному имени получить <strong>BeanDefinition</strong> для дальнейшей обработки метаданных</p>
</div>
</div>
<div class="sect4">
<h5 id="_создание_собственных_factorybean">Создание собственных <code>FactoryBean</code></h5>
<div class="paragraph">
<p>На этом этапе, если не устраивает <strong>BeanFactory</strong> из-под капота, можно создать собственные <code>FactoryBean</code>.</p>
</div>
<div class="paragraph">
<p><code>FactoryBean</code> — это <strong>generic</strong> интерфейс, которому можно делегировать процесс создания бинов необходимого типа. В те времена, когда конфигурация была исключительно в <strong>xml</strong>, разработчикам был необходим механизм с помощью которого они бы могли управлять процессом создания бинов. Именно для этого и был сделан этот интерфейс.</p>
</div>
<div class="paragraph">
<p>Чтобы создать свою фабрику бинов (собственный <code>FactoryBean</code>), необходимо реализовать интерфейс <code>FactoryBean</code> и переопределить три его метода.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassNameFactory</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">ClassName</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ClassName</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ClassName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ClassName</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_создание_экземпляров_бинов">Создание экземпляров бинов</h5>
<div class="paragraph">
<p>На этом этапе происходит создание бинов.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Созданием экземпляров бинов занимается <strong>BeanFactory</strong> при этом, если нужно, делегирует это кастомным <strong>FactoryBean</strong>.</p>
</li>
<li>
<p>Экземпляры бинов создаются на основе ранее созданных <strong>BeanDefinition</strong>.</p>
</li>
<li>
<p>При этом важно знать, что на этапе поднятия контекста создаются только бины с областью видимости <strong>Singleton</strong>.</p>
</li>
<li>
<p>Остальные бины создаются тогда, когда необходимы.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/create-bean-by-bean-factory.png" alt="create bean by bean factory"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="_настройка_созданных_бинов_beanpostprocessor">Настройка созданных бинов (<code>BeanPostProcessor</code>)</h5>
<div class="paragraph">
<p>На данном этапе можно производить дополнительную настройку созданных бинов. Настройка производиться через интерфейс <code>BeanPostProcessor</code>.</p>
</div>
<div class="paragraph">
<p><code>BeanPostProcessor</code> - позволяет настраивать бины до того, как они попадут в <strong>Spring</strong> контейнер. Данный интерфейс имеет два метода.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>postProcessBeforeInitialization(Object bean, String beanName)</code>;</p>
</li>
<li>
<p><code>postProcessAfterInitialization(Object bean, String beanName)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>BeanFactory</code> вызывает оба метода для каждого бина, и прогоняет бин через все <code>BeanPostProcessor</code>. У обоих методов параметры абсолютно одинаковые. Разница только в порядке их вызова. Первый вызывается до <strong>init</strong>-метода, второй, после.</p>
</div>
<div class="paragraph">
<p>Порядок в котором будут вызваны <strong>BeanPostProcessor</strong> не известен, но мы точно знаем что выполнены они будут последовательно.</p>
</div>
<div class="paragraph">
<p>Важно понимать, что на данном этапе экземпляр бина уже создан и идет его донастройка. Процесс донастройки показан на рисунке ниже.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/bean-post-processor.png" alt="bean post processor"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassBeanPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_схема_создания_бинов">3.1.5. Схема создания бинов</h4>
<div class="paragraph">
<p>Несмотря на кажущуюся сложность, жизненный цикл бинов крайне прост и лёгок для понимания. После создания экземпляра бина, могут понадобиться некоторые действия для того, чтобы сделать его работоспособным. Также при удалении бина из контейнера, необходима очистка.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/lifecycle-bean.png" alt="lifecycle bean"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Spring</strong> создает <strong>bean</strong>.</p>
</li>
<li>
<p><strong>Spring</strong> задает значения и ссылки в поля <strong>bean</strong>.</p>
</li>
<li>
<p>Если <strong>bean</strong> реализует <code>BeanNameAware</code>, <strong>Spring</strong> передает <strong>ID</strong> бина в метод <code>setBeanName()</code>.</p>
</li>
<li>
<p>Если <strong>bean</strong> реализует <code>BeanFactoryAware</code>, <strong>Spring</strong> вызывает <code>setBeanFactory()</code>, передавая туда <strong>bean</strong> <strong>factory</strong>.</p>
</li>
<li>
<p>Если <strong>bean</strong> реализует интерфейс <code>ApplicationContextAware</code>, <strong>Spring</strong> вызовет <code>setApplicationContext()</code>, передавая по ссылке контекст приложения.</p>
</li>
<li>
<p>Если <strong>bean</strong> реализует интерфейс <code>BeanPostProcessor</code>, <strong>Spring</strong> вызывает метод бина <code>postProcessBeforeInitialization()</code>.</p>
</li>
<li>
<p>На этом происходит вызов методов init().
Если <strong>bean</strong> реализуют интерфейс <code>InitializingBean</code>, <strong>Spring</strong> вызывает метод <code>afterPropertiesSet()</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachingMovieLister</span> <span class="o">{</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">populateMovieCache</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Если <strong>bean</strong> реализует <code>BeanPostProcessor</code>, <strong>Spring</strong> вызовет метод <strong>бина</strong> <code>postProcessAfterInitialization()</code>.</p>
</li>
<li>
<p>В этой точке, <strong>bean</strong> готов для использования приложением и останется в контексте приложения, пока контекст не будет уничтожен.</p>
</li>
<li>
<p>На этом происходит вызов методов destroy().
Если <strong>bean</strong> реализует интерфейс <code>DisposableBean</code>, <strong>Spring</strong> вызовет <code>destroy()</code> метод.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachingMovieLister</span> <span class="o">{</span>
    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearMovieCache</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Компонент перестает существовать.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ioc_di_autowired">3.1.6. IoC, DI, <code>@Autowired</code></h4>
<div class="paragraph">
<p>Как было описано выше, ядром <strong>Spring</strong> является контейнер <strong>Inversion of Control</strong>, функция которого создать и управлять объектами (бинами), а благодаря основной реализации <strong>Dependency Injection</strong> и связывать различные объекты между собой.</p>
</div>
<div class="paragraph">
<p>Связывать объекты между собой можно несколькими способами:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>С помощью конструктора</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieRecommender</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomerPreferenceDao</span> <span class="n">customerPreferenceDao</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">MovieRecommender</span><span class="o">(</span><span class="nc">CustomerPreferenceDao</span> <span class="n">customerPreferenceDao</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">customerPreferenceDao</span> <span class="o">=</span> <span class="n">customerPreferenceDao</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>С помощью метода (сеттер)</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleMovieLister</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">MovieFinder</span> <span class="n">movieFinder</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMovieFinder</span><span class="o">(</span><span class="nc">MovieFinder</span> <span class="n">movieFinder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">movieFinder</span> <span class="o">=</span> <span class="n">movieFinder</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Через поле</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieRecommender</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MovieCatalog</span> <span class="n">movieCatalog</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>По умолчанию внедрение зависимостей через методы или поля рассматриваются как обязательные зависимости. Однако, Вы можете изменить это поведение, устанавливая для <strong>required</strong> атрибута <code>@Autowired</code> значение <strong>false</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleMovieLister</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">MovieFinder</span> <span class="n">movieFinder</span><span class="o">;</span>

    <span class="nd">@Autowired</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMovieFinder</span><span class="o">(</span><span class="nc">MovieFinder</span> <span class="n">movieFinder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">movieFinder</span> <span class="o">=</span> <span class="n">movieFinder</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В ситуации, когда имеются два бина для внедрения можно воспользоваться следующими аннотациями:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Primary</code> - указывает, что текущий бин будет внедряться по умолчанию, если их несколько</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="nc">MovieCatalog</span> <span class="nf">firstMovieCatalog</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MovieCatalog</span> <span class="nf">secondMovieCatalog</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Qualifier</code> - указывает какой бин необходимо использовать для внедрения</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Component</span>
<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"Action"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActionMovieCatalog</span> <span class="kd">implements</span> <span class="nc">MovieCatalog</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieRecommender</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"Action"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">MovieCatalog</span> <span class="n">movieCatalog</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_component_service_и_другие_аннотации">3.1.7. <code>@Component</code>, <code>@Service</code> и другие аннотации</h4>
<div class="paragraph">
<p>В <strong>Spring</strong> используются следующие аннотации:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Component</code><br>
Аннотация для любого компонента фреймворка.</p>
</li>
<li>
<p><code>@Repository</code><br>
(Доменный слой) Аннотация показывает, что класс функционирует как репозиторий и требует наличия прозрачной трансляции исключений. Преимуществом трансляции исключений является то, что слой сервиса будет иметь дело с общей иерархией исключений от <strong>Spring</strong> (<code>DataAccessException</code>) вне зависимости от используемых технологий доступа к данным в слое данных.</p>
</li>
<li>
<p><code>@Service</code><br>
(Сервис-слой приложения) Аннотация, объявляющая, что этот класс представляет собой сервис – компонент сервис-слоя. Сервис является подтипом класса <code>@Component</code>. Использование данной аннотации позволит искать бины-сервисы автоматически.</p>
</li>
<li>
<p><code>@Controller</code><br>
(Слой представления) Аннотация для маркировки <strong>java</strong> класса, как класса контроллера. Данный класс представляет собой компонент, похожий на обычный сервлет (<strong>HttpServlet</strong>) (работающий с объектами <strong>HttpServletRequest</strong> и <strong>HttpServletResponse</strong>), но с расширенными возможностями от <strong>Spring</strong> <strong>Framework</strong>.</p>
</li>
<li>
<p><code>@RestController</code><br>
Аннотация аккумулирует поведение двух аннотаций <code>@Controller</code> и <code>@ResponseBody</code> (показывает что данный метод может возвращать собственный объект в виде <strong>xml</strong>, <strong>json</strong> и другие).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/core/annotation.jpg" alt="annotation"></span></p>
</div>
<div class="paragraph">
<p>Данные аннотации используются при конфигурации приложения через аннотации.</p>
</div>
<div class="paragraph">
<p>Основной считается <code>@Component</code>, общий стереотип для любого компонента, управляемого <strong>Spring</strong>. <code>@Repository</code>, <code>@Service</code> И <code>@Controller</code> являются специализациями <code>@Component</code> для более конкретных случаев применения (в настойчивости, обслуживании и презентации слоев, соответственно).</p>
</div>
<div class="paragraph">
<p>Бины, получившиеся при помощи <code>@Repository</code>, дополнительно имеют обработку для <strong>JDBC</strong> <strong>Exception</strong>.</p>
</div>
<div class="paragraph">
<p><code>@RestController = @Controller + @ResponseBody</code>. Этот бин для конвертации входящих/исходящих данных использует <strong>Jackson message converter</strong>. Как правило, целевые данные представлены в <strong>json</strong> или <strong>xml</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_links">3.1.8. Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/">Spring Framework Documentation</a></p>
</li>
<li>
<p><a href="https://proselyte.net/tutorials/spring-tutorial-full-version">Руководство по Spring</a></p>
</li>
<li>
<p><a href="https://www.tutorialspoint.com/spring/">Spring Tutorial</a></p>
</li>
<li>
<p><a href="https://javarush.ru/groups/posts/spring-framework-java-1">Spring для ленивых. Основы, базовые концепции и примеры с кодом. Часть 1</a></p>
</li>
<li>
<p><a href="https://javarush.ru/groups/posts/477-spring-dlja-lenivihkh-osnovih-bazovihe-koncepcii-i-primerih-s-kodom-chastjh-2">Spring для ленивых. Основы, базовые концепции и примеры с кодом. Часть 2</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/222579/">Spring изнутри. Этапы инициализации контекста</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/350682/">Spring: вопросы к собеседованию</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=BmBr5diz8WA&amp;ab_channel=JUG.ru">YouTube: Евгений Борисов — Spring-потрошитель, часть 1</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=cou_qomYLNU&amp;t=3443s&amp;ab_channel=JUG.ru">YouTube: Евгений Борисов — Spring-потрошитель, часть 2</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLxqzxxW1gWwIuSgG8od6N4LZg5V4kKp72">YouTube: Spring Framework для начинающих [Jetbulb</a>]</p>
</li>
<li>
<p><a href="https://www.youtube.com/playlist?list=PLAma_mKffTOR5o0WNHnY0mTjKxnCgSXrZ">YouTube: Spring Framework [alishev</a>]</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=yRr_vzqha-g&amp;ab_channel=AndreiLegan">YouTube: Spring изнутри. Этапы инициализации контекста</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=l20USjGgnTo&amp;t=3881s&amp;ab_channel=Jetbulb">YouTube: Java Spring Контекст</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_mvc">3.2. Spring MVC</h3>
<div class="paragraph">
<p><strong>Spring MVC</strong> – это фреймворк для создания <strong>web</strong>-приложений на <strong>Java</strong>, в основе которого лежит шаблон проектирования <strong>MVC</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Spring MVC</strong> — это старый добрый <strong>MVC</strong>-фреймворк, который позволяет довольно легко писать <strong>web</strong>-сайты или <strong>web</strong>-сервисы.</p>
</li>
<li>
<p>Он прекрасно интегрируется со множеством шаблонных библиотек и библиотек преобразования данных, а также с остальной частью экосистемы <strong>Spring</strong>, такой, как <strong>Spring Boot</strong>.</p>
</li>
<li>
<p>Главным образом он позволяет вам сосредоточиться на написании своей бизнес-логики, не беспокоясь о стандартном коде для Servlet, разборе <strong>HTTP</strong>-запросов/ответов и преобразовании данных.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Паттерн <strong>MVC</strong> разделяет аспекты приложения (логику ввода, бизнес-логику и логику <strong>UI</strong>), обеспечивая при этом свободную связь между ними.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Model</strong> (<strong>Модель</strong>) инкапсулирует (объединяет) данные приложения, в целом они будут состоять из <strong>POJO</strong>.</p>
</li>
<li>
<p><strong>View</strong> (<strong>Отображение</strong>, <strong>Вид</strong>) отвечает за отображение данных <strong>Модели</strong>, — как правило, генерируя <strong>HTML</strong>, которые мы видим в своём браузере.</p>
</li>
<li>
<p><strong>Controller</strong> (<strong>Контроллер</strong>) обрабатывает запрос пользователя, создаёт соответствующую <strong>Модель</strong> и передаёт её для отображения в <strong>Вид</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рабочий процесс обработки запроса проиллюстрирован на следующей диаграмме:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/mvc/schema-working-dispatcher-servlet.png" alt="schema working dispatcher servlet"></span></p>
</div>
<div class="paragraph">
<p>После получения <strong>HTTP</strong>-запроса <strong>DispatcherServlet</strong>  выполняет следующие действия.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>После получения <strong>HTTP</strong>-запроса <strong>DispatcherServlet</strong> даёт указание объекту <strong>HandlerMapping</strong> (<strong>обработка связывания</strong>), который вызывает следующий объект.</p>
</li>
<li>
<p><strong>DispatcherServlet</strong> посылает запрос контроллеру и вызывает соответствующие методы. Эти методы возвращают объект, в соответствии с бизнес-логикой метода и передают название ссылки обратно в <strong>DispatcherServlet</strong>.</p>
</li>
<li>
<p>C помощью <strong>ViewResolver</strong>, <strong>DispatcherServlet</strong> подбирает необходимый вид для запроса.</p>
</li>
<li>
<p>Когда внешний вид сформирован, <strong>DispatcherServlet</strong> передаёт эти данные в модуль <strong>View</strong>, который обрабатывается браузером пользователя.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_dispatcherservlet">3.2.1. <code>DispatcherServlet</code></h4>
<div class="paragraph">
<p>Вся логика работы <strong>Spring MVC</strong> построена вокруг <code>DispatcherServlet</code>.</p>
</div>
<div class="paragraph">
<p><code>DispatcherServlet</code> — полностью интегрированный Servlet в <strong>Spring IoC</strong> контейнер и таким образом получает доступ ко всем возможностям <strong>Spring</strong>.</p>
</div>
<div class="paragraph">
<p>При обработке запросов используется паттерн <strong>pattern-savvy reader</strong>, который распознает <code>DispatcherServlet</code> как выражение из шаблона проектирования <strong>Front Controller</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/mvc/front-contreoller.png" alt="front contreoller"></span></p>
</div>
<div class="paragraph">
<p><code>DispatcherServlet</code> является основным контроллером <strong>Spring MVC Application</strong>. Все входящие веб-запросы проходят через <code>DispatcherServlet</code> перед обработкой отдельными контроллерами <strong>Spring</strong>, то есть классами, аннотированными с помощью аннотации <code>@Controller</code>.</p>
</div>
<div class="paragraph">
<p><code>DispatcherServlet</code> — это обычный Servlet (наследуется от базового класса <code>HttpServlet</code>). Как и любой другой Servlet, <code>DispatcherServlet</code> необходимо зарегистрировать и настроить. Сделать это можно или в файле <code>web.xml</code></p>
</div>
<div class="listingblock">
<div class="title"><code>web.xml</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;web-app&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>SpringMVC<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>SpringMVC<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Либо в <strong>Java</strong>-коде переопределив метод <code>onStartup()</code> интерфейса <code>WebApplicationInitializer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebInitializer</span> <span class="kd">implements</span> <span class="nc">WebApplicationInitializer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">AnnotationConfigWebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigWebApplicationContext</span><span class="o">();</span>
        <span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">WebConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">DispatcherServlet</span> <span class="n">servlet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DispatcherServlet</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span><span class="s">"dispatcher"</span><span class="o">,</span> <span class="n">servlet</span><span class="o">);</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>WebApplicationInitializer</code> — интерфейс, предоставляемый <strong>Spring MVC</strong>, который гарантирует инициализацию при старте контейнера.</p>
</div>
<div class="paragraph">
<p>Servlet диспетчера настроен как <code>load-on-startup = 1</code>, что означает, что этот Servlet должен создаваться контейнером Servlets при развертывании приложения, а не при получении запроса на этот запрос.</p>
</div>
</div>
<div class="sect3">
<h4 id="_handlermapping">3.2.2. <code>HandlerMapping</code></h4>
<div class="paragraph">
<p>Одним из важных интерфейсов в Spring является <code>HandlerMapping</code>.</p>
</div>
<div class="paragraph">
<p><code>DispatcherServlet</code> с помощью <code>HandlerMapping</code> определяет какой контроллер он должен использовать для определенного <strong>request</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/mvc/schema-spring-mvc-detail.png" alt="schema spring mvc detail"></span></p>
</div>
<div class="paragraph">
<p>По определению <code>HandlerMapping</code> — интерфейс реализующийся объектами, которые определяют отображение между запросами и объектами обработчиков.</p>
</div>
<div class="paragraph">
<p>Реализации <code>HandlerMapping</code> могут поддерживать перехватчики (<strong>interceptors</strong>), но не содержат их. Обработчик будет всегда обернут в экземпляре <code>HandlerExecutionChain</code>, возможно в сопровождении некоторых экземпляров <code>HandlerInterceptor</code>. <code>DispatcherServlet</code> сначала вызывает  метод <code>preHandle()</code> каждого <code>HandlerInterceptor</code> в заданном порядке, и в конце, внедряет обработчик, если все методы <code>preHandle()</code> вернули <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Возможность параметризации такого отображения является мощной и необычной способностью в рамках <strong>MVC</strong> фреймворка. Например, можно написать пользовательское отображение на основе состояния <strong>session</strong>, состояние <strong>cookie</strong> или многих других переменных.</p>
</div>
<div class="paragraph">
<p>По умолчанию интерфейс <code>HandlerMapping</code> в <strong>Spring MVC</strong> реализуется классом <code>RequestMappingHandlerMapping</code>. Существуют другие реализации интерфейса, которые используют другие параметры для поиска контроллера, соответствующего запросу. В <strong>Spring MVC</strong> вы можете встретить реализацию интерфейса, когда применяете аннотацию <code>@RequestMapping</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ModelAndView</span> <span class="n">modelAndView</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelAndView</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">modelAndView</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controller">3.2.3. <code>Controller</code></h4>
<div class="paragraph">
<p><code>DispatcherServlet</code> отправляет запрос контроллерам для выполнения определённых функций.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/mvc/request-lifecycle.png" alt="Request Lifecycle"></span></p>
</div>
<div class="paragraph">
<p>Аннотации <code>@Controller</code> или <code>@RestController</code> указывают, что конкретный класс является контроллером. Аннотация <code>@RestController</code> равна одновременно <code>@Controller</code> + <code>@ResponseBody</code>.</p>
</div>
<div class="paragraph">
<p><code>@ResponseBody</code> - дает фреймворку понять, что объект, который вы вернули из метода надо прогнать через <code>HttpMessageConverter</code>, чтобы получить готовое представление к отправке клиенту.</p>
</div>
<div class="paragraph">
<p>Аннотация <code>@RequestMapping</code> используется для <strong>mapping</strong> (<strong>связывания</strong>) с <strong>URL</strong> для всего класса или для конкретного метода обработчика.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
   <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
   <span class="kd">public</span> <span class="nc">String</span> <span class="nf">printHello</span><span class="o">(</span><span class="nc">ModelMap</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"Hello Spring MVC Framework!"</span><span class="o">);</span>
      <span class="k">return</span> <span class="s">"hello"</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В первом случае, <code>@RequestMapping</code> указывает, что все методы в данном <strong>Controller</strong> относятся к <strong>URL</strong>-адресу <code>/hello</code>, а во втором как дефолтного метода для обработки <strong>HTTP</strong>-запросов <strong>GET</strong> (в данном <strong>Controller</strong>). Также можно данную аннотацию объявить над методом <code>@RequestMapping(value = "/hello", method = RequestMethod.GET)</code>.</p>
</div>
<div class="paragraph">
<p>Также в контроллере может использоваться аннотация <code>@ModelAttribute</code>, которая ставится над методом или в аргументах методов.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/processForm"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">processForm</span><span class="o">(</span><span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">"student"</span><span class="o">)</span> <span class="nc">Student</span> <span class="n">theStudent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"theStudent :"</span><span class="o">+</span> <span class="n">theStudent</span><span class="o">.</span><span class="na">getLastName</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"form-details"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">"object"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">checkOptions</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Object</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">"processForm"</span> <span class="na">modelAttribute=</span><span class="s">"student"</span><span class="nt">&gt;</span>
    First Name : <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">"firstName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;&lt;br&gt;</span>
    Last Name : <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">"lastName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;br&gt;&lt;br&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"submit"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/form:form&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В зависимости от места ее применения, работать она будет по-разному. В первом случае она позволяет связать <strong>html</strong>-форму с <strong>java</strong>-объектом. А во втором случае, добавит в модель каждого метода контроллера объект с ключ-значением - <code>object</code> и <code>new Object()</code>.</p>
</div>
<div class="sect4">
<h5 id="_requestparam_и_pathvariable"><code>@RequestParam</code> и <code>@PathVariable</code></h5>
<div class="paragraph">
<p>Часто используются аннотации <code>@RequestParam</code> и <code>@PathVariable</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"api/test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/filter"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Test</span> <span class="nf">getByFilter</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"text"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">testService</span><span class="o">.</span><span class="na">getByFilter</span><span class="o">(</span><span class="n">filterTest</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"/{id}"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">Test</span> <span class="nf">findById</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">testService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>При использовании <code>@RequestParam</code> передача значений будет в виде <code><a href="http://localhost:8080/api/test/filter?id=abc" class="bare">http://localhost:8080/api/test/filter?id=abc</a></code>. В этом случае данный параметр является не обязательным, но при установке атрибута <code>required = true</code> (по умолчанию <code>false</code>) станет обязательным для заполнения.</p>
</div>
<div class="paragraph">
<p>При использовании <code>@PathVariable</code> передача значений будет в виде <code><a href="http://localhost:8080/api/test/abc" class="bare">http://localhost:8080/api/test/abc</a></code>. В этом случае данный параметр является обязательным, но при установке атрибута <code>required = false</code> (по умолчанию <code>true</code>) станет не обязательным для заполнения.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_viewresolver">3.2.4. <code>ViewResolver</code></h4>
<div class="paragraph">
<p><code>DispatcherServlet</code> с помощью <code>ViewResolver</code> определяет какое представление необходимо использовать на основании полученного имени.</p>
</div>
<div class="paragraph">
<p><code>ViewResolver</code> — интерфейс, реализуемый объектами, которые способны находить представления <strong>View</strong> по имени <strong>View Name</strong></p>
</div>
<div class="paragraph">
<p><strong>Spring MVC</strong> поддерживает множество типов <strong>View</strong> для различных технологий отображения страницы. В том числе — <strong>JSP</strong>, <strong>HTML</strong>, <strong>PDF</strong>, <strong>Excel</strong>, <strong>XML</strong>, <strong>Velocity</strong> <strong>templates</strong>, <strong>XSLT</strong>, <strong>JSON</strong>, каналы <strong>Atom</strong> и <strong>RSS</strong>, <strong>JasperReports</strong> и другие.</p>
</div>
<div class="paragraph">
<p>По умолчанию реализацией интерфейса <code>ViewResolver</code> является класс <code>InternalResourceViewResolver</code>. Также могут использоваться <code>FreeMarkerViewResolver</code>, <code>BeanNameViewResolver</code>, <code>ResourceBundleViewResolver</code>, <code>TilesViewResolver</code> и многие другие.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">InternalResourceViewResolver</span> <span class="nf">internalResourceViewResolver</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">InternalResourceViewResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InternalResourceViewResolver</span><span class="o">();</span>
        <span class="n">resolver</span><span class="o">.</span><span class="na">setPrefix</span><span class="o">(</span><span class="s">"/WEB-INF/views/"</span><span class="o">);</span>
        <span class="n">resolver</span><span class="o">.</span><span class="na">setSuffix</span><span class="o">(</span><span class="s">".jsp"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">resolver</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/spring/mvc/prefix-suffix.png" alt="prefix suffix"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span><span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ModelAndView</span> <span class="n">modelAndView</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelAndView</span><span class="o">();</span>
        <span class="n">modelAndView</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="s">"userJSP"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">User</span><span class="o">());</span>
        <span class="n">modelAndView</span><span class="o">.</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"index"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">modelAndView</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>После того как в модель <code>modelAndView</code> было записано имя представления <code>"index"</code> и произошел выход из метода, то в действие включается <strong>ViewResolver</strong>. Для этого примера согласно настройкам в класс <code>InternalResourceViewResolver</code> будет искать представление с именем <code>index</code>, у которого префикс <code>/WEB-INF/views/</code>, а суффикс <code>.jsp</code>. Другими словами он должен найти представление с именем <code>/WEB-INF/views/index.jsp</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">""</span><span class="nt">&gt;</span>
   <span class="nt">&lt;head&gt;</span>
      <span class="nt">&lt;title&gt;</span>Hello Spring MVC<span class="nt">&lt;/title&gt;</span>
   <span class="nt">&lt;/head&gt;</span>

   <span class="nt">&lt;body&gt;</span>
      <span class="nt">&lt;h2&gt;</span>${userJSP}<span class="nt">&lt;/h2&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В данном случае, переменная <code>${userJSP}</code> выводит тот самый атрибут, установленный в <strong>Controller</strong>. Внутри <strong>View</strong> можно отобразить любое количество атрибутов.</p>
</div>
<div class="paragraph">
<p>Если представление найдено, то произойдет переход на эту страницу. В противном случае результат зависит от настроек реализации интерфейса <code>ViewResolver</code>. По умолчанию возвращается <code>null</code>, но можно возвращать имя или исключение, если вам это необходимо.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exceptionhandler">3.2.5. <code>ExceptionHandler</code></h4>
<div class="paragraph">
<p>Для обработки ошибки существует три варианта обработки:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>для каждого контроллера</p>
</li>
<li>
<p>для каждого исключения</p>
</li>
<li>
<p>глобально</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_уровень_контроллера">Уровень контроллера</h5>
<div class="paragraph">
<p>Изначально основными способами обработки исключений в приложении были <code>HandlerExceptionResolver</code> и аннотация <code>@ExceptionHandler</code>, которая позволяла обрабатывать исключения на уровне отдельного контроллера. Для этого достаточно было объявить метод, в котором будет содержаться вся логика обработки нужного исключения, и проаннотировать его.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/testExceptionHandler"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="no">APPLICATION_JSON_VALUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">testExceptionHandler</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BusinessException</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="s">"BusinessException in testExceptionHandler"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">BusinessException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">handleException</span><span class="o">(</span><span class="nc">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Метод <code>handleException()</code> предназначен для обработки ошибок. У него есть аннотация <code>@ExceptionHandler(BusinessException.class)</code>, которая говорит о том, что для последующей обработки будут перехвачены все исключения типа <code>BusinessException</code>. В аннотации <code>@ExceptionHandler</code> можно прописать сразу несколько типов исключений, например так: <code>@ExceptionHandler({BusinessException.class, ServiceException.class})</code>.</p>
</div>
<div class="paragraph">
<p>Основной недостаток <code>@ExceptionHandler</code> в том что он определяется для каждого контроллера отдельно, а не глобально для всего приложения.</p>
</div>
<div class="paragraph">
<p>Также, на уровне контроллера можно формировать ответ путём выброса исключения <code>ResponseStatusException</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/testResponseStatusException"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="no">APPLICATION_JSON_VALUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">testResponseStatusException</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResponseStatusException</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="s">"ResponseStatusException in testResponseStatusException"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Выбрасывая <code>ResponseStatusException</code> можно также возвращать пользователю определённый код статуса, в зависимости от того, что произошло в логике приложения. При этом не нужно создавать собственное исключение и прописывать аннотацию <code>@ResponseStatus</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_уровень_исключений">Уровень исключений</h5>
<div class="paragraph">
<p>Для обработки ошибок на уровне исключений используется <code>ResponseStatusExceptionResolver</code>. Он позволяет настроить код ответа для любого исключения с помощью аннотации <code>@ResponseStatus</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceException</span> <span class="kd">extends</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">ServiceException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/testResponseStatusExceptionResolver"</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="no">APPLICATION_JSON_VALUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">testResponseStatusExceptionResolver</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServiceException</span><span class="o">(</span><span class="s">"ServiceException in testResponseStatusExceptionResolver"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Из недостатков такого подхода — как и в предыдущем случае отсутствует тело ответа.</p>
</div>
</div>
<div class="sect4">
<h5 id="_уровень_глобальной_обработки">Уровень глобальной обработки</h5>
<div class="paragraph">
<p>Глобально и централизованно обрабатывать исключения с помощью классов с аннотацией <code>@ControllerAdvice</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultAdvice</span> <span class="o">{</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">BusinessException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&gt;</span> <span class="nf">handleException</span><span class="o">(</span><span class="nc">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">ResponseEntity</span><span class="o">&lt;&gt;(</span><span class="n">response</span><span class="o">,</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Любой класс с аннотацией <code>@ControllerAdvice</code> является глобальным обработчиком исключений, который очень гибко настраивается. Метод <code>handleException()</code> имеет аннотацию <code>@ExceptionHandler</code>, в которой можно определить список обрабатываемых исключений.</p>
</div>
<div class="paragraph">
<p>Так же можно в рамках <code>@ControllerAdvice</code> сделать сразу несколько методов с аннотациями <code>@ExceptionHandler</code> для обработки разных исключений.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_links_2">3.2.6. Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/mvc.html">Web MVC framework</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/336816/">Spring MVC — основные принципы</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/500572/">Spring MVC: создание веб-сайтов и RESTful сервисов</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/528116/">Обработка исключений в контроллерах Spring</a></p>
</li>
<li>
<p><a href="https://javastudy.ru/spring-mvc/spring-mvc-basic/">Spring MVC — основные понятия, архитектура</a></p>
</li>
<li>
<p><a href="https://javastudy.ru/spring-mvc/spring-mvc-webapplicationcontext/">Spring MVC — WebApplicationContext. Описание интерфейса</a></p>
</li>
<li>
<p><a href="https://javastudy.ru/spring-mvc/spring-mvc-handler-mapping/">Spring MVC — Handler Mapping. Описание интерфейса HandlerMapping</a></p>
</li>
<li>
<p><a href="https://javastudy.ru/spring-mvc/spring-mvc-viewresolver/">Spring MVC — описание интерфейса ViewResolver</a></p>
</li>
<li>
<p><a href="https://proselyte.net/tutorials/spring-tutorial-full-version/spring-mvc-framework/">Руководство по Spring. Spring MVC Framework (основы)</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=1vyf-_5OkW8&amp;list=PLAma_mKffTOR5o0WNHnY0mTjKxnCgSXrZ&amp;index=14&amp;t=1s&amp;ab_channel=alishev">YouTube: Spring Framework. Урок 14: Spring MVC. Теория.</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=JHTqKQgrVKE&amp;list=PLAma_mKffTOR5o0WNHnY0mTjKxnCgSXrZ&amp;index=18&amp;ab_channel=alishev">YouTube: Spring Framework. Урок 17: Контроллеры. Аннотация @Controller.</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=w1FjeTZxQrQ&amp;ab_channel=alishev">YouTube: Spring Framework. Урок 22: Аннотация @ModelAttribute. HTML Формы (Thymeleaf).</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jakarta_servlet">4. Jakarta Servlet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Moved to <a href="https://github.com/rakovets/wiki" class="bare">https://github.com/rakovets/wiki</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_tools">5. Java Tools</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_testing_junit">5.1. Testing: JUnit</h3>
<div class="sect3">
<h4 id="_введение">5.1.1. Введение</h4>
<div class="paragraph">
<p><strong>Тестирование</strong> – это процесс проверки функционала программы с целью подтверждения того, что она работает в соответствии с определёнными требованиями. <strong>Unit-тестирование</strong> – это тестирование с помощью тестов, которые пишутся, непосредственно, на уровне разработчика (тестирование определённой сущности – метод или класс). Это крайне важный этап разработки ПО, который помогает создавать качественный продукт.</p>
</div>
<div class="paragraph">
<p><strong>Unit-тестирование</strong> делится на две большие группы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ручное тестирование</p>
</li>
<li>
<p>Автоматизированное тестирование</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Ручное тестирование</th>
<th class="tableblock halign-left valign-top">Автоматизированное тестирование</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ручное выполнение тестов без помощи каких-либо средств.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Использование специальных средств для автоматизированного тестирования</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Не программируется</strong><br>
Нет возможности для написания сложных тестов для тестирования сложных моделей поведения.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Программируется</strong><br>
Тестировщики могут написать сложные тесты для тестирования сложных моделей программирования</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Низкая надёжность</strong><br>
Ручное тестирование имеет низкую надёжность, так как крайне подвержено влиянию человеческого фактора.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Высокая надёжность</strong><br>
Автоматизированное тестирование точное и надёжное.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Большие затраты времени</strong><br>
Связано с тем, что человек имеет крайне ограниченные возможность в скорости работы.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Быстро</strong><br>
Автоматизированные тесты выполняются на порядок быстрее, чем это может сделать человек.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_junit">5.1.2. JUnit</h4>
<div class="paragraph">
<p><strong>JUnit</strong> – это фреймворк, разработанный для тестирования программ, написанных с использованием технологии <strong>Java</strong>. Он лежит в основе <strong>TDD</strong> (<strong>Test-Driven Development</strong>) и входит в семейство фреймворков для тестирования <strong>xUnit</strong>.</p>
</div>
<div class="paragraph">
<p>Главная идея <strong>Test-Driven Development</strong> – <em>сначала тесты, потом код</em>. Это означает, что сначала определяется, что должно получиться в результате работы того или иного куска кода и пишем тесты. Тесты проверяют идентичность результата с требуемым, после чего пишем сам кусок кода, который и будет тестироваться. Данный подход увеличивает эффективность работы разработчика и позволяет писать более стабильный код. В результате этого получается меньшее количество времени, которое затрачивается на отладку программы.</p>
</div>
<div class="sect4">
<h5 id="_свойства_junit">Свойства JUnit</h5>
<div class="ulist">
<ul>
<li>
<p>Фреймворк с открытым исходным кодом, который используется для написания и выполнения тестов.</p>
</li>
<li>
<p>Позволяет писать код более быстро и качественно.</p>
</li>
<li>
<p>Крайне прост в использовании.</p>
</li>
<li>
<p>Поддерживает аннотации для идентификации методов.</p>
</li>
<li>
<p>Поддерживает утверждения для тестирования получаемых результатов.</p>
</li>
<li>
<p>Тесты могут быть организованы в <strong>test suites</strong> (<strong>связки тестов</strong>).</p>
</li>
<li>
<p>Имеет визуальную индикацию состояния тестов (красные – не пройдены, зелёные – пройдены).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_тестовый_случай">5.1.3. Тестовый случай</h4>
<div class="paragraph">
<p><strong>Test Case</strong> (<strong>Тестовый случай</strong>) в <strong>unit-тестировании</strong> – это часть кода, которая проверяет, что другая часть кода, например метод, работает в соответствии с определёнными требованиями.</p>
</div>
<div class="paragraph">
<p>Формально описанный <strong>test case</strong> характеризуется известными входными данными и ожидаемым выводом программы, который известен до начала выполнения теста.</p>
</div>
<div class="paragraph">
<p>Необходимо создавать, как минимум, два <strong>test cases</strong> для каждого требования – положительный и отрицательный. Если требование имеет под-требования, каждое из них должно тестироваться отдельно.</p>
</div>
</div>
<div class="sect3">
<h4 id="_junit_5">5.1.4. JUnit 5</h4>
<div class="paragraph">
<p><strong>JUnit 5</strong> требует <strong>Java 8</strong> (или выше) для запуска. Однако все равно можно протестировать код, скомпилированный с предыдущими версиями <strong>JDK</strong>.</p>
</div>
<div class="paragraph">
<p>В отличие от предыдущих версий <strong>JUnit</strong>, <strong>JUnit 5</strong> состоит из нескольких разных модулей из трех разных подпроектов.</p>
</div>
<div class="paragraph">
<p><strong>JUnit 5</strong> = <strong>Platform JUnit</strong> + <strong>JUnit Jupiter</strong> + <strong>JUnit Vintage</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Platform JUnit</strong><br>
Служит основой для запуска тестирования на <strong>JVM</strong>. Он также определяет <strong>Test Engine API</strong> для разработки инфраструктуры тестирования, работающей на платформе. Кроме того, платформа предоставляет инструменты для запуска тестов с помощью CLI и инструменты для запуска на основе <strong>JUnit 4</strong> для запуска любого <strong>Test Engine</strong>. Первоклассная поддержка  <strong>Platform JUnit</strong> также существует в популярных <strong>IDE</strong> (см. <strong>IntelliJ IDEA</strong>, <strong>Eclipse</strong>, <strong>NetBeans</strong> и <strong>Visual Studio Code</strong>) и инструментах сборки (см. <strong>Gradle</strong>, <strong>Maven</strong> и <strong>Ant</strong>).</p>
</li>
<li>
<p><strong>JUnit Jupiter</strong><br>
Является сочетанием новой модели программирования и модели расширения для написания тестов и расширений в <strong>JUnit 5</strong>. <strong>JUnit Jupiter</strong>  обеспечивает <strong>Test Engine</strong> для выполнения тестов на основе <strong>Jupiter</strong> на <strong>Platform JUnit</strong>.</p>
</li>
<li>
<p><strong>JUnit Vintage</strong><br>
Обеспечивает <strong>Test Engine</strong> запуск тестов на основе <strong>JUnit 3</strong> и <strong>JUnit 4</strong> на <strong>Platform JUnit</strong>.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_аннотации">Аннотации</h5>
<div class="paragraph">
<p><strong>JUnit Jupiter</strong> поддерживает следующие аннотации для настройки тестов и расширения фреймворка.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Аннотация</th>
<th class="tableblock halign-left valign-top">Свойство</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Test</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что метод является методом тестирования. В отличие от аннотации <strong>JUnit 4</strong>, эта аннотация не объявляет никаких атрибутов, так как тестовые расширения в JUnit Jupiter работают на основе собственных специальных аннотаций. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ParameterizedTest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что метод является параметризованным тестом. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@RepeatedTest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что метод является тестовым шаблоном для повторного теста. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TestFactory</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что метод является испытательным заводом для динамических тестов. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TestTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что метод является шаблоном для тестовых случаев, предназначенных для вызова несколько раз в зависимости от количества контекстов вызова, возвращенных зарегистрированными поставщиками. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TestMethodOrder</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для настройки порядка выполнения тестового метода для аннотированного тестового класса; похож на <strong>JUnit 4&#8217;s</strong>. Такие аннотации наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TestInstance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для настройки жизненного цикла экземпляра теста для аннотированного тестового класса. Такие аннотации наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DisplayName</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Объявляет пользовательское имя дисплея для тестового класса или метода тестирования. Такие аннотации не наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@DisplayNameGeneration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Объявляет пользовательский генератор имен отображения для тестового класса. Такие аннотации наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeEach</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что аннотированный метод должен быть выполнен перед каждым, или методом в текущем классе; по аналогии с <strong>JUnit 4&#8217;s</strong>. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AfterEach</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что аннотированный метод должен быть выполнен после каждого, или метода в текущем классе; по аналогии с <strong>JUnit 4&#8217;s</strong>. Такие методы наследуются, если они не переопределены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeAll</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что аннотированный метод должен быть выполнен прежде всего, и методы в текущем классе; по аналогии с <strong>JUnit 4&#8217;s</strong>. Такие методы наследуются (если они не скрыты или переопределены)и должны быть (если не используется жизненный цикл "в каждом классе" экземпляра теста).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AfterAll</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что аннотированный метод должен быть выполнен в конце концов, и методы в текущем классе; по аналогии с <strong>JUnit 4&#8217;s</strong>. Такие методы наследуются (если они не скрыты или переопределены)и должны быть (если не используется жизненный цикл "в каждом классе" экземпляра теста).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Nested</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Означает, что аннотированный класс является не статичным вложенным тестовым классом и методы не могут быть использованы непосредственно в тестовом классе, если не используется жизненный цикл экземпляра теста "на класс". Такие аннотации не наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Tag</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для объявления тегов для фильтрации тестов, либо на уровне класса или метода; аналогично тестовым группам в <strong>TestNG</strong> или <strong>Categories</strong> в <strong>JUnit 4.</strong> Такие аннотации наследуются на уровне класса, но не на уровне метода.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Disabled</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для отключения тестового класса или метода тестирования; по аналогии с <strong>JUnit 4&#8217;s</strong>. Такие аннотации не наследуются.@Ignore</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для неудачи теста, испытательного завода, шаблона тестирования или метода жизненного цикла, если его выполнение превышает данный срок. Такие аннотации наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ExtendWith</code> (<strong>JUnit5</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для регистрации расширений декларативно. Такие аннотации наследуются.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@RegisterExtension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для регистрации расширений программно через поля. Такие поля наследуются, если они не затенены.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@TempDir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Используется для поставки временного каталога с помощью инъекций поля или инъекций параметра в метод жизненного цикла или метод тестирования; расположен в пакете <code>org.junit.jupiter.api.io</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Все основные аннотации находятся в <a href="https://junit-org.translate.goog/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/package-summary.html?_x_tr_sl=en&amp;_x_tr_tl=ru&amp;_x_tr_hl=ru&amp;_x_tr_pto=ajax,elem,se"><strong>org.junit.jupiter.api</strong></a> пакете в <strong>junit-jupiter-api</strong> модуле.</p>
</div>
</div>
<div class="sect4">
<h5 id="_assertions">Assertions</h5>
<div class="paragraph">
<p><strong>JUnit 5</strong> поставляется со многими стандартными <strong>Assertions</strong> (<strong>утверждениями</strong>), т.е. методами, которые проверяют результат работы кода на соответствие ожидаемому результату. Их можно найти в классе <a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/Assertions.html"><code>org.junit.jupiter.api.Assertions</code></a></p>
</div>
<div class="paragraph">
<p>Основные assertions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>assertEquals()</code>,</p>
</li>
<li>
<p><code>assertArrayEquals()</code>,</p>
</li>
<li>
<p><code>assertSame()</code>,</p>
</li>
<li>
<p><code>assertNotSame()</code>,</p>
</li>
<li>
<p><code>assertTrue()</code>,</p>
</li>
<li>
<p><code>assertFalse()</code>,</p>
</li>
<li>
<p><code>assertNull()</code>,</p>
</li>
<li>
<p><code>assertNotNull()</code>,</p>
</li>
<li>
<p><code>assertLinesMatch()</code>,</p>
</li>
<li>
<p><code>assertIterablesMatch()</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_mockito">5.2. Testing: Mockito</h3>
<div class="sect3">
<h4 id="_mockito_что_это_такое_и_зачем_нужно">5.2.1. Mockito: что это такое и зачем нужно</h4>
<div class="paragraph">
<p>Говоря коротко, <strong>Mockito</strong> – фреймворк для работы с заглушками.</p>
</div>
<div class="paragraph">
<p>Как известно, при <strong>тестировании кода</strong> (прежде всего <strong>юнит-тестировании</strong>, но не только) тестируемому элементу часто требуется предоставить экземпляры классов, которыми он должен пользоваться при работе.
При этом часто они не должны быть <strong>полнофункциональными</strong> – наоборот, от них требуется вести себя <strong>жёстко заданным образом</strong>, так, чтобы их поведение было <strong>простым и полностью предсказуемым</strong>.
Они и называются <strong>заглушками</strong> (<strong>stub</strong>).
Чтобы их получить, можно создавать альтернативные тестовые реализации интерфейсов, наследовать нужные классы с переопределением функционала и так далее, но всё это достаточно неудобно, избыточно и чревато ошибками.
Более удобное во всех смыслах решение – <strong>специализированные фреймворки</strong> для создания заглушек.
Одним из таковых (и, пожалуй, самым известным для <strong>Java</strong>) и является <strong>Mockito</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Mockito</strong> позволяет создать одной строчкой кода так называемый <strong>mock</strong> (что-то вроде основы для нужной заглушки) любого класса.
Для такого <strong>mock</strong> сразу после создания характерно некое поведение по умолчанию (<strong>все методы возвращают заранее известные значения</strong> — обычно это <strong>null</strong> либо <strong>0</strong>).
Можно переопределить это поведение желаемым образом, проконтролировать с нужной степенью детальности обращения к ним так далее.
В результате <strong>mock</strong> и становится заглушкой с требуемыми свойствами.</p>
</div>
<div class="paragraph">
<p>Также <strong>mock</strong> можно создать и для тех классов, новый экземпляр которых вообще-то так просто не создашь, в частности, классов с исключительно приватными конструкторами типа <strong>синглтонов</strong> и <strong>утилитных классов</strong>, а при минимальной настройке фреймворка — и перечислений (<strong>enums</strong>).</p>
</div>
<div class="paragraph">
<p>Наибольшее распространение получили следующие возможности <strong>Mockito</strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>создание заглушек для классов и интерфейсов;</p>
</li>
<li>
<p>проверка вызова метода и значений передаваемых методу параметров;</p>
</li>
<li>
<p>использование концепции «частичной заглушки», при которой заглушка создается на класс с определением поведения, требуемое для некоторых методов класса;</p>
</li>
<li>
<p>подключение к реальному классу «шпиона» spy для контроля вызова методов.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_mock_и_spy">5.2.2. Mock и Spy</h4>
<div class="paragraph">
<p>Центральный класс <strong>Mockito</strong>, через который предполагается обращаться к большей части функционала, — это, собственно, класс под названием <strong>Mockito</strong> (есть также класс <strong>BDDMockito</strong>, предоставляющий примерно те же возможности в форме, более подходящей для <a href="https://ru.wikipedia.org/wiki/BDD_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)"><strong>BDD</strong></a>.
Доступ к функционалу реализован через его <strong>статические методы</strong>.</p>
</div>
<div class="paragraph">
<p>Помните, что методы <strong>mock</strong> объекта возвращают значения по умолчанию: <strong>false</strong> для <strong>boolean</strong>, <strong>0</strong> для <strong>int</strong>, <strong>пустые коллекции</strong>, <strong>null</strong> для остальных объектов.
Для <strong>spy</strong> — значение, возвращаемое методом реального объекта.</p>
</div>
<div class="paragraph">
<p>Для того, чтобы отличить mock-объект от обычного в составе <strong>Mockito</strong> для этого есть инструмент — <strong>метод Mockito.mockingDetails</strong>.
Передав ему произвольный объект, получим объект класса <strong>MockingDetails</strong>.
Он содержит информацию о том, что этот объект представляет собой с точки зрения <strong>Mockito</strong>: является ли он <strong>mock</strong>, <strong>spy</strong> (см. ниже), как использовался, как был создан и прочее.</p>
</div>
<div class="paragraph">
<p>Поведение по умолчанию (и не только его) можно изменить при помощи функционала класса <strong>MockSettings</strong>, но это нечасто бывает нужно.</p>
</div>
<div class="paragraph">
<p>Чтобы создать <strong>Mockito</strong> объект можно использовать либо аннотацию <strong>@Mock</strong>, либо <strong>метод</strong> <strong>mock</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Mock</span>
<span class="nc">ICalculator</span> <span class="n">mcalc</span><span class="o">;</span>

<span class="nc">ICalculator</span> <span class="n">mcalc</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">ICalculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Однако, что если необходимо использовать в качестве заглушки объект реального класса с имеющимся функционалом, переопределив работу только части его методов?
На этот случай в <strong>Mockito</strong> есть так называемые <strong>spy</strong>, "шпионы".
В отличие от <strong>mock&#8217;ов</strong>, их можно создавать на основе как класса, так и готового объекта.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">DataService</span> <span class="n">dataServiceSpy</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">spy</span><span class="o">(</span><span class="nc">DataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// or</span>
<span class="nc">DataService</span> <span class="n">dataService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataService</span><span class="o">();</span>
<span class="n">dataServiceSpy</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">spy</span><span class="o">(</span><span class="n">dataService</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>При создании <strong>spy</strong> на основе класса, если его тип — интерфейс, будет создан обычный <strong>mock-объект</strong>, а если тип — класс, то <strong>Mockito</strong> попытается создать экземпляр при помощи конструктора по умолчанию (без параметров).
И только если такого конструктора нет, произойдёт ошибка и тест не сработает.</p>
</div>
</div>
<div class="sect3">
<h4 id="_управление_поведением">5.2.3. Управление поведением</h4>
<div class="paragraph">
<p>В целом управление поведением <strong>mock-объекта</strong> сводится к одной очевидной концепции: когда на mock так-то воздействовали (то есть вызван такой-то метод с такими-то аргументами), он должен отреагировать так-то и так-то.
У этой концепции существуют две реализации в рамках класса <strong>Mockito</strong> — основная, рекомендуемая разработчиками к использованию везде, где это возможно, и альтернативная, применяемая там, где основная не годится.</p>
</div>
<div class="paragraph">
<p>Основная реализация базируется на методе <strong>Mockito.when</strong>.
Этот метод принимает в качестве "параметра" вызов переопределяемого метода <strong>mock-объекта</strong> (таким образом фиксируется определяемое воздействие) и возвращает объект типа <strong>OngoingStubbing</strong>, позволяющий вызвать один из методов семейства <strong>Mockito.then</strong>&#8230;&#8203; (так задаётся реакция на это воздействие).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//when(mock).thenReturn(value)</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">saveData</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">dataToSave</span><span class="o">);</span>
    <span class="nc">String</span> <span class="nf">getDataById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">);</span>
    <span class="nc">String</span> <span class="nf">getDataById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">calculateIfAbsent</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getData</span><span class="o">();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getDataListByIds</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">idList</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getDataByRequest</span><span class="o">(</span><span class="nc">DataSearchRequest</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">-----------------------------------------</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">data</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"dataItem"</span><span class="o">);</span>
<span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getAllData</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">data</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>После этой операции, вызвав у объекта dataService метод getAllData(), получим объект, data.</p>
</div>
<div class="paragraph">
<p>Альтернативная реализация связывания условия и результата вызова — методы семейства <strong>Mockito.do</strong>&#8230;&#8203;. Эти методы позволяют задать поведение начиная с результата вызова и возвращают объект класса <strong>Stubber</strong>, уже при помощи которого можно задать условие.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//doReturn(value).when(mock).method(params)</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataService</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getData</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">-----------------------------------------</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">data</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"dataItem"</span><span class="o">);</span>
<span class="nc">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(</span><span class="n">data</span><span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">).</span><span class="na">getData</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание: в первой реализации при задании поведения метода (в данном случае <strong>getAllData()</strong>) сначала выполняется вызов ещё не переопределённой его версии, и только потом, в недрах <strong>Mockito</strong>, происходит переопределение.
Во второй же такого вызова не происходит — методу <strong>Stubber.when</strong> передаётся непосредственно <strong>mock</strong>, а уже у возвращённого этим методом объекта того же типа, но другой природы совершается вызов переопределяемого метода.
Эта разница всё и определяет.
Связывание через <strong>Mockito.do&#8230;&#8203;</strong> никак не контролирует на стадии компиляции то, какой переопределяемый метод я вызову и совместим ли он по типу с заданным возвращаемым значением.</p>
</div>
<div class="sect4">
<h5 id="_задание_условий_вызова">Задание условий вызова</h5>
<div class="paragraph">
<p>Пример выше касается метода без параметров, и связанное с ним условие вызова возможно одно — сам факт вызова.
Как только появляются параметры, ситуация становится сложнее.
Как минимум, для вызова метода, поведение которого я задаю, мне нужно что-то ему передать.
Но важнее другое: может оказаться, что задаваемую реакцию я хочу получать не всегда, а только при вызове с параметрами, отвечающими определённым требованиям.
Если нужно задать реакцию на любой вызов этого метода независимо от аргументов, можно воспользоваться методом <strong>Mockito.any</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataService</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getDataItemById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">);</span>
<span class="o">-----------------------------------------</span>
<span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getDataItemById</span><span class="o">(</span><span class="n">any</span><span class="o">()))</span>
       <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">"dataItem"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Если же требуется, чтобы <strong>mock</strong> реагировал только на определённое значение аргумента, можно использовать непосредственно это значение или методы <strong>Mockito.eq</strong> (когда речь об эквивалентности) либо <strong>Mockito.same</strong> (когда требуется сравнение ссылок)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getDataItemById</span><span class="o">(</span><span class="s">"idValue"</span><span class="o">))</span>
       <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">"dataItem"</span><span class="o">);</span>
<span class="c1">// or</span>
<span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getDataItemById</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"idValue"</span><span class="o">)))</span>
       <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">"dataItem"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>При работе с методами с более чем одним аргументом заданные требования комбинируются в соответствии с логическим И, то есть для получения заданного результата КАЖДЫЙ из аргументов должен отвечать поставленному требованию.</p>
</div>
<div class="paragraph">
<p>Кроме того, при задании поведения такого метода нельзя комбинировать использующие матчеры статические методы Mockito и прямую передачу значений.
Используйте <strong>Mockito.eq</strong> или Mockito.same</p>
</div>
</div>
<div class="sect4">
<h5 id="_задание_результатов_вызова">Задание результатов вызова</h5>
<div class="paragraph">
<p>После того, как метод <strong>mock-объекта</strong> вызван, объект должен отреагировать на вызов.
Основные возможные последствия — возвращение результата и выбрасывание исключения, и именно на эти варианты в первую очередь рассчитан инструментарий <strong>Mockito</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getAllData</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">data</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Также</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getDataById</span><span class="o">(</span><span class="s">"invalidId"</span><span class="o">))</span>
       <span class="o">.</span><span class="na">thenThrow</span><span class="o">(</span><span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Есть и другой способ: можно создать объект исключения и бросить непосредственно его, а можно предоставить <strong>Mockito</strong> только класс исключения, чтобы оно было создано автоматически.
В обоих случаях синтаксис позволяет использовать и <strong>checked</strong> исключения, однако <strong>Mockito</strong> не позволит запустить такой тест, если тип исключения не соответствует методу, который я хочу заставить бросить это исключение.</p>
</div>
<div class="paragraph">
<p>Выше варианты реакции подходят, если в ответ на вызов с заданными условиями нужно всегда возвращать определённое, всегда одно и то же значение результата или выбрасывать всегда одинаковое исключение.
Предположим, метод принимает коллекцию значений, а возвращает другую коллекцию значений, связанных с первыми одно к одному (например, это получение коллекции объектов данных по набору их ID), и в рамках теста необходимо использовать этот <strong>mock-объект</strong> неоднократно с разными наборами входных данных, получая каждый раз соответствующий результат.
В Mockito есть метод <strong>Mockito.thenAnswer</strong>, он же <strong>Mockito.then</strong>.
Он принимает реализацию функционального интерфейса <strong>Answer</strong>, единственный метод которого получает объект <strong>класса InvocationOnMock</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getDataByIds</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">any</span><span class="o">()))</span>
       <span class="o">.</span><span class="na">thenAnswer</span><span class="o">(</span><span class="n">invocation</span> <span class="o">-&gt;</span> <span class="n">invocation</span>
                <span class="o">.&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span><span class="n">getArgument</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="k">switch</span> <span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="s">"a"</span><span class="o">:</span>
                            <span class="k">return</span> <span class="s">"dataItemA"</span><span class="o">;</span>
                        <span class="k">case</span> <span class="s">"b"</span><span class="o">:</span>
                            <span class="k">return</span> <span class="s">"dataItemB"</span><span class="o">;</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание: типобезопасности <strong>InvocationOnMock</strong> не обеспечивает — аргументы возвращаются либо в виде массива <strong>Object[]</strong>, либо <strong>generic</strong>-методом.</p>
</div>
<div class="paragraph">
<p>Отдельно стоит упомянуть ещё один вариант реакции — <strong>thenCallRealMethod</strong>.
Предназначение понятно из названия.
Он действует как для <strong>mock</strong>-, так и для <strong>spy</strong>-объектов.
В случае <strong>mock</strong> все поля объекта, к которым может обратиться код метода, будут опять-таки иметь значение <strong>null</strong>.
Для <strong>spy</strong> же использование <strong>thenCallRealMethod</strong> означает возвращение к поведению <strong>spy</strong> по умолчанию.</p>
</div>
<div class="paragraph">
<p>Методы <strong>thenReturn</strong> и <strong>thenThrow</strong> имеют перегруженные версии, принимающие <strong>varargs</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">dataService</span><span class="o">.</span><span class="na">getDataById</span><span class="o">(</span><span class="s">"a"</span><span class="o">))</span>
       <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">"valueA1"</span><span class="o">,</span> <span class="s">"valueA2"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">thenThrow</span><span class="o">(</span><span class="nc">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь первый вызов метода с заданным параметром вернёт "valueA1, второй — "valueA2, а третий (и все последующие) будет вызывать выбрасывание <strong>IllegalArgumentException</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_слежение_за_вызовами_методов">5.2.4. Слежение за вызовами методов</h4>
<div class="paragraph">
<p>Метод <strong>verify</strong> позволяет проверить, была ли выполнена проверка с определенными параметрами.
Если проверка не выполнялась или выполнялась с другими параметрами, то <strong>verify</strong> вызовет исключение.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">dataService</span><span class="o">).</span><span class="na">getDataById</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">any</span><span class="o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Тест с такой конструкцией пройдёт успешно, если она находится после единственного за время выполнения теста вызова метода <strong>getDataById</strong>, и упадёт, если метод не был вызван или был вызван дважды и более.</p>
</div>
<div class="paragraph">
<p>Для проверки количества вызовов определенных методов Mockito предоставляет следующие методы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>atLeast(int min) - не меньше min вызовов;</p>
</li>
<li>
<p>atLeastOnce() - хотя бы один вызов;</p>
</li>
<li>
<p>atMost(int max) - не более max вызовов;</p>
</li>
<li>
<p>times(int cnt) - cnt вызовов;</p>
</li>
<li>
<p>never() - вызовов не было;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">dataService</span><span class="o">,</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">times</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="na">getDataById</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">any</span><span class="o">());</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mock_объекты_как_значения_полей_и_аннотации_mockito">5.2.5. Mock-объекты как значения полей и аннотации Mockito</h4>
<div class="paragraph">
<p>Если в классе теста есть поля, которым я хочу присвоить <strong>mock-объекты</strong> в качестве значений, это не обязательно делать вручную — достаточно снабдить его аннотацией <strong>@Mock</strong>.</p>
</div>
<div class="paragraph">
<p>Для <strong>spy</strong> предусмотрена аннотация <strong>@Spy</strong> — она в целом аналогична <strong>@Mock</strong>… но для spy может использоваться объект, на основе которого он будет создан (несмотря на название, этот метод предназначен не только для <strong>mock&#8217;ов</strong>, а задействует также и все нижеперечисленные аннотации).
Такой объект можно сразу указать в качестве значения аннотируемого поля, но можно и не указывать — тогда <strong>spy</strong> будет создан на основе класса.</p>
</div>
<div class="paragraph">
<p>Есть аннотация <strong>@Captor</strong> для создания экземпляров <strong>ArgumentCaptor</strong>.</p>
</div>
<div class="paragraph">
<p>Ещё существует <strong>@InjectMocks</strong>.
Помеченное таким образом поле инициализируется настоящим объектом указанного класса.
Его поля по возможности проинициализированы значениями <strong>mock-полей</strong>, помеченных соответствующей аннотацией.
Для этого используется конструктор с наибольшим числом параметров, сеттеры и так далее.
Если какого-то объектного параметра конструктора не хватает, вместо него будет использован <strong>null</strong>, а вот параметр-примитив просто не позволит тесту сработать.
В целом это похоже на маленькую и простую (и всё равно не такую уж примитивную) реализацию <strong>dependency injection</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_откат_поведения_к_дефолтному_и_сессии_mockito">5.2.6. Откат поведения к дефолтному и сессии Mockito</h4>
<div class="paragraph">
<p>Чтобы привести все <strong>mock-объекты</strong> в состояние по умолчанию можно использовать методы <strong>Mockito.reset</strong> и <strong>Mockito.clearInvocations</strong>.
Оба принимают <strong>varargs</strong>, и передавать им нужно соответствующие <strong>mock&#8217;и</strong>.</p>
</div>
<div class="paragraph">
<p>Ещё одно решение — использовать так называемые <strong>сессии Mockito</strong>.
Именно его рекомендуют авторы.
В начале сессии все <strong>mock-объекты</strong> инициализируются, а после работы обязательно должно быть выполнено её окончание (хотя mock&#8217;и продолжают оставаться функциональными и после него).
Если я хочу создавать отдельную сессию для каждого тестового метода, то удобно создать поле типа MockitoSession, присвоить ему значение до вызова тестового метода и завершить сессию после.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Mock</span>
<span class="nc">DataService</span> <span class="n">dataService</span><span class="o">;</span>

<span class="nc">MockitoSession</span> <span class="n">session</span><span class="o">;</span>

<span class="nd">@BeforeMethod</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">session</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mockitoSession</span><span class="o">()</span>
            <span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
            <span class="o">.</span><span class="na">startMocking</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// some code using the dataService field</span>
<span class="o">}</span>

<span class="nd">@AfterMethod</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">session</span><span class="o">.</span><span class="na">finishMocking</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_links_3">5.2.7. Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://ru.wikipedia.org/wiki/BDD_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)">Mockito и как его готовить</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/444982/">BDD (программирование)</a></p>
</li>
<li>
<p><a href="https://www.javadoc.io/doc/org.mockito/mockito-core/2.7.10/org/mockito/Mockito.html">Официальная документация Mockito</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B0%D0%B2%D1%82%D0%BE%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%5D">Автотестирование</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging">5.3. Logging</h3>
<div class="paragraph">
<p><strong>Logging</strong> (<strong>логирование</strong>, <strong>журналирование</strong>) — это процесс записи куда-то (в файл, в сетевой сокет) данных о работе программы. Место, куда эти данные записываются, чаще всего представляет собой <strong>log-файл</strong> или систему логирования (например: ELK stack). Само содержимое называют <strong>logs</strong> (<strong>логи</strong>). <strong>Log</strong> (<strong>лог</strong>) — это одна запись, которая делается в <strong>log-file</strong> или систему логирования. Само действие по отправке записи при logging называется <strong>log</strong> (<strong>логировать</strong>, <strong>журналировать</strong>, <strong>записывать в logs</strong>).</p>
</div>
<div class="paragraph">
<p>Если в работе сервера, компьютера или программного обеспечения возникла неизвестная ошибка, в первую очередь смотрят logs. <strong>Log-файл</strong> — <strong>текстовый файл</strong> с информацией о действиях программного обеспечения или пользователей, который хранится на компьютере или передается на хранение в систему логирования. Это хронология событий и их источников, ошибок и причин, по которым они произошли. Читать и анализировать логи можно как с помощью обычного текстового редактора, так и с помощью специального ПО.</p>
</div>
<div class="paragraph">
<p><strong>Logging</strong> позволяет ответить на вопросы, что происходило, когда и при каких обстоятельствах. Без логов сложно понять, из-за чего появляется ошибка, если она возникает периодически и только при определенных условиях. Чтобы облегчить задачу администраторам и программистам, в logs записывается информация не только об ошибках, но и о причинах их возникновения. Благодаря logs найденные ошибки можно быстро исправить.</p>
</div>
<div class="paragraph">
<p>Следует так же понимать, что logs - фактически единственный способ понять, что произошло с программой, установленной и работающей на production environment, к которому, чаще всего, разработчики не имеют доступ. Поэтому разработчикам стоит заботиться о том, что бы разработанное ПО осуществляло logging, которое позволит установить причины неполадки и т.д.</p>
</div>
<div class="paragraph">
<p>Весь процесс логирования состоит из трех частей.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Сбор информации.</p>
</li>
<li>
<p>Фильтрование собранной информации.</p>
</li>
<li>
<p>Запись отобранной информации.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_типы_логов">5.3.1. Типы логов</h4>
<div class="paragraph">
<p>Для удобной работы с логами их делят на типы. Это помогает быстрее находить нужные и выбирать правильные инструменты для работы с ними. Например, выделяют:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>системные логи</strong>, то есть те, которые связаны с системными событиями;</p>
</li>
<li>
<p><strong>серверные логи</strong>, регистрирующие обращения к серверу и возникшие при этом ошибки;</p>
</li>
<li>
<p><strong>логи баз данных</strong>, фиксирующие запросы к базам данных;</p>
</li>
<li>
<p><strong>почтовые логи</strong>, относящиеся к входящим/исходящим письмам и отслеживающие ошибки, из-за которых письма не были доставлены;</p>
</li>
<li>
<p><strong>логи авторизации</strong>;</p>
</li>
<li>
<p><strong>логи аутентификации</strong>;</p>
</li>
<li>
<p><strong>логи приложений</strong>, установленных на этих операционных системах.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Также логи можно типизировать <strong>по степени важности</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Fatal/critical error</strong> — то, что нужно срочно исправить.</p>
</li>
<li>
<p><strong>Not critical error</strong> — ошибки, которые не влияют на пользователя.</p>
</li>
<li>
<p><strong>Warning</strong> — предупреждения, то, на что нужно обратить внимание.</p>
</li>
<li>
<p><strong>Initial information</strong> — информация о вызовах <strong>API</strong> сервиса, запросах в БД, вызовах других сервисов.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Еще одним важным вопросом на который надо ответить — это что необходимо отправлять в log.</p>
</div>
<div class="paragraph">
<p>Работа приложения — это происходящие в нем события, которые в свою очередь могут быть классифицированы на:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>события, связанные с бизнес-логикой;</p>
</li>
<li>
<p>события, связанные с безопасностью приложения;</p>
</li>
<li>
<p>системные события, связанные с уже конкретикой реализации — вызовов ОС, использования библиотек, фреймворков и т.д.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Записывать в logs обязательно необходимо:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Начало/конец работы приложения</strong>. Нужно знать, что приложение действительно запустилось, как и ожидалось, и завершилось так же ожидаемо.</p>
</li>
<li>
<p><strong>Вопросы безопасности</strong>. Здесь хорошо бы логировать попытки подбора пароля, логирование входа пользователей и т.д.</p>
</li>
<li>
<p>Некоторые <strong>состояния приложения</strong>. Например, переход из одного состояния в другое в бизнес процессе.</p>
</li>
<li>
<p>Некоторая <strong>информация для debug</strong>, с соответственным уровнем логирования.</p>
</li>
<li>
<p><strong>Некоторые SQL скрипты</strong>. Есть реальные случаи, когда это нужно. Опять-таки, умелым образом регулируя уровни, можно добиться отличных результатов.</p>
</li>
<li>
<p><strong>Выполняемые потоки (Thread)</strong> могут быть отправлены в log в случаях с проверкой корректной работы.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Популярные ошибки в logging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Избыток логирования</strong><br>
Не стоит логировать каждый шаг, который чисто теоретически может быть важным. <strong>Есть правило</strong>: логи могут нагружать работоспособность не более, чем на <strong>10%</strong>. Иначе будут проблемы с производительностью.</p>
</li>
<li>
<p><strong>Логирование всех данных в один файл</strong><br>
Это приведет к тому, что в определенный момент чтение/запись в него будет очень сложной, не говоря о том, что есть ограничения по размеру файлов в определенных системах.</p>
</li>
<li>
<p><strong>Использование неверных уровней логирования</strong><br>
У каждого уровня логирования есть четкие границы, и их стоит соблюдать. Если граница расплывчатая, можно договориться какой из уровней использовать.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_библиотеки_логирования_в_java">5.3.2. Библиотеки логирования в Java</h4>
<div class="paragraph">
<p>В <strong>Java</strong> существуют следующие <strong>библиотеки логирования</strong>, иногда называемые <strong>loggers</strong> (<strong>логерами</strong>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Log4j</strong> - это первый набор инструментов для логирования Java, который появился еще в 1999-м году. Внутри себя имеет различные способы вывода логов, несколько форматов логирования и многое другое. Раньше данная библиотека активно применялась, но уже долгое время этот проект не развивается.</p>
</li>
<li>
<p><strong>JUL</strong> — <code>java.util.logging</code>. Является частью <strong>JDK</strong>. Имеет множество уровней логирования, например, только для отладки у этого инструмента есть в арсенале 3 отладочных уровня вместо одного как у большинства библиотек.</p>
</li>
<li>
<p><strong>JCL</strong> — <strong>Apache Commons Logging</strong>. Из-за того, что долгое время не было промышленного стандарта в logging и был период, когда многие создавали свой свои собственные библиотеки логирования, решили выпустить <strong>JCL</strong> — общую обертку, которая  использовалась бы над другими.</p>
</li>
<li>
<p><strong>Logback</strong> - был создан как альтернатива умирающему <strong>Log4j</strong>, разработанная создателями <strong>Log4j</strong>, поэтому он вобрал в себя все лучшее из этого инструмента, при этом усовершенствовал некоторые показатели.</p>
</li>
<li>
<p><strong>Log4j 2.x</strong> - это улучшенная версия <strong>log4j 1.x</strong> и <strong>logback</strong>.</p>
</li>
<li>
<p><strong>SLF4J</strong> — <strong>Simple Logging Facade for Java</strong>. Этот инструмент является оберткой над многими популярными библиотеками логирования, например: <strong>Logback</strong>, <strong>Log4j</strong>, <strong>JUL</strong> и др., поэтому его рекомендуется использовать в паре с полноценной библиотекой для логирования.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_уровень_логирования">5.3.3. Уровень логирования</h4>
<div class="paragraph">
<p>Если в <strong>лог-файл</strong> записывать все действия программы, то там будет большое количество различных сведений. В некоторых ситуациях лог-файлы могут генерироваться очень быстро и в огромных размерах. В этом случае найти нужную информацию в логах будет очень нелегко. Поэтому, чтобы контролировать объемы записываемой информации, придумали различные уровни логирования.</p>
</div>
<div class="paragraph">
<p><strong>Уровень логирования</strong> — это разделение событий по приоритетам, по степени важности. Например, <strong>error</strong> - пишем ошибки, <strong>debug</strong> - пишем более подробно в лог и т.д.</p>
</div>
<div class="paragraph">
<p>Практически все библиотеки логирования (кроме <strong>JUL</strong>) имеют следующие уровни логирования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>OFF</strong>: никакие логи не записываются, все будут проигнорированы</p>
</li>
<li>
<p><strong>FATAL</strong>: ошибка, после которой приложение уже не сможет работать и будет остановлено, например, <strong>JVM out of memory error</strong></p>
</li>
<li>
<p><strong>ERROR</strong>: уровень ошибок, когда есть проблемы, которые нужно решить. Ошибка не останавливает работу приложения в целом. Остальные запросы могут работать корректно</p>
</li>
<li>
<p><strong>WARN</strong>: обозначаются логи, которые содержат предостережение. Произошло неожиданное действие, несмотря на это система устояла и выполнила запрос</p>
</li>
<li>
<p><strong>INFO</strong>: лог, который записывает важные действия в приложении. Это не ошибки, это не предостережение, это ожидаемые действия системы</p>
</li>
<li>
<p><strong>DEBUG</strong>: логи, необходимые для отладки приложения. Для уверенности в том, что система делает именно то, что от нее ожидают, или описания действия системы: <code>method1 начал работу</code></p>
</li>
<li>
<p><strong>TRACE</strong>: менее приоритетные логи для отладки, с наименьшим уровнем логирования</p>
</li>
<li>
<p><strong>ALL</strong>: уровень, при котором будут записаны все логи из системы</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Если в приложении в каком-то месте включен уровень логирования <strong>INFO</strong>, будут записываться в logs все уровни, начиная с <strong>INFO</strong> и до <strong>FATAL</strong>. Если будет уровень логирования <strong>FATAL</strong>, будут записаны <strong>только logs с этим уровнем</strong>.</p>
</div>
<div class="paragraph">
<p><strong>JUL</strong> имеет следующие уровни логирования (по степени убывания приоритета):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>OFF</strong></p>
</li>
<li>
<p><strong>ALL</strong></p>
</li>
<li>
<p><strong>SEVERE</strong></p>
</li>
<li>
<p><strong>WARNING</strong></p>
</li>
<li>
<p><strong>INFO</strong></p>
</li>
<li>
<p><strong>CONFIG</strong></p>
</li>
<li>
<p><strong>FINE</strong></p>
</li>
<li>
<p><strong>FINER</strong></p>
</li>
<li>
<p><strong>FINEST</strong></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_основные_термины">5.3.4. Основные термины</h4>
<div class="paragraph">
<p>В основе большинства библиотек логирования в <strong>Java</strong> лежат три понятия:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Logger</strong></p>
</li>
<li>
<p><strong>Appender</strong></p>
</li>
<li>
<p><strong>Layout</strong></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_logger">Logger</h5>
<div class="paragraph">
<p><strong>Logger</strong> — это некий объект, который отвечает за запись информации в лог-файлы или систему логирования, опираясь на заданные уровни логирования. <strong>Logger</strong> создается с помощью <strong>Factory</strong> и на этапе создания ему присваивается имя. Имя может быть любым, но по стандарту имя должно быть сопряжено с именем класса, в котором собираются что-то логировать.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">gerLogger</span><span class="o">(</span><span class="nc">SomeClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Основная задача Logger</strong> — не пропустить событие, которое нужно записать в лог-файл.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">gerLogger</span><span class="o">(</span><span class="nc">SomeClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Application started"</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Or not"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Каждый log представляет собой событие, которое произошло. Событие по сути состоит из двух полей:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>message</code></p>
</li>
<li>
<p><code>level</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>В примере выше, <code>level</code> - это <code>Level.Info</code>, а <code>message</code> - это <code>"Application started"</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_appender">Appender</h5>
<div class="paragraph">
<p><strong>Appender</strong> — это конечная точка, куда «приходит» информация для логирования. В качестве <strong>appender</strong> могут выступать: <strong>файл</strong>, <strong>база данных</strong>, <strong>консоль</strong>, <strong>сокет</strong> и др. У <strong>appender</strong> нет каких-либо ограничений, куда записывать сообщения. Можно написать свой <strong>appender</strong>, который пишет сообщения куда-угодно. Если <strong>Logger</strong> — это начальная точка в logging, то <strong>Appender</strong> — это конечная точка.</p>
</div>
<div class="paragraph">
<p><strong>Loggers</strong>  и <strong>appenders</strong> связаны в отношении <code>many-to-many</code>. При этом один <strong>logger</strong> может содержать несколько <strong>appenders</strong> и наоборот. Чтобы изменить поведение <strong>logger по умолчанию</strong>, нам нужно произвести конфигурацию для logging.</p>
</div>
</div>
<div class="sect4">
<h5 id="_layout">Layout</h5>
<div class="paragraph">
<p><strong>Layout</strong> — это формат, в котором выводятся сообщения. Форматирование сообщений напрямую зависит от используемой библиотеки при logging.</p>
</div>
</div>
<div class="sect4">
<h5 id="_logging_nodes">Logging Nodes</h5>
<div class="paragraph">
<p>При создании logger используется класс, но по итогу записывается полное имя класса с пакетами. Это делается, чтобы потом можно было разделить на <strong>logging nodes</strong> (<strong>узлы логирования</strong>), и для каждого узла настроить уровень логирования и appender. Например, имя класса: <code>com.github.romankh3.logginglecture.MainDemo</code> — в нем создался logger. И вот таким образом его можно разделить на <strong>logging nodes</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/tools/logging/logging-nodes.png" alt="logging nodes"></span></p>
</div>
<div class="paragraph">
<p>Каждый <strong>logger</strong> имеет имя, описывающее иерархию, к которой он принадлежит. Разделитель – точка. Принцип полностью аналогичен формированию имени пакета в <strong>Java</strong>. Например: <code>by.rakovets.example.SomeClass</code>. Главный узел — нулевой <strong>RootLogger</strong>. Это узел, который принимает все логи всего приложения. Каждому <strong>logger</strong> можно выставить свой уровень. Установленный <strong>logger</strong> уровень вывода распространяется на все его дочерние <strong>loggers</strong>, для которых явно не выставлен уровень. Поэтому у всех <strong>loggers</strong> будет уровень логирования, даже если явно мы не прописали для <code>by.rakovets.example.SomeClass</code> его, то он будет наследоваться от <strong>RootLogger</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Appenders</strong> настраивают свою работу именно на узлы логирования. Но такое наследование <strong>appenders</strong> можно отключить через конфигурацию, для этого стоит посмотреть в сторону выставления флага <code>additivity="false"</code> на <strong>loggers</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_конфигурация_и_использование">5.3.5. Конфигурация и использование</h4>
<div class="sect4">
<h5 id="_конфигурация_2">Конфигурация</h5>
<div class="paragraph">
<p>При конфигурировании можно выбрать куда будет производиться запись, путь где будет лежать файл лога, количество файлов, их размеры. Более подробные описания конфигураций для различных реализаций будут приведены при описании этих реализаций.</p>
</div>
<div class="paragraph">
<p>В зависимости от используемой библиотеки, <strong>loggers</strong> могут конфигурироваться различными способами.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Log4j</strong> поддерживает конфигурирование двумя способами – как <strong>properties</strong> и <strong>xml</strong> файл.</p>
</li>
<li>
<p><strong>JUL</strong> настраивается только через <strong>properties</strong> файл.</p>
</li>
<li>
<p><strong>Logback</strong> может быть сконфигурирован через <strong>xml</strong> и <strong>groovy</strong> файл.</p>
</li>
<li>
<p><strong>Log4j 2</strong> может быть сконфигурирован через <strong>xml</strong>, <strong>json</strong> и <strong>yaml</strong> файл.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Конфигурация через xml-файл:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE log4j:configuration SYSTEM "log4j.dtd"&gt;</span>
<span class="nt">&lt;log4j:configuration</span> <span class="na">debug=</span><span class="s">"false"</span> <span class="na">xmlns:log4j=</span><span class="s">"http://jakarta.apache.org/log4j/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"ConsoleAppender"</span> <span class="na">class=</span><span class="s">"org.apache.log4j.ConsoleAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"Encoding"</span> <span class="na">value=</span><span class="s">"Cp866"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;layout</span> <span class="na">class=</span><span class="s">"org.apache.log4j.PatternLayout"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"ConversionPattern"</span> <span class="na">value=</span><span class="s">"%d{ISO8601} [%-5p][%-16.16t][%32.32c] - %m%n"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/layout&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="nt">&lt;root&gt;</span>
        <span class="nt">&lt;priority</span> <span class="na">value=</span><span class="s">"DEBUG"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"ConsoleAppender"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/log4j:configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Конфигурация через properties-файл:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">log4j.debug</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">log4j.rootLogger</span> <span class="p">=</span> <span class="s">DEBUG, ConsoleAppender</span>
<span class="c"># CONSOLE appender customisation
</span><span class="py">log4j.appender.ConsoleAppender</span> <span class="p">=</span> <span class="s">org.apache.log4j.ConsoleAppender</span>
<span class="py">log4j.appender.ConsoleAppender.encoding</span> <span class="p">=</span> <span class="s">Cp866</span>
<span class="py">log4j.appender.ConsoleAppender.layout</span> <span class="p">=</span> <span class="s">org.apache.log4j.PatternLayout</span>
<span class="py">log4j.appender.ConsoleAppender.layout.ConversionPattern</span> <span class="p">=</span> <span class="s">%d{ISO8601} [%-5p][%-16.16t][%32.32c] - %m%n</span>
<span class="c"># File appender customisation
</span><span class="py">log4j.appender.FILE</span><span class="p">=</span><span class="s">org.apache.log4j.RollingFileAppender</span>
<span class="py">log4j.appender.FILE.File</span><span class="p">=</span><span class="s">./target/logging/logging.log</span>
<span class="py">log4j.appender.FILE.MaxFileSize</span><span class="p">=</span><span class="s">1MB log4j.appender.FILE.threshold=DEBUG log4j.appender.FILE.MaxBackupIndex=2 log4j.appender.FILE.layout=org.apache.log4j.PatternLayout log4j.appender.FILE.layout.ConversionPattern=[ %-5p] - %c:%L - %m%n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Принято считать эти два способа равнозначными. При инициализации они ищутся в <strong>classpath</strong>, сначала <strong>xml-файл</strong>, потом <strong>properties-файл</strong>. Так что при наличии обоих рабочим будет именно <strong>xml</strong>.</p>
</div>
<div class="paragraph">
<p>Ниже приведен пример конфигурации <code>log4j.properties</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">log4j.appender.CONSOLE</span><span class="p">=</span><span class="s">org.apache.log4j.ConsoleAppender</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Эта строка говорит, что мы регистрируем <strong>appender</strong> <code>CONSOLE</code>, который использует реализацию <code>org.apache.log4j.ConsoleAppender</code>. Этот <strong>appender</strong> записывает данные в консоль.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">log4j.appender.FILE</span><span class="p">=</span><span class="s">org.apache.log4j.RollingFileAppender</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Этот <strong>appender</strong> записывает в файл.</p>
</div>
<div class="paragraph">
<p>Когда у нас уже есть зарегистрированные <strong>appenders</strong>, мы можем определить, какой будет уровень логирования в узлах и какие <strong>appenders</strong> будут при этом использоваться.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">log4j.rootLogger</span><span class="p">=</span><span class="s">DEBUG, CONSOLE, FILE</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>log4j.rootLogger</code> означает, что будем настраивать главный узел, в котором находятся все логи;</p>
</li>
<li>
<p>после знака равно первое слово говорит о том, с каким уровнем и выше будут записываться логи (в нашем случае это <code>DEBUG</code>);</p>
</li>
<li>
<p>далее после запятой указываются все <strong>appenders</strong>, которые будут использоваться.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Чтобы настроить определенный узел логирования, нужно использовать такую запись:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">log4j.logger.com.github.romankh3.logginglecture</span><span class="p">=</span><span class="s">TRACE, OWN, CONSOLE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>где <code>log4j.logger.</code> используется для настройки определенного узла, в нашем случае это <code>com.github.romankh3.logginglecture.</code>.</p>
</div>
<div class="paragraph">
<p>Настройка <code>CONSOLE</code> <strong>appender</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># CONSOLE appender customisation
</span><span class="py">log4j.appender.CONSOLE</span><span class="p">=</span><span class="s">org.apache.log4j.ConsoleAppender</span>
<span class="py">log4j.appender.CONSOLE.threshold</span><span class="p">=</span><span class="s">DEBUG</span>
<span class="py">log4j.appender.CONSOLE.layout</span><span class="p">=</span><span class="s">org.apache.log4j.PatternLayout</span>
<span class="py">log4j.appender.CONSOLE.layout.ConversionPattern</span><span class="p">=</span><span class="s">[%-5p] : %c:%L : %m%n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь видно, что можно задать уровень, с которого будет обрабатывать именно <strong>appender</strong>. Реальная ситуация: сообщение с уровнем <code>info</code> принял узел логирования и передал <strong>appender</strong>, который к нему приписан, а вот уже <strong>appender</strong>, с уровнем <code>warn</code> и выше, лог этот принял, но ничего с ним не сделал.</p>
</div>
<div class="paragraph">
<p>Далее нужно определиться с тем, какой шаблон будет в сообщении (<code>PatternLayout</code>).</p>
</div>
<div class="paragraph">
<p>Пример настройки <code>FILE</code> <strong>appender</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># File appender customisation
</span><span class="py">log4j.appender.FILE</span><span class="p">=</span><span class="s">org.apache.log4j.RollingFileAppender</span>
<span class="py">log4j.appender.FILE.File</span><span class="p">=</span><span class="s">./target/logging/logging.log</span>
<span class="py">log4j.appender.FILE.MaxFileSize</span><span class="p">=</span><span class="s">1MB</span>
<span class="py">log4j.appender.FILE.threshold</span><span class="p">=</span><span class="s">DEBUG</span>
<span class="py">log4j.appender.FILE.MaxBackupIndex</span><span class="p">=</span><span class="s">2</span>
<span class="py">log4j.appender.FILE.layout</span><span class="p">=</span><span class="s">org.apache.log4j.PatternLayout</span>
<span class="py">log4j.appender.FILE.layout.ConversionPattern</span><span class="p">=</span><span class="s">[ %-5p] - %c:%L - %m%n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь можно настроить, в какой именно файл будут записываться логи. Запись идет в файл <code>logging.log</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">log4j.appender.FILE.File</span><span class="p">=</span><span class="s">./target/logging/logging.log</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Чтобы не было проблем с размером файла, можно настроить максимальный: в данном случае — <code>1МБ</code>.</p>
</div>
<div class="paragraph">
<p><code>MaxBackupIndex</code> — говорит о том, сколько будет таких файлов. Если создается больше этого числа, то первый файл будет удален.</p>
</div>
</div>
<div class="sect4">
<h5 id="_использование">Использование</h5>
<div class="paragraph">
<p>Чтобы использовать <code>Logger</code>, необходимо его создать:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ClassName</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Чтобы сделать запись в лог, можно использовать множество методов, которые показывают, с каким уровнем будут записи.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ClassName</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Method 1 started with argument={}"</span><span class="o">,</span> <span class="n">argument</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Database updated with script = {}"</span><span class="o">,</span> <span class="n">script</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Application has started on port = {}"</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Log4j didn't find log4j.properties.Please, provide them"</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Connection refused to host = {}"</span><span class="o">,</span> <span class="n">host</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Также можно использовать метод <code>log()</code> и передать в него параметры.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ClassName</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">INFO</span><span class="o">,</span> <span class="n">argument</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_реализация_slf4jlog4j_2logback">5.3.6. Реализация (SLF4J/Log4J 2/Logback)</h4>
<div class="paragraph">
<p>На данный момент в <strong>Java</strong> наиболее популярные следующие библиотеки логирования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>log4j 2</strong></p>
</li>
<li>
<p><strong>Logback</strong></p>
</li>
<li>
<p><strong>SLF4J</strong> (как фасад)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_system_err_println"><code>System.err.println()</code></h5>
<div class="paragraph">
<p>Первоначально был, разумеется, <code>System.err.println()</code> - выводит запись в консоль. Его и сейчас используют для быстрого получения лога при debugging.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log4j_2">Log4j 2</h5>
<div class="paragraph">
<p>Для использования <strong>log4j2</strong> вам необходимо подключить библиотеки <code>log4j-api-2.x</code> и <code>log4j-core-2.x</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${log4j.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${log4j.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Logger создается вызовом статического метода класса <code>org.apache.logging.log4j.Logger</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LoggingLog4j</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Logger</strong> умеет принимать помимо <code>String</code>, <code>Object</code> и <code>Throwable</code> еще два новых типа — <code>MapMessage</code> и <code>Marker</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LoggingLog4j</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="c1">// Карта сообщений (напечатается как msg1="Сообщение 1” msg2="Сообщение 2”)</span>
        <span class="nc">MapMessage</span> <span class="n">mapMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapMessage</span><span class="o">();</span>
        <span class="n">mapMessage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg1"</span><span class="o">,</span> <span class="s">"Сообщение 1"</span><span class="o">);</span>
        <span class="n">mapMessage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg2"</span><span class="o">,</span> <span class="s">"Сообщение 2"</span><span class="o">);</span>
        <span class="c1">// Маркер, объект по которому можно фильтровать сообщения</span>
        <span class="nc">Marker</span> <span class="n">marker</span> <span class="o">=</span> <span class="nc">MarkerManager</span><span class="o">.</span><span class="na">getMarker</span><span class="o">(</span><span class="s">"fileonly"</span><span class="o">);</span>
        <span class="c1">// Строковое сообщение</span>
        <span class="nc">String</span> <span class="n">stringMessage</span> <span class="o">=</span> <span class="s">"Сообщение"</span><span class="o">;</span>
        <span class="c1">// Строковое сообщение с параметрами</span>
        <span class="nc">String</span> <span class="n">stringMessageFormat</span> <span class="o">=</span> <span class="s">"Сообщение {}, от {}"</span><span class="o">;</span>
        <span class="c1">// Исключение</span>
        <span class="nc">Throwable</span> <span class="n">throwable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Throwable</span><span class="o">();</span>
        <span class="c1">// Объект</span>
        <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В классическом для loggers стиле методы делятся на два типа:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>совпадающие с названием уровня логирования</p>
<div class="literalblock">
<div class="content">
<pre>log.info((marker, mapMessage, throwable);
log.throwing(throwable);</pre>
</div>
</div>
</li>
<li>
<p>методы <code>log()</code>, принимающие уровень логирования в качестве параметра.</p>
<div class="literalblock">
<div class="content">
<pre>log.log(Level.INFO, marker, stringMessage, throwable);
log.throwing(Level.INFO, throwable);</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Если не определить конфигурацию, то при запуске <strong>log4j2</strong> выдаст гневное сообщение, о том, что конфигурация не задана и будет печатать сообщения на консоль уровнем не ниже <strong>ERROR</strong>. Конфигурация <strong>log4j2</strong> задается несколькими вариантами: <strong>xml</strong>, <strong>json</strong>, <strong>yaml</strong>. Файл с конфигурацией автоматически ищется <strong>classpath</strong>, должен иметь название <strong>log4j2</strong> и располагаться в пакете по умолчанию.</p>
</div>
<div class="paragraph">
<p>Конфигурация <strong>log4j2</strong> состоит из описания loggers, appenders и filters.</p>
</div>
<div class="paragraph">
<p><strong>Filters</strong> позволяют оценивать события logging, чтобы определить, следует ли их публиковать и каким образом. <strong>Filter</strong> будет вызван одним из своих методов и вернет <strong>Result</strong>, который представляет собой <strong>Enum</strong> имеющий одно из 3 значений:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ACCEPT</code></p>
</li>
<li>
<p><code>DENY</code></p>
</li>
<li>
<p><code>NEUTRAL</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Filters</strong> могут быть сконфигурированы в одном из четырех мест:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Контекстные фильтры</strong><br>
Настраиваются непосредственно в конфигурации. События, отклоняемые этими фильтрами, не будут передаваться регистраторам для дальнейшей обработки. После того как событие было принято контекстным фильтром, оно не будет оцениваться никакими другими контекстными фильтрами, а уровень регистратора не будет использоваться для фильтрации события. Однако событие будет оцениваться фильтрами <strong>Logger</strong> и <strong>Appender</strong>.</p>
</li>
<li>
<p><strong>Фильтры регистратора</strong><br>
Настраиваются на указанном регистраторе. Они оцениваются после контекстных фильтров и уровня журнала для регистратора. События, отклоненные этими фильтрами, будут отброшены, и событие не будет передано родительскому регистратору независимо от параметра аддитивности.</p>
</li>
<li>
<p><strong>Фильтры Appender</strong><br>
Используются для определения того, должен ли конкретный Appender обрабатывать форматирование и публикацию события.</p>
</li>
<li>
<p><strong>Ссылочные фильтры appender</strong><br>
Используются для определения того, должен ли регистратор направлять событие в приложение.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Есть различные фильтра, в том числе и по маркерам:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>BurstFilter</strong> - предоставляет механизм для управления скоростью обработки <strong>LogEvents</strong> путем автоматического отбрасывания событий после достижения максимального предела.</p>
</li>
<li>
<p><strong>CompositeFilter</strong> - предоставляет способ указать несколько фильтров. Он добавляется в конфигурацию в качестве элемента фильтров и содержит другие фильтры для оценки. Элемент <strong>filters</strong> не принимает никаких параметров.</p>
</li>
<li>
<p><strong>DynamicThresholdFilter</strong> - позволяет выполнять фильтрацию по уровню журнала на основе определенных атрибутов.</p>
</li>
<li>
<p><strong>MapFilter</strong> - позволяет фильтровать по элементам данных, которые находятся в MapMessage.</p>
</li>
<li>
<p><strong>MarkerFilter</strong> - сравнивает настроенное значение маркера с параметром маркера, включенным в <strong>LogEvent</strong>. Совпадение происходит, когда имя маркера совпадает с маркером события журнала или одним из его родителей.</p>
</li>
<li>
<p><strong>RegexFilter</strong> - позволяет сравнивать отформатированное или неформатированное сообщение с регулярным выражением.</p>
</li>
<li>
<p><strong>StructuredDataFilter</strong> - это <code>MapFilter</code>, который также позволяет фильтровать по идентификатору события, типу и сообщению.</p>
</li>
<li>
<p><strong>ThreadContextMapFilter</strong> - позволяет выполнять фильтрацию по элементам данных, которые находятся в сопоставлении <strong>ThreadContext</strong>.</p>
</li>
<li>
<p><strong>ThresholdFilter</strong> - возвращает результат <strong>onMatch</strong>, если уровень в <strong>LogEvent</strong> совпадает или более специфичным, чем настроенный уровень, а значение <strong>onMismatch</strong> в противном случае.</p>
</li>
<li>
<p><strong>TimeFilter</strong> - можно использовать для ограничения фильтра только определенной частью дня.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Имеется широкий круг классов appenders, в том числе асинхронные appenders и appenders оборачивающие группу других appenders.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>AsyncAppender</strong> - принимает ссылки на другие приложения и заставляет <strong>LogEvents</strong> записываться на них в отдельном потоке.</p>
</li>
<li>
<p><strong>OutputStreamAppender</strong> - предоставляет основу для многих других приложений, таких как приложения <strong>File</strong> и <strong>Socket</strong>, которые записывают событие в выходной поток.</p>
</li>
<li>
<p><strong>ConsoleAppender</strong> - записывает свои выходные данные либо в <code>System.out</code>, либо в <code>System.err</code>, причем <code>System.out</code> является целевым объектом по умолчанию.</p>
</li>
<li>
<p><strong>FileAppender</strong> - это объект <code>OutputStreamAppender</code>, который записывает данные в файл, указанный в параметре fileName.</p>
</li>
<li>
<p><strong>JDBCAppender</strong> - записывает события журнала в таблицу реляционной базы данных с помощью стандартного <code>JDBC</code>.</p>
</li>
<li>
<p><strong>RollingFileAppender</strong> - это объект <code>OutputStreamAppender</code>, который записывает данные в файл, указанный в параметре <strong>fileName</strong>, и переворачивает файл в соответствии с параметрами <strong>TriggeringPolicy</strong> и <strong>RolloverPolicy</strong>.</p>
</li>
<li>
<p><strong>SocketAppender</strong> - это <code>OutputStreamAppender</code>, который записывает свои выходные данные в удаленное место назначения, указанное узлом и портом.</p>
</li>
<li>
<p>И другие.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Стоит также заметить, что <strong>log4j</strong> может создавать множество различающихся appenders одного и того же класса, например несколько файловых appenders, которые пишут в разные файлы. Рассмотрим пример конфигурации, в которой объявлены два logger:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>корневой — которых пишет в файл <code>log.log</code></p>
</li>
<li>
<p>для нашего класса — пишет в <code>log2.log</code> с использованием фильтрации по маркер.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Пример настройки конфигурации <code>log4j.xml</code> файла</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;Configuration&gt;</span>
    <span class="c">&lt;!-- Секция appenders --&gt;</span>
    <span class="nt">&lt;Appenders&gt;</span>
        <span class="c">&lt;!-- Файловый appender --&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">name=</span><span class="s">"file"</span> <span class="na">fileName=</span><span class="s">"log.log"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;PatternLayout&gt;</span>
                <span class="nt">&lt;Pattern&gt;</span>%d %p %c{1.} [%t] %m %ex%n<span class="nt">&lt;/Pattern&gt;</span>
            <span class="nt">&lt;/PatternLayout&gt;</span>
        <span class="nt">&lt;/File&gt;</span>
        <span class="c">&lt;!-- Файловый appender --&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">name=</span><span class="s">"file2"</span> <span class="na">fileName=</span><span class="s">"log2.log"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- Фильтр по маркеру --&gt;</span>
            <span class="nt">&lt;MarkerFilter</span> <span class="na">marker=</span><span class="s">"fileonly"</span> <span class="na">onMatch=</span><span class="s">"DENY"</span> <span class="na">onMismatch=</span><span class="s">"ACCEPT"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;PatternLayout&gt;</span>
                <span class="nt">&lt;Pattern&gt;</span>%d %p %c{1.} [%t] %m %ex%n<span class="nt">&lt;/Pattern&gt;</span>
            <span class="nt">&lt;/PatternLayout&gt;</span>
        <span class="nt">&lt;/File&gt;</span>
    <span class="nt">&lt;/Appenders&gt;</span>
    <span class="c">&lt;!-- Секция loggers --&gt;</span>
    <span class="nt">&lt;Loggers&gt;</span>
        <span class="c">&lt;!-- Корневой logger --&gt;</span>
        <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">"trace"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">"file"</span> <span class="na">level=</span><span class="s">"DEBUG"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Root&gt;</span>
        <span class="c">&lt;!-- Logger нашего класса --&gt;</span>
        <span class="nt">&lt;Logger</span> <span class="na">name=</span><span class="s">"logging.log4j.LoggingLog4j"</span> <span class="na">level=</span><span class="s">"info"</span> <span class="na">additivity=</span><span class="s">"false"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">"file2"</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Logger&gt;</span>
    <span class="nt">&lt;/Loggers&gt;</span>
<span class="nt">&lt;/Configuration&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_logback">Logback</h5>
<div class="paragraph">
<p>Данный фреймворк используется только в связке с оберткой <strong>SLF4J</strong>.</p>
</div>
<div class="paragraph">
<p>Добавляется следующей зависимостью:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.2.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LoggingLogback</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>API позволяет выводить строковые сообщения, шаблоны строковых сообщений, исключения, а также использовать маркеры.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Program</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LoggingLogback</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Строковое сообщение</span>
        <span class="nc">String</span> <span class="n">stringMessage</span> <span class="o">=</span> <span class="s">"Сообщение"</span><span class="o">;</span>
        <span class="c1">// Шаблон сообщения</span>
        <span class="nc">String</span> <span class="n">stringMessageFormat</span> <span class="o">=</span> <span class="s">"Сообщение {} {}"</span><span class="o">;</span>
        <span class="c1">// Ошибка</span>
        <span class="nc">Throwable</span> <span class="n">throwable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Throwable</span><span class="o">();</span>
        <span class="c1">// Маркер</span>
        <span class="nc">Marker</span> <span class="n">marker</span> <span class="o">=</span> <span class="nc">MarkerFactory</span><span class="o">.</span><span class="na">getMarker</span><span class="o">(</span><span class="s">"marker"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Конфигурация ищется в <strong>classpath</strong> в следующем порядке:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Пытается найти <code>logback.groovy</code></p>
</li>
<li>
<p>Иначе пытается найти <code>logback-test.xml</code></p>
</li>
<li>
<p>Иначе пытается найти <code>logback.xml</code></p>
</li>
<li>
<p>Иначе использует базовую конфигурацию — выводим сообщения на консоль</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Основными элементами конфигурации являются <strong>loggers</strong>, <strong>appenders</strong>, <strong>layout</strong>, и <strong>filters</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Logback-classic</strong> предлагает два типа фильтров:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>обычные фильтры</p>
</li>
<li>
<p>турбофильтры</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Имеются следующие фильтры:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Regular filters</strong></p>
</li>
<li>
<p><strong>LevelFilter</strong> - фильтрует события на основе точного соответствия уровней.</p>
</li>
<li>
<p><strong>ThresholdFilter</strong> - фильтрует события ниже указанного порогового значения.</p>
</li>
<li>
<p><strong>EvaluatorFilter</strong> - это универсальный фильтр, инкапсулирующий. Как следует из названия, <strong>EventEvaluator</strong> оценивает, соответствует ли заданный критерий для данного события.</p>
</li>
<li>
<p><strong>Matchers</strong></p>
</li>
<li>
<p><strong>CountingFilter</strong></p>
</li>
<li>
<p><strong>TurboFilters</strong> - предназначены для высокопроизводительной фильтрации регистрирования событий еще до их создания.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Имеются следующие appenders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>OutputStreamAppender</strong></p>
</li>
<li>
<p><strong>ConsoleAppender</strong></p>
</li>
<li>
<p><strong>FileAppender</strong></p>
</li>
<li>
<p><strong>RollingFileAppender</strong></p>
</li>
<li>
<p><strong>SocketAppender</strong> и <strong>SSLSocketAppender</strong></p>
</li>
<li>
<p><strong>ServerSocketAppender</strong> и <strong>SSLServerSocketAppender</strong></p>
</li>
<li>
<p><strong>SMTPAppender</strong></p>
</li>
<li>
<p><strong>SyslogAppender</strong></p>
</li>
<li>
<p><strong>SiftingAppender</strong></p>
</li>
<li>
<p><strong>AsyncAppender</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Encoders</strong> (кодировщики) отвечают за преобразование входящего события в массив байтов и запись результирующего массива байтов в соответствующий массив. Таким образом, кодировщики имеют полный контроль над тем, что и когда записываются в <strong>appender</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Layouts</strong>  — это компоненты, отвечающие за преобразование входящего события в строку. Метод в интерфейсе <strong>Layout</strong> принимает объект, представляющий событие (любого типа), и возвращает объект <code>String</code>.</p>
</div>
<div class="listingblock">
<div class="title">Простой пример файла <code>logback.xml</code>:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="c">&lt;!--Аппендеры --&gt;</span>
    <span class="c">&lt;!--Файловый appender --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"file"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.FileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;file&gt;</span>log.log<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;layout</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.PatternLayout"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Pattern&gt;</span>%date %level [%thread] %logger{10} [%file:%line] %msg%n<span class="nt">&lt;/Pattern&gt;</span>
        <span class="nt">&lt;/layout&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="c">&lt;!--Консольный appender --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"sout"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;layout</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.PatternLayout"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Pattern&gt;</span>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="nt">&lt;/Pattern&gt;</span>
        <span class="nt">&lt;/layout&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="c">&lt;!-- Фильтры --&gt;</span>
    <span class="c">&lt;!-- Фильтр по маркеру --&gt;</span>
    <span class="nt">&lt;turboFilter</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.turbo.MarkerFilter"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Marker&gt;</span>marker<span class="nt">&lt;/Marker&gt;</span>
        <span class="nt">&lt;OnMatch&gt;</span>DENY<span class="nt">&lt;/OnMatch&gt;</span>
    <span class="nt">&lt;/turboFilter&gt;</span>
    <span class="c">&lt;!-- Loggers --&gt;</span>
    <span class="c">&lt;!-- Корневой logger --&gt;</span>
    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"info"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"file"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
    <span class="c">&lt;!-- Logger нашего класса --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"logging.logback.LoggingLogback"</span> <span class="na">level=</span><span class="s">"info"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"sout"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_slf4j">SLF4J</h5>
<div class="paragraph">
<p><strong>SLF4J</strong> является оберткой над <strong>logback</strong>, а также над <strong>JUL</strong>, <strong>log4j</strong>, или <strong>JCL</strong>, а также над любым logger, который реализует ее интерфейс. Для работы с <strong>SLF4J</strong> нужны библиотека <code>slf4j-api-1.x.x</code> и реализация одного из loggers либо заглушка. Как правило, реализации всех loggers (кроме <strong>logback</strong>) поставляются вместе с SLF4J и имеют названия на подобии <code>slf4j-jcl-1.x</code>, <code>slf4j-log4j12-1.x</code>, <code>slf4j-nop-1.x</code> и т.п. Если в <strong>classpath</strong> не будет найдена реализация logger (или заглушка <strong>nop</strong>) <strong>SLF4J</strong> гневно ругнется и работать откажется. Конфигурация соответственно будет искаться в зависимости от положенной в <strong>classpath</strong> реализации.</p>
</div>
<div class="paragraph">
<p>Вся обертка делится на две части:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>API</strong><br>
Используется приложениями</p>
</li>
<li>
<p><strong>Реализация logger</strong>
Представлена отдельными jar-файлами для каждого вида логирования. Такие реализации для <strong>slf4j</strong> называются <strong>binding</strong>. Например, <code>slf4j-log4j12</code> или <code>logback-classic</code>. Достаточно только положить в <strong>CLASSPATH</strong> нужный <strong>binding</strong> и весь код проекта и все используемые библиотеки (при условии, что они обращаются к <strong>SLF4J</strong>) будут выполнять logging в нужном направлении.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>API SLF4J</strong> было рассмотрено в реализации <strong>logback</strong>.</p>
</div>
<div class="paragraph">
<p>Чтобы использовать <strong>SLF4J</strong> вместе с <strong>log4j 2</strong> необходимо подключить зависимость:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.7<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.7<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-slf4j-impl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.7<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_links_4">5.3.7. Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://javarush.ru/groups/posts/2388-logirovanie-chto-kak-gde-i-chem">Логирование: что, как, где и чем?</a></p>
</li>
<li>
<p><a href="https://javarush.ru/groups/posts/2293-zachem-nuzhno-logirovanie">Зачем нужно логирование</a></p>
</li>
<li>
<p><a href="https://javarush.ru/quests/lectures/questcollections.level04.lecture09">Logger</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/113145/">Java Logging: история кошмара</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/247647/">Java logging. Hello World</a></p>
</li>
<li>
<p><a href="https://github.com/qcha/JBook/blob/master/other/logging.md">Логирование в Java</a></p>
</li>
<li>
<p><a href="https://codernet.ru/articles/drugoe/logirovanie_java_terminologiya_urovni_logirovaniya_log-fajlyi/">Логирование Java: терминология, уровни логирования, log-файлы</a></p>
</li>
<li>
<p><a href="https://coderlessons.com/tutorials/java-tekhnologii/vyuchi-slf4j/slf4j-kratkoe-rukovodstvo">SLF4J — Краткое руководство</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=j-i3NQiKbcc&amp;t=2052s&amp;ab_channel=JUG.ru">Владимир Красильщик — Что надо знать о логировании прагматичному Java-программисту</a></p>
</li>
<li>
<p><a href="http://logging.apache.org/log4j/2.x/">Apache Log4j 2</a></p>
</li>
<li>
<p><a href="http://logback.qos.ch/">Logback</a></p>
</li>
<li>
<p><a href="http://www.slf4j.org//">Simple Logging Facade for Java (SLF4J)</a></p>
</li>
<li>
<p><a href="http://skipy.ru/useful/logging.html#log4j_fa">Ведение лога приложения</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_orm_на_примере_hibernate">6. ORM (на примере Hibernate)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_orm_на_примере_hibernate_2">6.1. ORM (на примере Hibernate)</h3>
<div class="sect3">
<h4 id="_основные_понятия_jpa_и_orm">6.1.1. Основные понятия JPA и ORM</h4>
<div class="paragraph">
<p><strong>Java Persistence API</strong> (<strong>JPA</strong>) — спецификация, предоставляет возможность сохранять в удобном виде объекты в базе данных. <strong>JPA</strong> описывает систему управления сохранением объектов в таблицы реляционных баз данных в удобном виде. <strong>JPA</strong> реализует концепцию <strong>ORM</strong>.</p>
</div>
<div class="paragraph">
<p><strong>ORM</strong> — <strong>Object-Relational Mapping</strong> (<strong>объектно-реляционное отображение</strong>). Это технология программирования, которая связывает базы данных с концепциями объектно-ориентированных языков программирования. Если упростить, то <strong>ORM</strong> это связь объектов в <strong>Java</strong> и записей в базе данных. Самой популярной на данный момент такой системой является <strong>Hibernate</strong>. Так же к ним можно отнести такие программы как <strong>EclipseLink</strong>, <strong>Toplink</strong>, их ещё называют <strong>JPA-провайдерами</strong>.</p>
</div>
<div class="paragraph">
<p>Непосредственно <strong>JPA</strong> представлен в пакете <code>javax.persistence</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_datasource">6.1.2. <code>DataSource</code></h4>
<div class="paragraph">
<p><code>DataSource</code> — используется для создания соединения с базой данных. Это альтернатива <code>DriverManager</code> используемого в <code>JDBC</code>. В документации сказано, что <code>DataSource</code> использовать предпочтительнее. В частности, одним из преимуществ <code>DataSource</code> является возможность создания пула соединений <strong>Database Connection Pool</strong> (<strong>DBCP</strong>).</p>
</div>
<div class="paragraph">
<p>Существует много библиотек, которые выступают как <code>DataSource</code>. Например, такие, как:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Hikari</strong> – это реализация <code>DataSource</code>, которая обеспечивает механизм пула соединений. По сравнению с другими реализациями, он обещает быть легким и более производительным. Является самой популярной библиотекой для пула соединений.</p>
</li>
<li>
<p><strong>Tomcat jdbc pool</strong> - это реализация <code>DataSource</code> из пакета <code>tomcat-jdbc</code>. Является достаточно производительной.</p>
</li>
<li>
<p><strong>DBCP</strong> и <strong>C3P0</strong> - устаревшие реализации <code>DataSource</code>, являются однопоточными и очень непроизводительными.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_entity">6.1.3. Entity</h4>
<div class="paragraph">
<p><code>Entity</code> - это легковесный хранимый объект бизнес логики (<strong>persistent domain object</strong>), является основной программной сущностью.</p>
</div>
<div class="paragraph">
<p>Главная аннотация <code>@Entity</code> позволяет объектам класса быть связанными с базой данных. Чтобы класс мог быть сущностью, к нему предъявляются следующие требования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Entity</code> класс должен быть отмечен аннотацией <code>Entity</code> или описан в <code>XML</code> файле конфигурации <strong>JPA</strong>.</p>
</li>
<li>
<p><code>Entity</code> класс должен содержать <code>public</code> или <code>protected</code> конструктор без аргументов (он также может иметь конструкторы с аргументами).</p>
</li>
<li>
<p><code>Entity</code> класс должен быть классом верхнего уровня.</p>
</li>
<li>
<p><code>Entity</code> класс не может быть enum или интерфейсом.</p>
</li>
<li>
<p><code>Entity</code> класс не может быть финальным классом.</p>
</li>
<li>
<p><code>Entity</code> класс не может содержать <strong>final</strong> поля или методы, если они участвуют в mapping.</p>
</li>
<li>
<p>Если объект <code>Entity</code> класса будет передаваться по значению как отдельный объект, например через удаленный интерфейс он так же должен реализовывать <code>Serializable</code> интерфейс.</p>
</li>
<li>
<p>Поля <code>Entity</code> класс должны быть напрямую доступны только методам самого <code>Entity</code> класса и не должны быть напрямую доступны другим классам, использующим этот <code>Entity</code>.</p>
</li>
<li>
<p><code>Entity</code> класс должен содержать первичный ключ, то есть атрибут или группу атрибутов которые уникально определяют запись этого <code>Entity</code> класса в базе данных.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_типы_ассоциаций_между_entity">6.1.4. Типы ассоциаций между Entity</h4>
<div class="paragraph">
<p>Существуют следующие типы ассоциаций:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@OneToOne</code> - используется тогда, когда сущность одной таблицы связанная с одной сущностью другой таблицы.</p>
</li>
<li>
<p><code>@OneToMany</code> - используется тогда, когда сущность одной таблицы связанная с несколькими сущностями другой таблицы.</p>
</li>
<li>
<p><code>@ManyToOne</code> - используется тогда, когда сущности одной таблицы связанны с одной сущностью другой таблицы.</p>
</li>
<li>
<p><code>@ManyToMany</code> - используется тогда, когда сущности одной таблицы связанны с несколькими сущностями другой таблицы.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_onetoone"><code>@OneToOne</code></h5>
<div class="paragraph">
<p>Для того чтобы связать сущности отношением один-к-одному, используется аннотация <code>@OneToOne</code>. В целом, может быть 3 варианта ее использования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Связанные сущности используют одно и то же значение первичного ключа.</p>
</li>
<li>
<p>Внешний ключ определяется полем одной из сущностей (это поле в базе данных должно быть уникальным для имитации отношения один-к-одному).</p>
</li>
<li>
<p>Используется таблица для хранения ссылки между двумя сущностями (ограничение уникальности должно быть установлено на каждом из полей для того, чтобы соответствовать кратности один-к-одному).</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_связанные_сущности_используют_одно_и_то_же_значение_первичного_ключа">Связанные сущности используют одно и то же значение первичного ключа</h6>
<div class="listingblock">
<div class="title">Сущность User</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"users"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="c1">// Поля общие для всех пользователей</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Сущность Partner</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"partners"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Partner</span> <span class="o">{</span>
    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="nd">@PrimaryKeyJoinColumn</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span>

    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="c1">// Поля данных партнеров системы</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Аннотация <code>@PrimaryKeyJoinColumn</code> указывает на то, что первичный ключ сущности <code>Partner</code> используется в качестве внешнего ключа для связи с сущностью <code>User</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_связь_один_к_одному_с_использованием_явного_внешнего_ключа">Связь один-к-одному с использованием явного внешнего ключа</h6>
<div class="listingblock">
<div class="title">Сущность User</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"users"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"passport_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Passport</span> <span class="n">passport</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Связь в базе данных между таблицами <code>users</code> и <code>passports</code> осуществляется посредством поля <code>passport_id</code> в таблице <code>users</code>. Связанное поле в <code>User</code> объявлено с помощью аннотации <code>@JoinColumn</code>, ее параметр обозначает поле в базе данных, которое будет использоваться для создания связи.</p>
</div>
<div class="paragraph">
<p>Связь один-к-одному может быть <strong>двунаправленной</strong>. В двунаправленных отношениях одна из сторон (и только одна) должна быть владельцем и нести ответственность за обновление связанных полей. В случае когда владельцем выступает сущность <code>User</code>. Для того чтобы объявить сторону, которая не несет ответственности за отношения, используется атрибут <code>mappedBy</code>. Он ссылается на имя свойства связи на стороне владельца (<code>passport</code>).</p>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Passport</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"passports"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Passport</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"passport"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Двунаправленное отношение</strong> не создает дополнительного внешнего ключа. Фактически, двунаправленная связь никак не влияет на то, как таблицы связаны друг с другом в базе данных. Просто она позволяет работать с сущностями в обоих направлениях, все также используя единственный внешний ключ. В случае, если на стороне владельца нет связанного поля <code>@JoinColumn</code>, то выполнятся следующие умолчания: в таблице владельца будет создано поле для связи, имя которого собирается из имени связи на стороне владельца, нижнего подчеркивания и имени уникального ключа на зависящей стороне.</p>
</div>
<div class="paragraph">
<p>Преимуществом однонаправленной связи, является то, что ею легче управлять, потому что необходимо поддерживать только одну сторону. Преимущество же двунаправленной связи заключается в возможности доступа между связанными сущностями в обоих направлениях. Но обычно это приводит к формированию лишних запросов к базе данных, поэтому использовать двунаправленные связи необходимо осторожно.</p>
</div>
</div>
<div class="sect5">
<h6 id="_связь_один_к_одному_с_использованием_таблицы_отношений">Связь один-к-одному с использованием таблицы отношений</h6>
<div class="listingblock">
<div class="title">Сущность <code>User</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"users"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"user_passport"</span><span class="o">,</span>
        <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"user_id"</span><span class="o">),</span>
        <span class="n">inverseJoinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"passport_id"</span><span class="o">)</span>
    <span class="o">)</span>

    <span class="kd">private</span> <span class="nc">Passport</span> <span class="n">passport</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Passport</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"passports"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Passport</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"passport"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В базе данных таблица <code>users</code> связана с <code>passports</code> с помощью таблицы отношений <code>user_passport</code>. Эта таблица содержит внешний ключ <code>user_id</code>, указывающий на таблицу <code>users</code> и внешний ключ <code>passport_id</code>, указывающий на <code>passports</code>. <code>@JoinTable</code> позволяет избежать создания отдельной сущности для таблицы отношений <code>user_passport</code>, и непосредственно связать сущности <code>User</code> и <code>Password</code> между собой. Связь может быть двунаправленной точно так же, как в случае с использованием явного внешнего ключа.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_onetomany_и_manytoone"><code>@OneToMany</code> и <code>@ManyToOne</code></h5>
<div class="paragraph">
<p><code>@OneToMany</code> — случай, когда у одного автора может быть несколько книг.</p>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Author</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Data</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"first_name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"last_name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book_id"</span><span class="o">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Оно уже является сетом, так как у автора может быть несколько книг. <code>@OneToMany</code> говорит о типе отношения. <code>FetchType.LAZY</code> говорит, что не нужно подгружать весь список книг, если это не указанно в запросе.</p>
</div>
<div class="paragraph">
<p>В классе <code>Book</code> устанавливаем обратную связь <code>@ManyToOne</code>:</p>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Book</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Data</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"print_year"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">printYear</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author_id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Author</span> <span class="n">author</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_manytomany"><code>@ManyToMany</code></h5>
<div class="paragraph">
<p>Такая зависимость реализовывается через создание дополнительной таблицы. Допустим ситуацию, когда у нескольких книг может быть несколько авторов, а у авторов – несколько книг.</p>
</div>
<div class="listingblock">
<div class="title">Сущность Author</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Data</span>
<span class="nd">@ToString</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="s">"books"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"first_name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"second_name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">secondName</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span>
    <span class="nd">@JoinTable</span><span class="o">(</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">"author_book_link"</span><span class="o">,</span>
            <span class="n">joinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author_id"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">),</span>
            <span class="n">inverseJoinColumns</span> <span class="o">=</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book_id"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">books</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Для связи сущностей создаётся таблица <code>author_book_link</code>.</p>
</div>
<div class="paragraph">
<p><code>@JoinTable</code> — будет связывать атрибут с дополнительной таблицей <code>author_book_link</code>. В ней указываются два атрибута, которые будут указывать на <strong>primary keys</strong> двух сущностей.</p>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Book</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Data</span>
<span class="nd">@ToString</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="s">"authors"</span><span class="o">)</span>
<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"book"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"print_year"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">printYear</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"books"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Author</span><span class="o">&gt;</span> <span class="n">authors</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_стратегии_генерации_первичного_ключа">6.1.5. Стратегии генерации первичного ключа</h4>
<div class="paragraph">
<p>Один из главных требований к <code>Entity</code> является наличие первичного ключа. В <strong>JPA</strong> на этот случай предусмотрены механизмы автоматической генерации значений суррогатных ключей, которые включаются аннотацией <code>@GeneratedValue</code>.</p>
</div>
<div class="paragraph">
<p><strong>JPA</strong> поддерживает четыре стратегии генерации ключа:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GenerationType.IDENTITY</code></p>
</li>
<li>
<p><code>GenerationType.SEQUENCE</code></p>
</li>
<li>
<p><code>GenerationType.TABLE</code></p>
</li>
<li>
<p><code>GenerationType.AUTO</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_стратегия_generationtype_identity">Стратегия <code>GenerationType.IDENTITY</code></h5>
<div class="paragraph">
<p>Такая стратегия работает с базами, у которых есть специальные <code>IDENTITY</code> поля, например с <strong>MySQL</strong> или <strong>DB2</strong>. В таких базах данных возможно создавать первичный ключ с автоматическим инкрементом.</p>
</div>
<div class="listingblock">
<div class="title">Создание таблицы с первичным ключом</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">journal</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">BIGINT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTO_INCREMENT</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_стратегия_generationtype_sequence">Стратегия <code>GenerationType.SEQUENCE</code></h5>
<div class="paragraph">
<p>Такая стратегия использует встроенный в базы данных, такие как <strong>PostgreSQL</strong> или <strong>Oracle</strong>, механизм генерации последовательных значений. Использование этого генератора требует как создания отдельной <strong>sequence</strong> в базе данных:</p>
</div>
<div class="listingblock">
<div class="title">Создание таблицы с первичным ключом</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">journal</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">BIGINT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Создание последовательности</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="n">SEQUENCE</span> <span class="n">book_sequence</span> <span class="k">START</span> <span class="k">WITH</span> <span class="mi">1</span> <span class="k">INCREMENT</span> <span class="k">BY</span> <span class="mi">1</span> <span class="n">NOCACHE</span> <span class="n">NOCYCLE</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Так и задания имени этой последовательности в описании ключа:</p>
</div>
<div class="listingblock">
<div class="title">Создание последовательности</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ExampleEntity</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@SequenceGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"bookSequence"</span><span class="o">,</span> <span class="n">sequenceName</span> <span class="o">=</span> <span class="s">"book_sequence"</span><span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="s">"bookSequence"</span><span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">rowId</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_стратегия_generationtype_table">Стратегия <code>GenerationType.TABLE</code></h5>
<div class="paragraph">
<p>Такая стратегия не зависит от поддержки конкретной базой данных и хранит счётчики значений в отдельной таблице. С одной стороны это более гибкое и настраиваемое решение, с другой стороны более медленное и требующее большей настройки. Вначале требуется создать и проинициализировать таблицу для значений ключей:</p>
</div>
<div class="listingblock">
<div class="title">Создание таблицы для сохранения ключей</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sequence_store</span> <span class="p">(</span>
    <span class="n">sequence_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">sequence_value</span> <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Entity реализующая стратегию <code>GenerationType.TABLE</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ExampleEntity</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@TableGenerator</span><span class="o">(</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">"seqStore"</span><span class="o">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s">"sequence_store"</span><span class="o">,</span>
            <span class="n">pkColumnName</span> <span class="o">=</span> <span class="s">"sequence_name"</span><span class="o">,</span> <span class="n">pkColumnValue</span> <span class="o">=</span> <span class="s">"journal.id.pk"</span><span class="o">,</span>
            <span class="n">valueColumnName</span> <span class="o">=</span> <span class="s">"sequence_value"</span><span class="o">,</span> <span class="n">initialValue</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">allocationSize</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="o">)</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">TABLE</span><span class="o">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="s">"seqStore"</span> <span class="o">)</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">rowId</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_стратегия_generationtype_auto">Стратегия <code>GenerationType.AUTO</code></h5>
<div class="paragraph">
<p>Позволяет автоматически выбрать стратегию в соответствии с используемой базой данных.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fetch_strategies">6.1.6. Fetch strategies</h4>
<div class="paragraph">
<p>В <strong>JPA</strong> описаны два типа <strong>Fetch strategies</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LAZY</code> — данные поля будут загружены только во время первого обращения к этому полю.</p>
</li>
<li>
<p><code>EAGER</code> — данные поля будут загружены сразу, при инициализации корневой сущности.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Каждый тип связи имеет свою <strong>Fetch strategy</strong>` по умолчанию:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@OneToMany</code>: <code>LAZY</code></p>
</li>
<li>
<p><code>@ManyToOne</code>: <code>EAGER</code></p>
</li>
<li>
<p><code>@ManyToMany</code>: <code>LAZY</code></p>
</li>
<li>
<p><code>@OneToOne</code>: <code>EAGER</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>В <strong>JPA</strong> есть два типа загрузки <code>FetchType</code>: <code>EAGER</code> and <code>LAZY</code>. <code>FetchType.EAGER</code> загрузка заставляет <strong>ORM</strong> загружать связанные сущности и коллекции сразу, вместе с корневой сущностью. <code>FetchType.LAZY</code> загрузка означает, что <strong>ORM</strong> загрузит сущность или коллекцию отложено, при первом обращении к ней из кода.</p>
</div>
<div class="paragraph">
<p><code>FetchType</code> в <strong>JPA</strong> говорит когда связанная сущность или коллекция будет загружена. По умолчанию <strong>JPA</strong> провайдер загружает связанные коллекции (отношения один-ко-многим и многие-ко-многим) отложено. В большинстве случаев отложенная загрузка — оптимальный вариант. Нет смысла инициализировать все связанные коллекции, если к ним не будет обращений.</p>
</div>
<div class="sect4">
<h5 id="_каскадные_типы">Каскадные типы</h5>
<div class="paragraph">
<p><strong>Каскадирование</strong> — это стратегия работы со связанными объектами, т.е. когда выполняется какое-либо действие над целевым объектом, то же самое действие будет применено к связанному объекту. Все каскадные операции:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Каскадные операции</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Параметр</th>
<th class="tableblock halign-left valign-top">Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CascadeType.PERSIST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">При сохранении экземпляра сущности с помощью метода <code>persist()</code> любой связанный экземпляр сущности также перейдёт в хранимое состояние.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CascadeType.REMOVE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">При удалении экземпляра сущности с помощью метода <code>remove()</code> любой связанный экземпляр сущности также будет удален.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CascadeType.DETACH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">При отсоединении экземпляра сущности от контекста хранения с помощью <code>detach()</code> любой ассоциированный экземпляр сущности также будет отсоединен.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CascadeType.MERGE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">При слиянии временной или отсоединенной сущности с <strong>persistence context</strong> с помощью <code>merge()</code> для любого связанного временного или отсоединенного экземпляра сущности также будет выполнено слияние.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CascadeType.REFRESH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">При изменении экземпляра сущности с помощью <code>refresh()</code> любой связанный экземпляр сущности также будет изменен.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CascadeType.ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Сокращенная запись для применения всех способов каскадирования.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_состояния_сущности">6.1.7. Состояния сущности</h4>
<div class="paragraph">
<p>Сущности могут находиться в следующих состояниях:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>transient</strong> — объект создан, но при этом ещё не имеет сгенерированных первичных ключей и пока ещё не сохранен в базе данных.</p>
</li>
<li>
<p><strong>managed</strong> — объект создан, управляется <strong>JPA</strong>, имеет сгенерированные первичные ключи.</p>
</li>
<li>
<p><strong>detached</strong> — объект был создан, но не управляется (или больше не управляется) <strong>JPA</strong>.</p>
</li>
<li>
<p><strong>removed</strong> — объект создан, управляется <strong>JPA</strong>, но будет удален после завершения транзакции.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим как операция <code>persist()</code> на <code>Entity</code> объекты каждого из четырех статусов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Если статус у сущности <strong>transient</strong>, то он меняется на <strong>managed</strong>, и объект будет сохранен в базу при завершении транзакции или в результате <code>flush()</code> операций.</p>
</li>
<li>
<p>Если статус уже <strong>managed</strong>, операция игнорируется, однако зависимые <code>Entity</code> могут поменять статус на <strong>managed</strong>, если у них есть аннотации каскадных изменений.</p>
</li>
<li>
<p>Если статус <strong>removed</strong>, то он меняется на <strong>managed</strong>.</p>
</li>
<li>
<p>Если статус <strong>detached</strong>, будет выкинут Exception сразу или на этапе завершении транзакции.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим как операция <code>remove()</code> на <code>Entity</code> объекты каждого из четырех статусов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Если статус <strong>transient</strong>, операция игнорируется, однако зависимые <code>Entity</code> могут поменять статус на <strong>removed</strong>, если у них есть аннотации каскадных изменений и они имели статус <strong>managed</strong>.</p>
</li>
<li>
<p>Если статус <strong>managed</strong>, то статус меняется на <strong>removed</strong> и запись объект в базе данных будет удалена при завершении транзакции (так же произойдут операции <code>remove</code> для всех каскадно зависимых объектов).</p>
</li>
<li>
<p>Если статус <strong>removed</strong>, то операция игнорируется.</p>
</li>
<li>
<p>Если статус <strong>detached</strong>, будет выкинут Exception сразу или на этапе завершения транзакции.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим как операция <code>merge()</code> на <code>Entity</code> объекты каждого из четырех статусов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Если статус у сущности <strong>detached</strong>, то либо данные будет скопированы в существующей <strong>managed</strong> <code>entity</code> с тем же первичным ключом, либо создан новый <strong>managed</strong> в который скопируются данные.</p>
</li>
<li>
<p>Если статус <strong>transient</strong>, то будет создана новый <strong>managed</strong> <code>entity</code>, в который будут скопированы данные прошлого объекта.</p>
</li>
<li>
<p>Если статус <strong>managed</strong>, операция игнорируется, однако операция <code>merge()</code> сработает на каскадно зависимые <code>Entity</code>, если их статус не <strong>managed</strong>.</p>
</li>
<li>
<p>Если статус <strong>removed</strong>, будет выкинута ошибка сразу или на этапе завершения транзакции.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим как операция <code>refresh()</code> на <code>Entity</code> объекты каждого из четырех статусов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Если статус у сущности <strong>managed</strong>, то в результате операции будут восстановлены все изменения из базы данных данного <code>Entity</code>, так же произойдет <code>refresh()</code> всех каскадно зависимых объектов.</p>
</li>
<li>
<p>Если статус <strong>transient</strong>, <strong>removed</strong> или <strong>detached</strong>, будет выброшен Exception.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим как операция <code>detach()</code> на <code>Entity</code> объекты каждого из четырех статусов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Если статус у сущности <strong>managed</strong> или <strong>removed</strong>, то в результате операции статус <code>Entity</code> (и всех каскадно-зависимых объектов) станет <strong>detached</strong>.</p>
</li>
<li>
<p>Если статус <strong>transient</strong> или `<strong>detached</strong>, то операция игнорируется.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_удаление_сирот">6.1.8. Удаление сирот</h4>
<div class="paragraph">
<p>Рассмотрим настройку <code>orphanRemoval</code>, которая касается удаления элементов из коллекции. У нас это будет удаление комментария из списка комментариев топика.</p>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Comment</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Comment</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Topic</span> <span class="n">topic</span><span class="o">;</span>

    <span class="c1">// getters/setters/constructors</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Сущность <code>Topic</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topic</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">SEQUENCE</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"topic"</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="nc">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="n">comments</span><span class="o">=</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addComment</span><span class="o">(</span><span class="nc">Comment</span> <span class="n">comment</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">comments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">comment</span><span class="o">);</span>
        <span class="n">comment</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeComment</span><span class="o">(</span><span class="nc">Comment</span> <span class="n">comment</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">comments</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">comment</span><span class="o">);</span>
        <span class="n">comment</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// getters/setters/constructors</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Следует обратить внимание на метод <code>removeComment()</code>, он удаляет комментарий из коллекции и устанавливает его полю <code>topic</code> значение <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Чтобы понять смысл настройки <code>orphanRemoval</code>, надо представить, что теоретически может подразумеваться под удалением комментария из списка комментариев топика. Очевидно это означает, что у данного топика больше нет комментария.</p>
</div>
<div class="paragraph">
<p>Но остается ли он вообще в базе, то есть можно ли его вывести в общем списке комментариев всех топиков? Или же удаляется из базы? За эти два варианта и отвечает <code>orphanRemoval</code>.</p>
</div>
<div class="sect4">
<h5 id="_orphanremoval_равен_true"><code>orphanRemoval</code> равен <code>true</code></h5>
<div class="paragraph">
<p>Если <code>orphanRemoval</code> равен <code>true</code>, то при удалении комментария из списка комментариев топика, он удаляется из базы. Проверим это в тесте:</p>
</div>
<div class="listingblock">
<div class="title">Метод для тестирования работы <code>orphanRemoval = true</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">RemoveTests</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"если orphanRemoval=true, то при удалении комментария из топика он удаляется из базы"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">givenOrphanRemovalTrue_whenRemoveCommentFromTopic_thenItRemovedFromDatabase</span><span class="o">()</span> <span class="o">{</span>
       <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">topicRepository</span><span class="o">.</span><span class="na">getById</span><span class="o">(-</span><span class="mi">1L</span><span class="o">);</span>
       <span class="n">topic</span><span class="o">.</span><span class="na">removeComment</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getComments</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
       <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">commentRepository</span><span class="o">.</span><span class="na">count</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Генерируются следующие команды:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">topic0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_1_0_</span><span class="p">,</span> <span class="n">comments1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_1_</span><span class="p">,</span>
       <span class="n">topic0_</span><span class="p">.</span><span class="n">title</span> <span class="k">as</span> <span class="n">title2_1_0_</span><span class="p">,</span>
       <span class="n">comments1_</span><span class="p">.</span><span class="nb">text</span> <span class="k">as</span> <span class="n">text2_0_1_</span><span class="p">,</span> <span class="n">comments1_</span><span class="p">.</span><span class="n">topic_id</span> <span class="k">as</span> <span class="n">topic_id3_0_1_</span><span class="p">,</span>
       <span class="n">comments1_</span><span class="p">.</span><span class="n">topic_id</span> <span class="k">as</span> <span class="n">topic_id3_0_0__</span><span class="p">,</span> <span class="n">comments1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_0__</span>
<span class="k">from</span> <span class="n">topic</span> <span class="n">topic0_</span> <span class="k">inner</span> <span class="k">join</span> <span class="k">comment</span> <span class="n">comments1_</span>
<span class="k">on</span> <span class="n">topic0_</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">comments1_</span><span class="p">.</span><span class="n">topic_id</span>
<span class="k">where</span> <span class="n">topic0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span>

<span class="k">delete</span> <span class="k">from</span> <span class="k">comment</span> <span class="k">where</span> <span class="n">id</span><span class="o">=?</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Можно заметить оператор <code>delete</code>, он и удаляет комментарий из базы.</p>
</div>
</div>
<div class="sect4">
<h5 id="_orphanremoval_равен_false"><code>orphanRemoval</code> равен <code>false</code></h5>
<div class="paragraph">
<p>Если <code>orphanRemoval</code> равен <code>false</code>, то при удалении комментария из списка, в базе комментарий остается. Его внешний ключ обнуляется, и  больше комментарий не ссылается на <code>Topic</code>.</p>
</div>
<div class="paragraph">
<p>Проверим это:</p>
</div>
<div class="listingblock">
<div class="title">Метод для тестирования работы <code>orphanRemoval = false</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">RemoveTests</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"если orphanRemoval = false, то при удалении комментария из топика остается в базе"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">givenOrphanRemovalFalse_whenRemoveCommentFromTopic_thenItRemovedFromDatabase</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">topicRepository</span><span class="o">.</span><span class="na">getById</span><span class="o">(-</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">topic</span><span class="o">.</span><span class="na">removeComment</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getComments</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">commentRepository</span><span class="o">.</span><span class="na">count</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Генерируются следующие команды:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">select</span> <span class="n">topic0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_1_0_</span><span class="p">,</span> <span class="n">comments1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_1_</span><span class="p">,</span>
       <span class="n">topic0_</span><span class="p">.</span><span class="n">title</span> <span class="k">as</span> <span class="n">title2_1_0_</span><span class="p">,</span> <span class="n">comments1_</span><span class="p">.</span><span class="nb">text</span> <span class="k">as</span> <span class="n">text2_0_1_</span><span class="p">,</span>
       <span class="n">comments1_</span><span class="p">.</span><span class="n">topic_id</span> <span class="k">as</span> <span class="n">topic_id3_0_1_</span><span class="p">,</span> <span class="n">comments1_</span><span class="p">.</span><span class="n">topic_id</span> <span class="k">as</span> <span class="n">topic_id3_0_0__</span><span class="p">,</span>
       <span class="n">comments1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_0__</span>
<span class="k">from</span> <span class="n">topic</span> <span class="n">topic0_</span> <span class="k">inner</span> <span class="k">join</span> <span class="k">comment</span> <span class="n">comments1_</span>
<span class="k">on</span> <span class="n">topic0_</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">comments1_</span><span class="p">.</span><span class="n">topic_id</span>
<span class="k">where</span> <span class="n">topic0_</span><span class="p">.</span><span class="n">id</span><span class="o">=?</span>

<span class="k">update</span> <span class="k">comment</span> <span class="k">set</span> <span class="nb">text</span><span class="o">=?</span><span class="p">,</span> <span class="n">topic_id</span><span class="o">=?</span> <span class="k">where</span> <span class="n">id</span><span class="o">=?</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь происходит обновление таблицы <code>comment</code>: столбцу <code>topic_id</code> присваивается значение <code>NULL</code>. Комментарий остается в базе, просто ни на какой <code>Topic</code> он больше не ссылается. В свою очередь оператор <code>delete</code> отсутствует.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hibernate_cache">6.2. Hibernate cache</h3>
<div class="paragraph">
<p><strong>Кэш</strong> - это память с большей скоростью доступа, предназначенная для ускорения обращения к данным, содержащимся постоянно в памяти с меньшей скоростью доступа. Кэширование применяется <strong>ЦПУ</strong>, <strong>жёсткими дисками</strong>, <strong>браузерами</strong>, <strong>веб-серверами</strong>, <strong>службами DNS</strong> и <strong>WINS</strong>.</p>
</div>
<div class="paragraph">
<p>Кэш состоит из набора записей. Каждая запись ассоциирована с элементом данных или блоком данных (небольшой части данных), которая является копией элемента данных в основной памяти. Каждая запись имеет идентификатор, часто называемый тегом, определяющий соответствие между элементами данных в кэше и их копиями в основной памяти.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/data-persistence/hibernate-cache/cache.png" alt="cache"></span></p>
</div>
<div class="paragraph">
<p>Когда клиент кэша (<strong>ЦПУ</strong>, <strong>веб-браузер</strong>, <strong>операционная система</strong>) обращается к данным, прежде всего исследуется кэш. Если в кэше найдена запись с идентификатором, совпадающим с идентификатором затребованного элемента данных, то используются элементы данных в кэше. Такой случай называется <strong>попаданием кэша</strong>. Если в кэше не найдена запись, содержащая затребованный элемент данных, то он читается из основной памяти в кэш, и становится доступным для последующих обращений. Такой случай называется <strong>промахом кэша</strong>.</p>
</div>
<div class="paragraph">
<p>Кеширование является одним из способов оптимизации работы приложения, ключевой задачей которого является уменьшить количество прямых обращений к базе данных.</p>
</div>
<div class="paragraph">
<p>Кэширование, как правило, есть смысл применять в больших, высоконагруженных проектах, с десятками тысяч запросов в минуту. В таких проектах, чтобы не перегружать базу, как правило, кэшируют обращения к репозиторию. Особенно если известно, что данные из какой-нибудь мастер-системы обновляются с некоторой периодичностью. Если же проект маленький и перегрузки ему не грозят, тогда, конечно, лучше ничего не кэшировать — всегда свежие данные всегда лучше периодически обновляемых.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/data-persistence/hibernate-cache/app-hibernate-db.png" alt="app hibernate db"></span></p>
</div>
<div class="paragraph">
<p>В <strong>Hibernate</strong> имеется 3 вида кеширования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>First-level cache</strong> (<strong>Кеш первого уровня</strong>);</p>
</li>
<li>
<p><strong>Second-level cache</strong> (<strong>Кеш второго уровня</strong>);</p>
</li>
<li>
<p><strong>Query cache</strong> (<strong>Кеш запросов</strong>);</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../assets/img/java/data-persistence/hibernate-cache/hibernate-first-and-second-level-cache.jpg" alt="hibernate first and second level cache"></span></p>
</div>
<div class="sect3">
<h4 id="_кеш_первого_уровня">6.2.1. Кеш первого уровня</h4>
<div class="paragraph">
<p>В <strong>Hibernate</strong> <strong>кэш первого уровня</strong> представлен интерфейсом <code>Session</code>, который является расширением к <strong>JPA</strong> <code>EntityManager</code>. В терминологии <strong>JPA</strong> <strong>кэш первого уровня</strong> называется <strong>Persistence Context</strong>, и он представлен интерфейсом <code>EntityManager</code>.</p>
</div>
<div class="paragraph">
<p><strong>Кеш первого уровня</strong> всегда привязан к объекту <code>Session</code>. <strong>Hibernate</strong> по умолчанию использует этот кеш и его нельзя отключить.</p>
</div>
<div class="paragraph">
<p>В <strong>JPA</strong> и <strong>Hibernate</strong> <strong>кэш первого уровня</strong> - это <strong>Java Map</strong>, в котором <strong>ключ</strong> представлен объектом, инкапсулирующим имя сущности и ее идентификатор, а <strong>значение</strong> - это сам объект сущности. Поэтому в <strong>JPA</strong> <code>EntityManager</code> или <strong>Hibernate</strong> <code>Session</code> может быть только одна сущность, хранящаяся с использованием одного и того же идентификатора и типа класса сущности. Причина, по которой невозможно иметь не более одного представления сущности, хранящегося в <strong>кэше первого уровня</strong>, заключается в том, что в противном случае мы можем получить различные отображения одной и той же строки базы данных, не зная, какая из них является правильной версией, синхронизируемой с соответствующей записью базы данных.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
<span class="nc">Pet</span> <span class="n">pet</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pet</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="n">pet</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pet</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В примере выше будет выполнен 1 запрос в базу, несмотря на то, что делается 2 вызова <code>load()</code>, так как эти вызовы происходят в контексте одной сессии. Во время второй попытки загрузить план с тем же идентификатором будет использован кеш сессии.</p>
</div>
<div class="paragraph">
<p>Сначала <strong>Hibernate</strong> проверяет, хранится ли сущность в <strong>кэше первого уровня</strong>, и если да, то возвращается текущая управляемая ссылка на нее. Если сущность не найдена в <strong>кэше первого уровня</strong>, то <strong>Hibernate</strong> загрузит ее из базы данных с помощью <strong>SQL</strong>-запроса.</p>
</div>
<div class="paragraph">
<p>При использовании методов <code>save()</code>, <code>update()</code>, <code>saveOrUpdate()</code>, <code>load()</code>, <code>get()</code>, <code>list()</code>, <code>iterate()</code>, <code>scroll()</code> всегда будет задействован <strong>кеш первого уровня</strong>.</p>
</div>
<div class="paragraph">
<p>Для работы с данными кеша в сессии имеются следующие методы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>flush()</code> — обновляет объекты кеша с базой данных.</p>
</li>
<li>
<p><code>evict()</code> — удаляет объект из кеша.</p>
</li>
<li>
<p><code>contains()</code> — определяет, находится ли объект в кеше или нет.</p>
</li>
<li>
<p><code>clear()</code> — очищает весь кеш.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>При <strong>кеше первого уровня</strong> все активные сессии работает изолированно друг от друга, и у каждой сессии соответственно имеется свой кеш, который очищается при закрытии сессии.</p>
</div>
</div>
<div class="sect3">
<h4 id="_кеш_второго_уровня">6.2.2. Кеш второго уровня</h4>
<div class="paragraph">
<p><strong>Кеш второго уровня</strong> привязан к <code>SessionFactory</code>, поэтому видимость этого кеша гораздо шире <strong>кеша первого уровня</strong>. Данный вид кеша доступен на протяжении всего времени работы приложения.</p>
</div>
<div class="paragraph">
<p>По умолчанию <strong>кеш второго уровня</strong> отключен. Для включения необходимо при конфигурировании настроек <strong>Hibernate</strong> в строке <code>hibernate.cache.use_second_level_cache</code> установить значение <code>true</code>.</p>
</div>
<div class="paragraph">
<p>На самом деле, <strong>Hibernate</strong> сам не реализует кеширование как таковое, а лишь предоставляет структуру для его реализации. Поэтому подключить можно любую реализацию, которая соответствует спецификации <strong>ORM</strong> фреймворка.</p>
</div>
<div class="paragraph">
<p>Из сказанного выше следует, что помимо <code>hibernate.cache.use_second_level_cache</code> еще необходимо в настройках указать провайдера кеша <code>hibernate.cache.region.factory_class: org.hibernate.cache.ehcache.EhCacheRegionFactory</code>, которого также нужно добавить в зависимости <strong>Maven</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring</span><span class="pi">:</span>
  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">properties</span><span class="pi">:</span>
      <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">cache</span><span class="pi">:</span>
          <span class="na">use_second_level_cache</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">region</span><span class="pi">:</span>
            <span class="na">factory_class</span><span class="pi">:</span> <span class="s">org.hibernate.cache.ehcache.EhCacheRegionFactory</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Из популярных реализаций провайдеров можно выделить следующие:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EHCache</p>
</li>
<li>
<p>OSCache</p>
</li>
<li>
<p>SwarmCache</p>
</li>
<li>
<p>JBoss TreeCache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Эти провайдеры дополнительно можно настраивать, например в файле <code>ehcache.xml</code>, который должен находиться в директории ресурсов. В данном файле, например, можно ограничить количество записей в кеше <code>maxElementsInMemory="500"</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ehcache</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	<span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"ehcache.xsd"</span> <span class="na">updateCheck=</span><span class="s">"true"</span>
	<span class="na">monitoring=</span><span class="s">"autodetect"</span> <span class="na">dynamicConfig=</span><span class="s">"true"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;diskStore</span> <span class="na">path=</span><span class="s">"java.io.tmpdir"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;defaultCache</span>
        <span class="na">maxElementsInMemory=</span><span class="s">"500"</span>
        <span class="na">eternal=</span><span class="s">"false"</span>
        <span class="na">timeToIdleSeconds=</span><span class="s">"60"</span>
        <span class="na">timeToLiveSeconds=</span><span class="s">"60"</span>
        <span class="na">overflowToDisk=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;cache</span> <span class="na">name=</span><span class="s">"cache1"</span>
        <span class="na">maxElementsInMemory=</span><span class="s">"500"</span>
        <span class="na">maxEntriesLocalHeap=</span><span class="s">"10000"</span>
        <span class="na">maxEntriesLocalDisk=</span><span class="s">"1000"</span>
        <span class="na">eternal=</span><span class="s">"false"</span>
        <span class="na">diskSpoolBufferSizeMB=</span><span class="s">"20"</span>
        <span class="na">timeToIdleSeconds=</span><span class="s">"300"</span> <span class="na">timeToLiveSeconds=</span><span class="s">"600"</span>
        <span class="na">memoryStoreEvictionPolicy=</span><span class="s">"LFU"</span>
        <span class="na">transactionalMode=</span><span class="s">"off"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;persistence</span> <span class="na">strategy=</span><span class="s">"localTempSwap"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/ehcache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Помимо вышеуказанного нужно еще самому <strong>Hibernate</strong>, что именно кешировать. Делается это с помощью аннотаций <code>@Cacheable</code> и <code>@Cache</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"shared_doc"</span><span class="o">)</span>
<span class="nd">@Cacheable</span>
<span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span> <span class="o">=</span> <span class="nc">CacheConcurrencyStrategy</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SharedDoc</span><span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Cacheable</code> это аннотация <strong>JPA</strong> и позволяет объекту быть закэшированным. <strong>Hibernate</strong> поддерживает эту аннотацию в том же ключе. <code>@Cache</code> это аннотация <strong>Hibernate</strong>, настраивающая тонкости кэширования объекта в <strong>кэше второго уровня</strong> <strong>Hibernate</strong>. Аннотации <code>@Cacheable</code>  достаточно, чтобы объект начал кэшироваться с настройками по умолчанию. При этом <code>@Cache</code>, использованная без <code>@Cacheable</code>, не разрешит кэширование объекта.</p>
</div>
<div class="paragraph">
<p>Аннотация <code>@Cache</code> имеет несколько атрибутов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>usage</code> - отвечает за стратегию кеширования.</p>
</li>
<li>
<p><code>region</code> - это логический разделитель памяти вашего кеша. Для каждого региона можно настроить свою политику кеширования (для <strong>EhCache</strong> в том же <code>ehcache.xml</code>). Если регион не указан, то используется регион по умолчанию, который имеет полное имя вашего класса для которого применяется кеширование.</p>
</li>
<li>
<p><code>include</code> - Могут ли свойства сущности, указанные с <code>lazy=true</code>, кэшироваться, когда разрешена
"ленивая" выборка на уровне атрибутов. По-умолчанию <strong>all</strong> и может быть также <strong>non-lazy</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Стратегии кеширования определяют поведения кеша в определенных ситуациях. Выделяют четыре группы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Read-only</strong> - используется только для сущностей, которые никогда не изменяются (выбрасывается исключение  при попытке обновить такую сущность). Это очень просто и эффективно. Очень подходит для некоторых статических эталонных данных, которые не меняются.</p>
</li>
<li>
<p><strong>Nonstrict-read-write</strong> - кэш обновляется после фиксации транзакции, которая изменила затронутые данные. Таким образом, строгая согласованность не гарантируется, и существует небольшое временное окно, в течение которого устаревшие данные могут быть получены из кэша. Этот тип стратегии подходит для вариантов использования, которые могут допустить возможную согласованность.</p>
</li>
<li>
<p><strong>Read-write</strong> - эта стратегия гарантирует строгую согласованность, которая достигается за счет использования «мягких» блокировок - когда кэшированный объект обновляется, программная блокировка также сохраняется в кэше для этого объекта, которая освобождается после фиксации транзакции. Все параллельные транзакции, которые обращаются к заблокированным записям, будут извлекать соответствующие данные непосредственно из базы данных.</p>
</li>
<li>
<p><strong>Transactional</strong> - изменения кэша выполняются в распределенных транзакциях. Изменение в кэшированном объекте либо фиксируется, либо откатывается как в базе данных, так и в кэше в одной и той же транзакции.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Помимо вышесказанного, следует помнить — зависимости Вашего класса по умолчанию также не кешируются. Например, если рассмотреть класс выше — <code>SharedDoc</code>, то при выборке коллекция <code>users</code> будет доставаться из базы данных, а не из <strong>кеша второго уровня</strong>. Если Вы хотите также кешировать и зависимости, то необходимо также проаннотировать все необходимы объекты аннотацией <code>@Cache</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"shared_doc"</span><span class="o">)</span>
<span class="nd">@Cacheable</span>
<span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span> <span class="o">=</span> <span class="nc">CacheConcurrencyStrategy</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SharedDoc</span><span class="o">{</span>
    <span class="nd">@Cache</span><span class="o">(</span><span class="n">usage</span> <span class="o">=</span> <span class="nc">CacheConcurrencyStrategy</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Еще одна важная деталь про <strong>кеш второго уровня</strong>. <strong>Hibernate</strong> не хранит сами объекты классов. Он хранит информацию в разобранном (гидратированном) состоянии, в виде массивов строк, чисел и т. д.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Id</code> (первичный ключ) не сохраняется (он хранится как часть ключа кэша)</p>
</li>
<li>
<p>Переходные свойства не сохраняются</p>
</li>
<li>
<p>Коллекции не хранятся</p>
</li>
<li>
<p>Значения свойств, не связанные с ассоциацией, хранятся в исходном виде</p>
</li>
<li>
<p>Для отношений <strong>ToOne</strong> сохраняется только идентификатор (внешний ключ)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Идентификатор объекта выступает указателем на эту информацию. Концептуально это нечто вроде <strong>Map</strong>, в которой <code>id</code> объекта — ключ, а массивы данных — значение. Приблизительно можно представить себе это так - <code>1 &#8594; { "Pupkin", 1, null , {1,2,5} }</code>, что есть очень разумно, учитывая сколько лишней памяти занимает каждый объект.</p>
</div>
<div class="paragraph">
<p>Как уже говорилось выше, сначала <strong>Hibernate</strong> проверяет, хранится ли сущность в <strong>кэше первого уровня</strong>, затем проверяется <strong>кеш второго уровня</strong>, и только после этого, если запрашиваемый объект не найден, <strong>Hibernate</strong> выполнит запрос в базу данных.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
<span class="nc">Pet</span> <span class="n">pet</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pet</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1L</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
<span class="n">pet</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pet</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1L</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>В примере выше, если будет реализован <strong>кеш второго уровня</strong>, то к базе данных будет выполнен всего один запрос.</p>
</div>
</div>
<div class="sect3">
<h4 id="_кеш_запросов">6.2.3. Кеш запросов</h4>
<div class="paragraph">
<p><strong>Кэш запросов</strong>, так же как и <strong>кэш второго уровня</strong>, существует на уровне <code>SessionFactory</code> и доступен во всех <strong>persistence context</strong>. Для <strong>кэша запросов</strong> требуются две дополнительные области физического кэша, в которых хранятся результаты кэшированного запроса и отметки времени последнего обновления таблицы.</p>
</div>
<div class="paragraph">
<p><strong>Кэши первого</strong> и <strong>второго уровней</strong> работают с объектами загружаемыми по <code>id</code>. Но к базе данных чаще выполняются запросы с условиями, чем загружаются какие-то заранее известные объекты. И результат выполнения таких запросов тоже может потребоваться кэшировать. Например, если вы делаете поисковый сайт по автозапчастям, то можете кэшировать запросы пользователей, которые, скорее всего, ищут одни запчасти гораздо чаще других.</p>
</div>
<div class="paragraph">
<p>У <strong>кэша запросов</strong> есть и своя цена — <strong>Hibernate</strong> будет вынужден отслеживать сущности закешированные с определённым запросом и выкидывать запрос из кэша, если кто-то поменяет значение сущности. То есть для <strong>кэша запросов</strong> стратегия параллельного доступа всегда <strong>read-only</strong>. По этим причинам, <strong>Hibernate</strong> по-умолчанию выключает <strong>кэширование запросов</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Кеш запросов</strong> похож на <strong>кеш второго уровня</strong>. Но в отличии от него — ключом к данным кеша выступает не идентификатор объекта, а совокупность параметров запроса. А сами данные — это идентификаторы объектов соответствующих критериям запроса. Таким образом, этот кеш рационально использовать с <strong>кешем второго уровня</strong>.</p>
</div>
<div class="paragraph">
<p>Если у вас есть запросы, выполняющиеся снова и снова, с одними и теми же параметрами, <strong>кэширование запросов</strong> предоставит выигрыш в производительности.</p>
</div>
<div class="paragraph">
<p>Для включения нужно добавить свойства <code>hibernate.cache.use_query_cache=true</code>. Установив свойства значение true, вы заставляете <strong>Hibernate</strong> создавать необходимые кеши в памяти для хранения наборов запросов и идентификаторов. Также надо установить <code>setCacheable(true)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring</span><span class="pi">:</span>
  <span class="na">jpa</span><span class="pi">:</span>
    <span class="na">properties</span><span class="pi">:</span>
      <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">cache</span><span class="pi">:</span>
          <span class="na">use_query_cache</span><span class="pi">:</span> <span class="no">true</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="nc">SessionFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"FROM EMPLOYEE"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setCacheable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setCacheRegion</span><span class="o">(</span><span class="s">"employee"</span><span class="o">);</span>
<span class="nc">List</span> <span class="n">users</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
<span class="nc">SessionFactory</span><span class="o">.</span><span class="na">closeSession</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Hibernate</strong> также поддерживает очень тонкую поддержку кэша благодаря концепции области кэша. Регион кеша является частью кеша, которому дано имя. Пример выше использует метод, чтобы сообщить <strong>Hibernate</strong> хранить и искать запрос в области кэша сотрудников.</p>
</div>
</div>
<div class="sect3">
<h4 id="_link">6.2.4. Link</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://habr.com/ru/post/135176/">Hibernate cache</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/465667/">Spring Cache: от подключения кэширования за 1 минуту до гибкой настройки кэш-менеджера</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/company/ruvds/blog/350310/">Кэширование и производительность веб-приложений</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/company/otus/blog/596087/">Кэш первого уровня JPA и Hibernate</a></p>
</li>
<li>
<p><a href="https://www.baeldung.com/hibernate-second-level-cache">Hibernate Second-Level Cache</a></p>
</li>
<li>
<p><a href="https://coderlessons.com/tutorials/java-tekhnologii/vyuchit-hibernate/hibernate-keshirovanie">Hibernate — Кэширование</a></p>
</li>
<li>
<p><a href="https://sysout.ru/kesh-pervogo-i-vtorogo-urovnya-v-hibernate-i-read_only-cacheconcurrencystrategy/">Кэш первого и второго уровня в Hibernate и READ_ONLY CacheConcurrencyStrategy</a></p>
</li>
<li>
<p><a href="https://easyjava.ru/data/hibernate/keshirovanie-v-hibernate/">Кэширование в Hibernate</a></p>
</li>
<li>
<p><a href="https://proselyte.net/tutorials/hibernate-tutorial/caching/">Кэширование в Hibernate</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=0s48OsEbIU0&amp;ab_channel=KataAcademy">YouTube: «HIBERNATE CACHING»: разбор всех уровней на примере чужих ошибок</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=6mm3EE06ODE&amp;ab_channel=EPAMRUSSIA">YouTube: Секция JAVA: Кэширование в Hibernate</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=qu9UygWQy7A&amp;ab_channel=SportmasterLab">YouTube: Как мы выбирали кеширование Java backend&#8217;а</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_reactor">7. Project Reactor</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_основные_понятия_об_асинхронном_коде">7.1. Основные понятия об асинхронном коде</h3>
<div class="paragraph">
<p>Компьютерные программы часто имеют дело с длительными процессами. Например, получают данные из базы данных или производят сложные вычисления. Пока выполняется одна операция, можно завершить еще несколько. Асинхронное программирование увеличивает эффективность, потому что не позволяет блокировать основной поток выполнения.</p>
</div>
<div class="paragraph">
<p>В синхронном коде каждая операция ожидает окончания предыдущей. Поэтому вся программа может зависнуть, если одна из команд выполняется очень долго. Асинхронный код убирает блокирующую операцию из основного потока программы, так что она продолжает выполняться, но где-то в другом месте, а обработчик может идти дальше. Проще говоря, главный процесс ставит задачу и передает ее другому независимому процессу.</p>
</div>
<div class="paragraph">
<p>Возьмем для примера приложение, которое подбирает фильм по указанным критериям. После того как пользователь выбрал параметры, программа отправляет запрос на сервер, где происходит подбор подходящих картин. Обработка может длиться довольно долго. Если приложение работает синхронно, то пользователь не сможет взаимодействовать со страницей, пока не придет результат.</p>
</div>
<div class="paragraph">
<p>Таким образом, асинхронность в программировании — выполнение процесса в неблокирующем режиме системного вызова, что позволяет потоку программы продолжить обработку.</p>
</div>
</div>
<div class="sect2">
<h3 id="_недостатки_синхронного_программирования">7.2. Недостатки синхронного программирования</h3>
<div class="paragraph">
<p>Рассмотрим основные недостатки синхронного программирования поподробнее.</p>
</div>
<div class="sect3">
<h4 id="_модель_поток_на_запрос">7.2.1. Модель поток на запрос</h4>
<div class="paragraph">
<p>Чтобы понять, что такое реактивное программирование и какие преимущества оно дает, сначала рассмотрим традиционный способ разработки веб-приложения с помощью <strong>Spring</strong> - использование <strong>Spring MVC</strong> и его развертывание в контейнере сервлетов, таком как <strong>Tomcat</strong>: контейнер сервлетов имеет выделенный пул потоков для обработки <strong>HTTP</strong>-запросов, где каждому входящему запросу будет назначен поток, и этот поток будет обрабатывать весь жизненный цикл запроса. Это означает, что приложение сможет обрабатывать количество одновременных запросов, равное размеру пула потоков. Можно настроить размер пула потоков, но поскольку каждый поток резервирует некоторую память (обычно один мегабайт), чем больший размер пула потоков настраиваем, тем выше потребление памяти.</p>
</div>
<div class="paragraph">
<p>Если приложение разработано в соответствии с архитектурой на основе микросервисов, у нас есть лучшие возможности для масштабирования в зависимости от нагрузки, но за высокое использование памяти по-прежнему приходится платить. Таким образом, модель потока на запрос может стать довольно дорогостоящей для приложений с большим количеством одновременных запросов.</p>
</div>
<div class="paragraph">
<p>Важной характеристикой архитектур на основе микросервисов является то, что приложение распределено, выполняется большое количество отдельных процессов, обычно на нескольких серверах. Использование традиционного императивного программирования с синхронными вызовами запроса/ответа для взаимодействия между службами означает, что потоки часто блокируются в ожидании ответа от другой службы, что приводит к огромной трате ресурсов.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ожидание_операций_вводавывода">7.2.2. Ожидание операций ввода/вывода</h4>
<div class="paragraph">
<p>При ожидании завершения операций ввода-вывода возникают потери. В таких ситуациях поток, выполняющий запрос ввода-вывода, будет заблокирован и будет ожидать, пока операция не будет завершена, это называется блокирующим вводом-выводом. Такие ситуации, когда выполняющийся поток блокируется, просто ожидая ответа, означает потерю потоков и, следовательно, потерю памяти.</p>
</div>
<div class="paragraph">
<div class="title">Демонстрация заблокированного потока в ожидании ответа</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/thread-bloking.jpeg" alt="thread bloking"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_время_ответа">7.2.3. Время ответа</h4>
<div class="paragraph">
<p>Другой проблемой традиционного императивного программирования является время отклика, когда службе необходимо выполнить более одного запроса ввода-вывода. Например, службе <strong>A</strong> может потребоваться вызвать службы <strong>B</strong> и <strong>C</strong>, а также выполнить поиск в базе данных, а затем вернуть в результате некоторые агрегированные данные. Это будет означать, что время ответа службы <strong>A</strong>, помимо времени ее обработки, будет суммой следующих значений:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Время отклика услуги <strong>B</strong> (задержка сети + обработка).</p>
</li>
<li>
<p>Время отклика службы <strong>C</strong> (задержка сети + обработка).</p>
</li>
<li>
<p>Время ответа на запрос к базе данных (сетевая задержка + обработка).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Если нет никакой реальной логической причины выполнять эти вызовы последовательно, то, безусловно, если эти вызовы будут выполняться параллельно, это очень положительно повлияет на время отклика службы <strong>А</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_перегрузка_клиента">7.2.4. Перегрузка клиента</h4>
<div class="paragraph">
<p>Другой тип проблемы, которая может возникнуть в ландшафте микросервисов, - это когда сервис <strong>A</strong> запрашивает некоторую информацию у сервиса <strong>B</strong>, скажем, например, обо всех заказах, размещенных в течение последнего месяца.
Если количество заказов окажется огромным, для службы <strong>А</strong> может возникнуть проблема получить всю эту информацию сразу.
Служба <strong>A</strong> может быть перегружена большим объемом данных, что может привести к ошибке нехватки памяти.</p>
</div>
</div>
<div class="sect3">
<h4 id="_резюме">7.2.5. Резюме</h4>
<div class="paragraph">
<p>Различные проблемы, описанные выше - это проблемы, которые призвано решить реактивное программирование.
Преимущества реактивного программирования заключаются в том, что разработчик может:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Отойти от модели поток на запрос и может обрабатывать больше запросов с небольшим количеством потоков.</p>
</li>
<li>
<p>Предотвратить блокировку потоков при ожидании завершения операций ввода-вывода.</p>
</li>
<li>
<p>Оптимизировать параллельные вызовы.</p>
</li>
<li>
<p>Поддерживать <strong>обратное давление</strong>, давая клиенту возможность сообщить серверу, с какой нагрузкой он может справиться.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_что_такое_реактивное_программирование">7.3. Что такое реактивное программирование</h3>
<div class="paragraph">
<p>В документации <strong>Spring</strong> дано следующее краткое определение реактивного программирования:</p>
</div>
<div class="paragraph">
<p><strong>Реактивное программирование</strong> - это неблокирующие приложения, которые являются асинхронными и управляемыми событиями, и требуют небольшого количества потоков для масштабирования. Ключевым аспектом этого определения является концепция противодавления (<strong>backpressure</strong>), которая является механизмом, гарантирующим, что производители не перегружают потребителей.</p>
</div>
<div class="paragraph">
<p>Так как же всего этого достичь? Использовать асинхронные потоки данных!</p>
</div>
<div class="paragraph">
<p>Допустим, служба <strong>A</strong> хочет получить некоторые данные из службы <strong>B</strong>. При подходе в стиле реактивного программирования служба <strong>A</strong> отправит запрос службе <strong>B</strong>, которая немедленно вернет управление (неблокирующий и асинхронный запрос). Затем запрошенные данные будут доступны службе <strong>A</strong> в виде потока данных, где служба <strong>B</strong> будет публиковать событие <strong>onNext()</strong> для каждого элемента данных один за другим. Когда все данные будут опубликованы, об этом просигнализирует событие <strong>onComplete()</strong>. В случае ошибки будет опубликовано событие <strong>onError()</strong> и больше никаких элементов не будет.</p>
</div>
<div class="paragraph">
<div class="title">Реактивный поток событий</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/reactive-event-stream.jpeg" alt="reactive event stream"></span></p>
</div>
<div class="paragraph">
<p><strong>Реактивное программирование</strong> - важный метод реализации при разработке реактивных систем, концепция которого описана в <strong>Reactive Manifesto</strong> - манифесте реактивного программирования, подчеркивая требования к проектированию современных приложений, которые должны быть:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Responsive</strong> - отзывчивы (дают своевременный ответ).</p>
</li>
<li>
<p><strong>Resilient</strong> - устойчивы (остаются отзывчивыми даже в аварийных ситуациях).</p>
</li>
<li>
<p><strong>Elastic</strong> - эластичны (быстрая реакция при различной рабочей нагрузке).</p>
</li>
<li>
<p><strong>Message Driven</strong> - управляются сообщениями (на основе асинхронной передачи сообщений).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Но чтобы спроектировать систему реактивную в целом, также требуется архитектура, которая обеспечивает все эти аспекты.</p>
</div>
<div class="sect3">
<h4 id="_архитектура_обеспечения_аспектов_reactive_manifesto">7.3.1. Архитектура обеспечения аспектов <strong>Reactive Manifesto</strong></h4>
<div class="paragraph">
<p>В основе подхода лежит идея разделения компонентов на два типа: источник событий <strong>Publisher</strong> и обработчик событий <strong>Subscriber</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Subscriber</strong> подписывается на события, которые создаёт <strong>Publisher</strong>, а затем каким-то образом их обрабатывает. У одного <strong>Publisher</strong> может быть много подписчиков.</p>
</div>
<div class="paragraph">
<p>Существует еще одно понятие — <strong>Observer</strong>. Он может подписаться на событие объекта и выполнять какие-либо действия с полученным результатом.</p>
</div>
<div class="paragraph">
<p>Общение между <strong>Publisher</strong> и <strong>Subscriber</strong> происходит через объект <strong>Subscription</strong>.</p>
</div>
<div class="paragraph">
<div class="title">Модель взаимодействия <strong>Publisher</strong> и <strong>Subscriber</strong></div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/relationship-model.png" alt="relationship model"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_спецификация_реактивных_потоков_для_java">7.3.2. Спецификация реактивных потоков для <strong>Java</strong></h4>
<div class="paragraph">
<p>Для <strong>Java</strong> был разработан стандарт спецификации <strong>Reactive Streams</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Reactive Streams</strong> - это небольшая спецификация, предназначенная для реализации реактивными библиотеками, созданными для <strong>JVM</strong>. Он определяет типы, которые необходимо реализовать для достижения взаимодействия между различными реализациями. Спецификация определяет взаимодействие между асинхронными компонентами с противодавлением. Реактивные потоки были реализованы в <strong>Java 9</strong> в виде <strong>Flow API</strong>.</p>
</div>
<div class="paragraph">
<p>Спецификация <strong>Reactive Streams</strong> включает следующие интерфейсы:</p>
</div>
<div class="paragraph">
<p><strong>Publisher</strong> - он представляет производителя данных, является их источником и имеет один метод, который позволяет подписчику зарегистрироваться (подписаться) на издателя.</p>
</div>
<div class="listingblock">
<div class="title">Interface Publisher&lt;T&gt; в Java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Subscriber</strong> - он представляет потребителя и имеет следующие методы:</p>
</div>
<div class="listingblock">
<div class="title">Interface Subscriber&lt;T&gt;  в Java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSubscribe</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">s</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="no">T</span> <span class="n">t</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onSubscribe()</code> - должен вызываться <strong>Publisher</strong> перед началом обработки и использоваться для передачи на <strong>Subscription</strong> объекта от <strong>Publisher</strong> до <strong>Subscriber</strong>.</p>
</li>
<li>
<p><code>onNext()</code> - используется для того, чтобы сигнализировать о том, что был отправлен новый элемент.</p>
</li>
<li>
<p><code>onError()</code> - используется для того, чтобы сигнализировать о том, что произошел сбой <strong>Publisher</strong> и больше никаких элементов не будет.</p>
</li>
<li>
<p><code>onComplete()</code> - используется для того, чтобы сигнализировать, что все элементы были успешно отправлены.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Subscription</strong> в свою очередь, содержит методы, которые позволяют клиенту управлять выдачей элементов <strong>Publisher</strong> (т.е. обеспечивать поддержку противодавления).</p>
</div>
<div class="listingblock">
<div class="title">Interface Subscription в Java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Subscription</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">(</span><span class="kt">long</span> <span class="n">n</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>request()</code> - позволяет <strong>Subscriber</strong> сообщить, <strong>Publisher</strong> сколько дополнительных элементов будет опубликовано.</p>
</li>
<li>
<p><code>cancel()</code> - позволяет подписчику отменить дальнейшую отправку элементов <strong>Publisher</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Если объект должен преобразовывать входящие элементы, а затем передавать их другому <strong>Subscriber</strong>, требуется реализация интерфейса <strong>Processor</strong>. Он действует и как <strong>Subscriber</strong> и как <strong>Publisher</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Interface Processor в Java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Processor</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;,</span> <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Интерфейсы <strong>Publisher</strong>, <strong>Subscriber</strong> и <strong>Subscription</strong> находятся в пакете <strong>org.reactivestreams</strong>, который по умолчанию был добавлен в <strong>Java 9</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_project_reactor_2">7.4. Project REACTOR</h3>
<div class="paragraph">
<p><strong>Project Reactor</strong> - это библиотека <strong>Reactive</strong> для создания неблокирующих приложений на <strong>JVM</strong>, основанная на спецификации <strong>Reactive Streams</strong>.</p>
</div>
<div class="sect3">
<h4 id="_возможности_reactor_core">7.4.1. Возможности <strong>Reactor Core</strong></h4>
<div class="paragraph">
<p><strong>Reactor Core</strong> определяет реактивные типы <strong>Flux</strong> и <strong>Mono</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Flux</strong> - это <strong>Publisher</strong>, который может испускать от <strong>0</strong> до <strong>N</strong> элементов.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Схема работы Flux</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/flux.svg" alt="flux"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Mono</strong> в свою очередь может испускать от <strong>0</strong> до <strong>1</strong> элемента.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Схема работы Mono</div>
<p><span class="image"><img src="../../assets/img/java/project-reactor/mono.svg" alt="mono"></span></p>
</div>
<div class="paragraph">
<p>Оба они завершаются либо сигналом завершения, либо ошибкой, и они вызывают методы <strong>onNext()</strong>, <strong>onComplete()</strong> и <strong>onError()</strong> нижестоящего подписчика. Помимо реализации функций, описанных в спецификации <strong>Reactive Streams</strong>, <strong>Flux</strong> и <strong>Mono</strong> предоставляют набор операторов для поддержки преобразований, фильтрации и обработки ошибок.</p>
</div>
<div class="paragraph">
<p>Приведём пример создания объекта типа <strong>Flux</strong>. Создадим пустой <strong>Flux</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Mono</strong> с помощью <strong>empty()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">void</span> <span class="nf">getEmptyMono</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Mono</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>Flux</strong> содержащий значения:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Mono</strong> с помощью <strong>just()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">void</span> <span class="nf">simpleFluxExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxColors</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">,</span> <span class="s">"blue"</span><span class="o">);</span>
    <span class="n">fluxColors</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>Flux</strong> который выведет в консоль значения от <code>1</code> до <code>5</code>:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Flux</strong> с помощью <strong>range()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">range</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">5</span><span class="o">)</span>
        <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим <strong>Flux</strong>, который испускает эти же самые элементы из списка:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Flux</strong> с помощью <strong>fromIterable()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">fooBarFluxFromList</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxFromList</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">fromIterable</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">));</span>
    <span class="n">fluxFromList</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cоздадим <strong>Flux</strong>, который испускает числа от <code>1</code> до <code>10</code> каждые <code>100</code> мс:</p>
</div>
<div class="listingblock">
<div class="title">Создание объекта типа <strong>Flux</strong> с помощью <strong>interval()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">counter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">flux</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">100</span><span class="o">)).</span><span class="na">take</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">flux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Эти методы создают поток, который испускает предоставленные элементы, а затем завершается. Ничего не передается, пока кто-нибудь на это не подпишется. Чтобы подписаться на него, мы вызываем метод <strong>subscribe()</strong> и в этом случае просто распечатываем отправленные элементы.</p>
</div>
<div class="paragraph">
<p>Создание <strong>Mono</strong> также может быть выполнено с помощью метода <strong>just</strong>, с той лишь разницей, что разрешен только один параметр.</p>
</div>
<div class="paragraph">
<p>Методы класса <strong>Flux</strong> возвращают <strong>Flux</strong> или <strong>Mono</strong>, что означает, что операторы могут быть связаны.</p>
</div>
<div class="paragraph">
<p>Мы можем создать <strong>Flux</strong> из <strong>Mono</strong> и наоборот:</p>
</div>
<div class="listingblock">
<div class="title">Создание <strong>Flux</strong> из <strong>Mono</strong> и наоборот</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">fluxFromMono</span> <span class="o">=</span> <span class="n">mono</span><span class="o">.</span><span class="na">flux</span><span class="o">();</span>
<span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">monoFromFlux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="na">any</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
<span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integerMono</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="na">elementAt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_варианты_метода_subscribe">7.4.2. Варианты метода Subscribe()</h4>
<div class="paragraph">
<p>У программиста есть широкий выбор вариантов метода <strong>subscribe()</strong>, которые принимают лямбда-выражения для различных комбинаций обратных вызовов, как показано в следующих сигнатурах методах:</p>
</div>
<div class="listingblock">
<div class="title">Варианты метода <strong>subscribe()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="mi">1</span><span class="o">)</span> <span class="n">subscribe</span><span class="o">();</span>

<span class="mi">2</span><span class="o">)</span> <span class="n">subscribe</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">);</span>

<span class="mi">3</span><span class="o">)</span> <span class="n">subscribe</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">,</span>
          <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">errorConsumer</span><span class="o">);</span>

<span class="mi">4</span><span class="o">)</span> <span class="n">subscribe</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">,</span>
          <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">errorConsumer</span><span class="o">,</span>
          <span class="nc">Runnable</span> <span class="n">completeConsumer</span><span class="o">);</span>

<span class="mi">5</span><span class="o">)</span> <span class="n">subscribe</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">,</span>
          <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">errorConsumer</span><span class="o">,</span>
          <span class="nc">Runnable</span> <span class="n">completeConsumer</span><span class="o">,</span>
          <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Subscription</span><span class="o">&gt;</span> <span class="n">subscriptionConsumer</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>1) Подписаться и активировать последовательность.</p>
</li>
<li>
<p>2) Сделайте что-нибудь с каждым полученным значением.</p>
</li>
<li>
<p>3) Работать со значениями, но также реагировать на исключительные ситуации.</p>
</li>
<li>
<p>4) Работать со значениями и ошибками, а также запускайте некоторый код после успешного завершения последовательности.</p>
</li>
<li>
<p>5) Работать со значениями, ошибками и успешным завершением, а также делайте что-то с подпиской, созданной этим вызовом подписки.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_перечень_операторов_в_reactor">7.4.3. Перечень операторов в <strong>Reactor</strong></h4>
<div class="paragraph">
<p>Поиск подходящего оператора <strong>Reactor</strong> предоставляет длинный список операторов и в качестве помощи в поиске подходящего оператора для конкретного варианта использования есть специальное приложение в справочной документации <strong>Reactor</strong>.
Он разделен на различные категории, как показано в таблице ниже.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Каскадные операции</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Категория оператора</th>
<th class="tableblock halign-left valign-top">Примеры</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Создание новой последовательности</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">just, fromArray, fromIterable, fromStream</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Преобразование существующей последовательности</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map, flatMap, startWith, concatWith</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Заглядывать в последовательность</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">doOnNext, doOnComplete, doOnError, doOnCancel</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Фильтрация последовательности</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filter, ignoreElements, distinct, elementAt, takeLast</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Обработка ошибок</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">onErrorReturn, onErrorResume, retry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Работаем со временем</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">elapsed, interval, timestamp, timeout</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Расщепление потока</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">buffer, groupBy, window</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Возвращаясь к синхронному миру</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">block, blockFirst, blockLast, toIterable, toStream</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Многоадресная рассылка потока нескольким подписчикам</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">publish, cache, replay</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Например, преобразуем элементы, создаваемые путем применения синхронной функции к каждому элементу:</p>
</div>
<div class="listingblock">
<div class="title">Использование функции <strong>map()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">void</span> <span class="nf">mapExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxColors</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">,</span> <span class="s">"blue"</span><span class="o">);</span>
    <span class="n">fluxColors</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)).</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">print</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат использования функции <strong>map()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">rgb</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Или функция <strong>zip()</strong>, который объединяет несколько источников вместе (ожидая, пока все источники испускают один элемент, и объединяет их в кортеж):</p>
</div>
<div class="listingblock">
<div class="title">Пример использования функции <strong>zip()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">void</span> <span class="nf">zipExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxFruits</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"apple"</span><span class="o">,</span> <span class="s">"pear"</span><span class="o">,</span> <span class="s">"plum"</span><span class="o">);</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxColors</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"red"</span><span class="o">,</span> <span class="s">"green"</span><span class="o">,</span> <span class="s">"blue"</span><span class="o">);</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">fluxAmounts</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">zip</span><span class="o">(</span><span class="n">fluxFruits</span><span class="o">,</span> <span class="n">fluxColors</span><span class="o">,</span> <span class="n">fluxAmounts</span><span class="o">).</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат использования функции <strong>zip()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">[</span><span class="n">apple</span><span class="o">,</span> <span class="n">red</span><span class="o">,</span> <span class="mi">10</span><span class="o">]</span>
<span class="o">[</span><span class="n">pear</span><span class="o">,</span> <span class="n">green</span><span class="o">,</span> <span class="mi">20</span><span class="o">]</span>
<span class="o">[</span><span class="n">plum</span><span class="o">,</span> <span class="n">blue</span><span class="o">,</span> <span class="mi">30</span><span class="o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_обработка_ошибок">7.4.4. Обработка ошибок</h4>
<div class="paragraph">
<p>Создадим <strong>Flux</strong>, который испускает ошибку. Для этого есть специальный сигнал, так как мы не можем просто выбросить исключение — оно может оказаться в другом треде:</p>
</div>
<div class="listingblock">
<div class="title">Создание ошибки в объекте <strong>Flux</strong> с помощью метода <strong>error()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">errorFlux</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">error</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">());</span>
    <span class="n">error</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Ошибки</strong> - это терминальные события. При возникновении ошибки вся последовательность останавливается, и ошибка передается методу <strong>onError()</strong> подписчика, который всегда должен быть определен.
Если не определено, <strong>onError</strong> вызовет исключение <strong>UnsupportedOperationException</strong>.</p>
</div>
<div class="paragraph">
<p>Запустив следующий пример, третье значение никогда не генерируется, поскольку второе значение приводит к ошибке:</p>
</div>
<div class="listingblock">
<div class="title">Генерация ошибки</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxCalc</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"10 / "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="o">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">i</span><span class="o">));</span>

    <span class="n">fluxCalc</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Next: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">),</span>
                       <span class="n">error</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">error</span><span class="o">));</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат генерации ошибки</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nl">Next:</span> <span class="mi">10</span> <span class="o">/</span> <span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="nl">Error:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ArithmeticException</span><span class="o">:</span> <span class="o">/</span> <span class="n">by</span> <span class="n">zero</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Также можно обрабатывать ошибки в середине реактивной цепочки, используя операторы обработки ошибок. Метод <strong>onErrorReturn()</strong> будет выдавать резервное значение, когда наблюдается ошибка указанного типа. Это можно сравнить с перехватом исключения и возвратом статического запасного значения в императивном программировании.</p>
</div>
<div class="listingblock">
<div class="title">Пример обработки ошибки</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorReturnExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxCalc</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"10 / "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="o">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">i</span><span class="o">))</span>
                                <span class="o">.</span><span class="na">onErrorReturn</span><span class="o">(</span><span class="nc">ArithmeticException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"Division by 0 not allowed"</span><span class="o">);</span>
    <span class="n">fluxCalc</span>
            <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Next: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">),</span>
                       <span class="n">error</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">error</span><span class="o">));</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nl">Next:</span> <span class="mi">10</span> <span class="o">/</span> <span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="nl">Next:</span> <span class="nc">Division</span> <span class="n">by</span> <span class="mi">0</span> <span class="n">not</span> <span class="n">allowed</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Как видите, использование оператора обработки ошибок таким образом все еще не позволяет продолжить исходную реактивную последовательность (третье значение здесь также не генерируется), а скорее заменяет ее. Если недостаточно просто вернуть какое-то значение по умолчанию, вы можете использовать этот <strong>onErrorResume()</strong> метод, чтобы подписаться на резервного издателя при возникновении ошибки. Это можно сравнить с перехватом исключения и вызовом резервного метода в императивном программировании. Если, например, вызов внешней службы завершается неудачно, реализация <strong>onErrorResume()</strong> может быть связана с извлечением данных из локального кеша.</p>
</div>
<div class="listingblock">
<div class="title">Перенаправление при возникновении ошибки</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onErrorResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">error</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">());</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">objectFlux</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="na">onErrorResume</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">));</span>
    <span class="n">objectFlux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_модель_параллелизма">7.4.5. Модель параллелизма</h4>
<div class="paragraph">
<p>До сих пор издатель выполнялся в основном потоке так же, как подписчик. Это связано с тем, что <strong>Reactor</strong> не применяет модель параллелизма. Вместо этого выполнение большинства операторов будет продолжено в том же потоке, оставляя выбор за разработчиком. Модель выполнения определяется тем <strong>Scheduler</strong>, что используется.</p>
</div>
<div class="paragraph">
<p>С помощью <strong>Scheduler</strong> можно приказать потоку всегда выполняться в одном и том же thread или выделять новый thread при каждой подписке, или использовать собственный пул потоков и т.д.</p>
</div>
<div class="paragraph">
<p>Есть два способа переключения контекста выполнения в реактивной цепочке: <strong>publishOn()</strong> и <strong>subscribeOn()</strong>. Отличается следующее:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>publishOn(Scheduler scheduler)</code>  - если мы хотим например часть операторов выполнить в одном thread, а часть в другом. В случае с <strong>publishOn()</strong> этот оператор применяется так же, как и любой другой, посреди цепочки вызовов. Все последующие <strong>Subscriber</strong> будут выполняться в контексте указанного <strong>Scheduler</strong>.</p>
</li>
<li>
<p><code>subscribeOn(Scheduler scheduler)</code> — Чтобы изменить thread, в котором будет происходить выполнение реактивного потока. В случае с <strong>subscribeOn</strong> оператор «глобальный», срабатывает сразу на всю цепочку <strong>Subscriber</strong>. После вызова <strong>subscribe()</strong> контекстом выполнения будет указанный <strong>Scheduler</strong>. Далее контекст может изменяться с помощью оператора <strong>publishOn</strong>. Последующие вызовы <strong>subscribeOn</strong> игнорируются.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Класс <strong>Schedulers</strong> содержит статические методы, чтобы обеспечить контекст выполнения, например:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parallel()</code> — работает с пулом рабочих потоков фиксированного размера (по умолчанию размер пула ограничивается числом ядер процессора). Хорошо подходит для вычислительных задач.</p>
</li>
<li>
<p><code>single()</code> — выполнение в выделенном потоке. Он поддерживает планирование с учетом времени, поэтому может использоваться для планирования периодичес- ких событий с задержкой.</p>
</li>
<li>
<p><code>boundedElastic()</code> — динамически создает рабочие потоки и кеширует пулы потоков выполнения. Максимальное число создаваемых пулов потоков выполнения не ограничивается, поэтому этот планировщик можно использовать для организации выполнения задач, связанных с вводом/выводом. При использовании — <strong>Schedulers.newElastic()</strong> — можно указать количество <strong>workers</strong>. Это хороший выбор для обертывания синхронных, блокирующих вызовов.</p>
</li>
<li>
<p><code>immediate()</code> — выполнение будет происходить в текущем потоке.</p>
</li>
<li>
<p><code>fromExecutorService(ExecutorService)</code> - может использоваться для создания Планировщика из любого существующего <strong>ExecutorService</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Рассмотрим на примере:</p>
</div>
<div class="listingblock">
<div class="title">Принцип работы <strong>newParallel()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">publishSubscribeExample</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Scheduler</span> <span class="n">schedulerA</span> <span class="o">=</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newParallel</span><span class="o">(</span><span class="s">"Scheduler A"</span><span class="o">);</span>
    <span class="nc">Scheduler</span> <span class="n">schedulerB</span> <span class="o">=</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newParallel</span><span class="o">(</span><span class="s">"Scheduler B"</span><span class="o">);</span>
    <span class="nc">Scheduler</span> <span class="n">schedulerC</span> <span class="o">=</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newParallel</span><span class="o">(</span><span class="s">"Scheduler C"</span><span class="o">);</span>

    <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"First map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="n">schedulerA</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Second map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">publishOn</span><span class="o">(</span><span class="n">schedulerB</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Third map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="n">schedulerC</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fourth map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">publishOn</span><span class="o">(</span><span class="n">schedulerA</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fifth map: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">blockLast</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Взглянув на вывод можно увидеть, что первая и вторая операции <strong>map()</strong> выполняются в потоке из планировщика <strong>A</strong>, поскольку первый <strong>subscribeOn()</strong> в цепочке переключается на этот планировщик, и это влияет на всю цепочку. Перед третьей операцией <strong>map()</strong> выполняется <strong>publishOn()</strong>, переключающий контекст выполнения на <strong>Scheduler B</strong>, в результате чего третья и четвертая операции <strong>map()</strong> выполняются в этом контексте (поскольку вторая <strong>subscribeOn()</strong> не будет иметь никакого эффекта). И, наконец, есть новый метод <strong>publishOn()</strong>, который переключает обратно на планировщик <strong>A</strong> перед последней операцией <strong>map()</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">First</span> <span class="nl">map:</span> <span class="nc">Scheduler</span> <span class="no">A</span><span class="o">-</span><span class="mi">4</span>
<span class="nc">Second</span> <span class="nl">map:</span> <span class="nc">Scheduler</span> <span class="no">A</span><span class="o">-</span><span class="mi">4</span>
<span class="nc">Third</span> <span class="nl">map:</span> <span class="nc">Scheduler</span> <span class="no">B</span><span class="o">-</span><span class="mi">3</span>
<span class="nc">Fourth</span> <span class="nl">map:</span> <span class="nc">Scheduler</span> <span class="no">B</span><span class="o">-</span><span class="mi">3</span>
<span class="nc">Fifth</span> <span class="nl">map:</span> <span class="nc">Scheduler</span> <span class="no">A</span><span class="o">-</span><span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Некоторые операторы из <strong>Flux</strong> и <strong>Mono</strong> запускаются сразу на конкретном <strong>Scheduler</strong> (но можно передать и свой). Например <strong>Flux.interval()</strong> по умолчанию запускается на <strong>Schedulers.parallel()</strong>, но можно передать свой.</p>
</div>
<div class="listingblock">
<div class="title">Демонстрация установки собственного <strong>Schedulers</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Flux</span><span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">300</span><span class="o">),</span> <span class="nc">Schedulers</span><span class="o">.</span><span class="na">newSingle</span><span class="o">(</span><span class="s">"test"</span><span class="o">));</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_холодные_и_горячие_publisher">7.4.6. Холодные и горячие <strong>Publisher</strong></h4>
<div class="paragraph">
<p>Доступны два типа <strong>Publisher</strong> - <strong>cold</strong> и <strong>hot</strong> (холодные и горячие).</p>
</div>
<div class="paragraph">
<p>Как заявляли ранее, ничего не происходит, пока не подпишемся - но на самом деле это верно только для холодных издателей. <strong>Холодный Publisher</strong> генерирует новые данные для каждой подписке. Если подписки нет, данные никогда не генерируются. Напротив, <strong>hot издатель</strong> не зависит от подписчиков. Он может начать публикацию данных без подписчиков. Если подписчик подписывается после того, как издатель начал передавать значения, он получит только значения, выпущенные после его подписки.</p>
</div>
<div class="paragraph">
<p>Один из способов создания горячего <strong>Publisher</strong> - это вызвать <strong>publish()</strong> метод в <strong>Flux</strong>. Это вернет <strong>ConnectableFlux&lt;T&gt;</strong>, у которого есть метод <strong>connect()</strong> для запуска передачи значений. Подписчики должны затем подписаться на этот <strong>ConnectableFlux</strong> вместо исходного <strong>Flux</strong>.</p>
</div>
<div class="paragraph">
<p>Рассмотрим холодный и горячий <strong>Publisher</strong>, чтобы увидеть различное поведение. В приведенном ниже примере <strong>coldPublisherExample</strong> оператор <strong>interval()</strong> используется для создания потока, который генерирует значения <code>long</code>, начинающиеся с <code>0</code>.</p>
</div>
<div class="listingblock">
<div class="title">Пример использования <strong>interval()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">coldPublisherExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">intervalFlux</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalFlux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber A, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalFlux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber B, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">0</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">1</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">2</span>
<span class="nc">Subscriber</span> <span class="no">B</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">0</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">3</span>
<span class="nc">Subscriber</span> <span class="no">B</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">1</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">4</span>
<span class="nc">Subscriber</span> <span class="no">B</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь можно задаться вопросом, почему что-то происходит, когда основной поток спит, но это потому, что оператор интервала по умолчанию выполняется в планировщике <strong>Schedulers.parallel()</strong>. Как можно заметить, оба подписчика получат значения, начинающиеся с <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Теперь давайте посмотрим, что происходит, когда используем <strong>ConnectableFlux</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Использование объета типа <strong>ConnectableFlux</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">hotPublisherExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">intervalFlux</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">interval</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="nc">ConnectableFlux</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">intervalCF</span> <span class="o">=</span> <span class="n">intervalFlux</span><span class="o">.</span><span class="na">publish</span><span class="o">();</span>
    <span class="n">intervalCF</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalCF</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber A, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">intervalCF</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Subscriber B, value: %d"</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">2</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">3</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">4</span>
<span class="nc">Subscriber</span> <span class="no">B</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">4</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">5</span>
<span class="nc">Subscriber</span> <span class="no">B</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">5</span>
<span class="nc">Subscriber</span> <span class="no">A</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">6</span>
<span class="nc">Subscriber</span> <span class="no">B</span><span class="o">,</span> <span class="nl">value:</span> <span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Можно заметить, на этот раз ни один из подписчиков не получает исходные значения <code>0</code> и <code>1</code>. Они получают значения, которые отправляются после подписки. Вместо того чтобы вручную запускать публикацию, с помощью этого <strong>autoConnect(n)</strong> метода также можно настроить <strong>ConnectableFlux</strong> так, чтобы он запускался после <code>n</code> подписок.</p>
</div>
<div class="paragraph">
<p>Напечатаем текст на каждое действие — подписку, получение нового элемента и завершающего сигнала:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">fluxFruits</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxFruits</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"apple"</span><span class="o">,</span> <span class="s">"pear"</span><span class="o">,</span> <span class="s">"plum"</span><span class="o">);</span>

    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">fluxFruits</span>
        <span class="o">.</span><span class="na">doOnSubscribe</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">doOnNext</span><span class="o">(</span><span class="n">user</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"next value"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">doOnComplete</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"end!"</span><span class="o">));</span>

    <span class="n">flux</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">start</span>
<span class="n">next</span> <span class="n">value</span>
<span class="n">apple</span>
<span class="n">next</span> <span class="n">value</span>
<span class="n">pear</span>
<span class="n">next</span> <span class="n">value</span>
<span class="n">plum</span>
<span class="n">end</span><span class="o">!</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_другие_операторы">7.4.7. Другие операторы</h4>
<div class="sect4">
<h5 id="_функция_firstwithvalue">Функция <code>firstWithValue()</code></h5>
<div class="paragraph">
<p>Надо вернуть <strong>Flux</strong>, который испускает значение быстрее:</p>
</div>
<div class="listingblock">
<div class="title">Пример использования метода <strong>firstWithValue()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">getFirstWithValue</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">firstWithValue</span><span class="o">(</span><span class="n">firstFlux</span><span class="o">(),</span> <span class="n">secondFlux</span><span class="o">())</span>
        <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">4000</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">firstFlux</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="na">delaySubscription</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">2000</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">secondFlux</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">).</span><span class="na">delaySubscription</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="mi">3</span>
<span class="mi">4</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_функция_then">Функция <code>then()</code></h5>
<div class="paragraph">
<p>Преобразовать <strong>Flux</strong> в <strong>Mono</strong>, который испускает сигнал завершения тогда, когда приходит сигнал завершения в <strong>Flux</strong>:</p>
</div>
<div class="listingblock">
<div class="title">Использование функции <strong>then()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">fluxToMono</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">flux</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">);</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">then</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="na">then</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_генерация_с_помощью_функции_generate">Генерация с помощью функции <code>generate()</code></h5>
<div class="paragraph">
<p>Реализовать бесконечный генератор можно с помощью функции <strong>generate()</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Генератор для вывода бесконечного количество раз слова:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">generate</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">generate</span><span class="o">(</span><span class="n">sink</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">sink</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Мы можем ограничить количество генерируемых значений и установить период между ними:</p>
</div>
<div class="listingblock">
<div class="title">Пример использования функции задержки с помощью метода <strong>delayElements()</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">generate</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">generate</span><span class="o">(</span><span class="n">sink</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">sink</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">delayElements</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">500</span><span class="o">))</span>
    <span class="o">.</span><span class="na">take</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
    <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">4000</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Thread.sleep(4000)</code> - заставляет основной поток заснуть на <code>4</code> секунды. Дело в том, что вывод в консоль осуществляется в отдельном потоке, в свою очередь без <strong>Thread.sleep(4000)</strong> основной поток прекратит свою работу, что убьёт и дочерний поток.</p>
</div>
<div class="paragraph">
<p>Генераторы могут быть самыми разными, например такой генератор обладает интересной сигнатурой и может реализовывать самые интересные задумки:</p>
</div>
<div class="listingblock">
<div class="title">Пример генератора</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">S</span><span class="o">&gt;</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">generate</span><span class="o">(</span><span class="nc">Callable</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">stateSupplier</span><span class="o">,</span> <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="no">S</span><span class="o">,</span> <span class="nc">SynchronousSink</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;,</span> <span class="no">S</span><span class="o">&gt;</span> <span class="n">generator</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">onAssembly</span><span class="o">(</span><span class="k">new</span> <span class="nc">FluxGenerate</span><span class="o">&lt;&gt;(</span><span class="n">stateSupplier</span><span class="o">,</span> <span class="n">generator</span><span class="o">));</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Реализация генератора</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">generateBiFunction</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span>
         <span class="o">()</span> <span class="o">-&gt;</span> <span class="mi">2354</span><span class="o">,</span>
         <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">sink</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
             <span class="k">if</span><span class="o">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">2366</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sink</span><span class="o">.</span><span class="na">complete</span><span class="o">();</span>
             <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">sink</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">"Step: "</span> <span class="o">+</span> <span class="n">state</span><span class="o">);</span>
             <span class="o">}</span>
         <span class="k">return</span> <span class="n">state</span> <span class="o">+</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}).</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Вывод в консоль:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nl">Step:</span> <span class="mi">2354</span>
<span class="nl">Step:</span> <span class="mi">2357</span>
<span class="nl">Step:</span> <span class="mi">2360</span>
<span class="nl">Step:</span> <span class="mi">2363</span>
<span class="nl">Step:</span> <span class="mi">2366</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Метод <strong>create()</strong> принимает потребителя <strong>FluxSink&lt;T&gt;</strong>. То есть вам будет предоставлен экземпляр <strong>FluxSink</strong>, с помощью которого вы сможете продолжать испускать <code>0&#8230;&#8203;N</code> элементов нижестоящим подписчикам. Каждый подписчик получит экземпляр <strong>FluxSink</strong> для генерации элементов.</p>
</div>
<div class="paragraph">
<p>Следующий блок кода состоит из двух методов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>generateSmth()</code> - генерирует и возвращает объект <strong>Flux&lt;String&gt;</strong>.</p>
</li>
<li>
<p><code>createFlux()</code> - позволяет получить данные из другого <strong>Flux</strong> объекта с помощью подписки и манипулировать ими благодаря переопределенным методам.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">generateSmth</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span>
        <span class="o">()</span> <span class="o">-&gt;</span> <span class="mi">2354</span><span class="o">,</span>
        <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">sink</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">2366</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sink</span><span class="o">.</span><span class="na">complete</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">sink</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">"Step: "</span> <span class="o">+</span> <span class="n">state</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="k">return</span> <span class="n">state</span> <span class="o">+</span> <span class="mi">3</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createFlux</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">sink</span> <span class="o">-&gt;</span> <span class="n">generateSmth</span><span class="o">().</span><span class="na">subscribe</span><span class="o">(</span><span class="k">new</span> <span class="nc">BaseSubscriber</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">hookOnNext</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sink</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">hookOnComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sink</span><span class="o">.</span><span class="na">complete</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">}))</span>
    <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Это хорошо работает, когда необходимо обрабатывать приходящие данные, но что если работаем с Базой Данных? Такие источники информации делятся данными только при обращении к ним. В таком случае с помощью метода <strong>onRequest()</strong> мы можем обратиться в вымешенную базу данных и запросить элемент:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onRequest</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">sink</span> <span class="o">-&gt;</span> <span class="n">sink</span><span class="o">.</span><span class="na">onRequest</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">sink</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">"DB returns: "</span> <span class="o">+</span> <span class="n">generateSmth</span><span class="o">().</span><span class="na">blockLast</span><span class="o">());</span>
    <span class="o">}))</span>
    <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_класс_basesubscriber">7.4.8. Класс <code>BaseSubscriber</code></h4>
<div class="paragraph">
<p>Рассмотрим интересный класс:</p>
</div>
<div class="listingblock">
<div class="title">Пример кода с наследованием от <strong>BaseSubscriber</strong></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">innerClass</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SampleSubscriber</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SampleSubscriber</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;();</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ints</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
    <span class="n">ints</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">ss</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SampleSubscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">BaseSubscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hookOnSubscribe</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Subscribed"</span><span class="o">);</span>
        <span class="n">request</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hookOnNext</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">request</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Результат выполнения</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Subscribed</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">3</span>
<span class="mi">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Класс <strong>SampleSubscriber</strong> расширяет <strong>BaseSubscriber</strong>, который является рекомендуемым абстрактным классом для определяемых пользователем подписчиков в <strong>Reactor</strong>. Класс предлагает <strong>hooks</strong>, которые можно переопределить, чтобы настроить поведение подписчика. По умолчанию он инициирует неограниченный запрос и ведет себя точно так же, как <strong>subscribe()</strong>. Однако расширение <strong>BaseSubscriber</strong> гораздо полезнее, благодаря своей дополнительной настройкой.</p>
</div>
<div class="paragraph">
<p>Абстрактный класс <strong>BaseSubscriber</strong> позволяет переопределить <strong>hooks</strong>-методы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hookOnSubscribe()</code> - действия при подписке на издателя.</p>
</li>
<li>
<p><code>hookOnNext()</code> - действия с переданным объектом.</p>
</li>
<li>
<p><code>hookOnComplete()</code> - действия по завершению обработки.</p>
</li>
<li>
<p><code>hookOnError()</code> - действия при ошибке.</p>
</li>
<li>
<p><code>hookOnCancel()</code> - выполняемые действия при отмене подписки путем вызова метода <strong>cancel()</strong> этого подписчика.</p>
</li>
<li>
<p><code>hookFinally()</code> - необязательный хук, выполняемый после любого из событий завершения <strong>onError()</strong>, <strong>onComplete()</strong>, <strong>cancel()</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_reactor_test">7.4.9. Reactor Test</h4>
<div class="paragraph">
<p>Модуль <strong>Reactor Test</strong> предоставляет служебные программы, которые могут помочь в тестировании поведения <strong>Flux</strong> или <strong>Mono</strong>. С этим помогает <strong>StepVerifier</strong>. Вы создаете <strong>StepVerifier</strong> и передаете его издателю для тестирования. <strong>StepVerifier</strong> подписывается на <strong>Publisher</strong> при вызове метода <code>verify()</code>, а затем сравнивает выданные значения с вашими определенными ожиданиями.</p>
</div>
<div class="listingblock">
<div class="title">Пример тестирования</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stepVerifierTest</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fluxCalc</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"10 / "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="o">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">i</span><span class="o">));</span>

    <span class="nc">StepVerifier</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">fluxCalc</span><span class="o">)</span>
                <span class="o">.</span><span class="na">expectNextCount</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
                <span class="o">.</span><span class="na">expectError</span><span class="o">(</span><span class="nc">ArithmeticException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">verify</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Для объекта создается <strong>StepVerifier</strong>, определяются два ожидания: сначала ожидается, что будет выдана одна строка, а затем должна быть выдана ошибка с типом <strong>ArithmeticException</strong>. С помощью вызова <code>verify()</code> <strong>StepVerifier</strong> начинает подписываться на <strong>Flux</strong>, и инициируется поток.</p>
</div>
<div class="paragraph">
<p><strong>StepVerifier</strong> также имеет другие функции, такие как включение утверждений после выполнения и поддержка виртуального времени, чтобы избежать длительного времени выполнения тестов, связанных с операторами, основанными на времени. Эти функции можно найти в документации.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_links_5">7.5. Links</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://projectreactor.io/">Project reactor official</a></p>
</li>
<li>
<p><a href="https://projectreactor.io/docs/core/release/reference/">Project reactor documentation</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/565050/">Рективное программирование со Spring</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=77-wOZs2nPE&amp;ab_channel=letsCode">Project Reactor - реактивная Java</a></p>
</li>
<li>
<p><a href="https://sysout.ru/razrabotka-reaktivnyh-prilozhenij-s-reactive-streams-i-java-8-chast-1/">Разработка реактивных приложений с Reactive Streams и Java</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sql">8. SQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Moved to <a href="https://github.com/rakovets/wiki" class="bare">https://github.com/rakovets/wiki</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common">9. Common</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_github_keys">9.1. GitHub keys</h3>
<div class="sect3">
<h4 id="_ssh_key">9.1.1. SSH key</h4>
<div class="paragraph">
<p>С помощью протокола <strong>SSH</strong> можно подключаться и проходить проверку подлинности на удаленных серверах и службах. С помощью ключей <strong>SSH</strong> вы можете подключаться к <strong>GitHub</strong> без предоставления своего имени пользователя и личного маркера доступа при каждом посещении.</p>
</div>
<div class="paragraph">
<p>Для того чтобы использовать подключение с помощью протокола <strong>SSH</strong> необходимо сгенерировать <strong>SSH-KEY</strong>. В данном примере генерация происходит через <strong>GIT GUI</strong>.</p>
</div>
<div class="paragraph">
<p>Для генерации заходим <em>Git GUI Here</em>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-generate1.png" alt="ssh generate1"></span></p>
</div>
<div class="paragraph">
<p>В появившемся окне выбираем вкладку <em>Help</em> - <em>Show SSH Key</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-generate2.png" alt="ssh generate2"></span></p>
</div>
<div class="paragraph">
<p>Если, ключ не обнаружен, то производим генерацию ключа <em>Generate Key</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-generate3.png" alt="ssh generate3"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-generate4.png" alt="ssh generate4"></span></p>
</div>
<div class="paragraph">
<p>После того как ключ был сгенерирован или уже имелся, его нужно скопировать для установки в профиле. Для этого в настройки вашего профиля (<em>setting</em>).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-install-git1.png" alt="ssh install git1"></span></p>
</div>
<div class="paragraph">
<p>Далее ищем вкладку <em>SSH and GPG keys</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-install-git2.png" alt="ssh install git2"></span></p>
</div>
<div class="paragraph">
<p>Нажимаем <em>New SSH key</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-install-git3.png" alt="ssh install git3"></span></p>
</div>
<div class="paragraph">
<p>Вставляем имеющийся ключ и добавляем <em>Add SSH key</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/ssh-install-git4.png" alt="ssh install git4"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_gpg_key">9.1.2. GPG key</h4>
<div class="paragraph">
<p>С помощью <strong>GPG</strong> или <strong>S/MIME</strong> можно подписывать теги и коммиты. Эти теги или коммиты помечаются как проверенные на <strong>GitHub</strong>, чтобы другие люди могли быть уверены, что изменения происходят из надежного источника.</p>
</div>
<div class="paragraph">
<p>Сначала необходимо скачать и становить <a href="https://www.gnupg.org/download/"><strong>Gpg4win</strong></a></p>
</div>
<div class="paragraph">
<p>Затем заходим в Git Bush и вводим команду:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell script">gpg --full-generate-key</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-generate1.png" alt="gpg generate1"></span></p>
</div>
<div class="paragraph">
<p>Затем выбирая нужные настройки нажимаем <em>Enter</em> до тех пор, пока не попросит подтвердить корректность данных и если все верно подтверждаем набрав <code>Y</code></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-generate2.png" alt="gpg generate2"></span></p>
</div>
<div class="paragraph">
<p>Далее вводим свои данные: имя, email.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-generate3.png" alt="gpg generate3"></span></p>
</div>
<div class="paragraph">
<p>Если все верно - подтверждаем введенные данные набрав`О`.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-generate4.png" alt="gpg generate4"></span></p>
</div>
<div class="paragraph">
<p>Вводим пароль(секретное поле) и затем его подтверждаем</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-generate5.png" alt="gpg generate5"></span></p>
</div>
<div class="paragraph">
<p>После этого наши GPG ключи сгенерированы.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-generate6.png" alt="gpg generate6"></span></p>
</div>
<div class="paragraph">
<p>Чтобы посмотреть открытый и закрытый ключи необходимо ввести следующую команду:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell script">gpg --list-secret-keys --keyid-format=long
/Users/hubot/.gnupg/secring.gpg
------------------------------------
sec   4096R/3AA5C34371567BD2 2016-03-10 [expires: 2017-03-10]
uid                          Hubot
ssb   4096R/42B317FD4BA89E7A 2016-03-10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Далее введя команду <strong>gpg --armor --export &#8230;&#8203;</strong>, и подставив место &#8230;&#8203; свое значение получим</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell script">gpg --armor --export 3AA5C34371567BD2</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-install-git1.png" alt="gpg install git1"></span></p>
</div>
<div class="paragraph">
<p>После этого выделяем и копируем от <code>-----BEGIN PGP PUBLIC KEY BLOCK-----</code> до <code>-----END PGP PUBLIC KEY BLOCK-----</code></p>
</div>
<div class="paragraph">
<p>Далее, как и при добавлении <strong>SSH</strong> ключей заходим в свой профиль - <em>setting</em> - <em>SSH and GPG keys</em> и выбираем уже <em>New GPG key</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-install-git2.png" alt="gpg install git2"></span></p>
</div>
<div class="paragraph">
<p>И в появившемся окне вставляем скопированный ключ и добавляем его.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/github-keys/gpg-install-git3.png" alt="gpg install git3"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_тестирование">9.2. Тестирование</h3>
<div class="paragraph">
<p><strong>Тестирование</strong> (<strong>testing</strong>) <strong>программного обеспечения</strong> (<strong>ПО</strong>) – это процесс исследования ПО с целью выявления ошибок и определения соответствия между реальным и ожидаемым поведением ПО, осуществляемый на основе набора тестов, выбранных определённым образом. В более широком смысле, <strong>тестирование ПО</strong> – это техника контроля качества программного продукта, включающая в себя проектирование тестов, выполнение тестирования и анализ полученных результатов.</p>
</div>
<div class="paragraph">
<p>Очень часто современные программные продукты разрабатываются в сжатые сроки и при ограниченных бюджетах проектов. Программирование сегодня перешло из разряда искусства в разряд ремесел для многих миллионов специалистов. Но, к сожалению, в такой спешке разработчики зачастую игнорируют необходимость обеспечения защищённости своих продуктов, подвергая тем самым пользователей неоправданному риску. <strong>Контроль качества</strong> (<strong>тестирование</strong>) считается важным в <strong>процессе разработки ПО</strong>, потому что обеспечивает безопасность, надёжность, удобство создаваемого продукта. В настоящее время существует великое множество подходов и методик к решению задачи тестирования ПО, но эффективное тестирование сложных программных систем — процесс творческий, не сводящийся к следованию строгим и чётким правилам.</p>
</div>
<div class="sect3">
<h4 id="_классификация_видов_тестирования">9.2.1. Классификация видов тестирования</h4>
<div class="paragraph">
<p>Существует несколько признаков, по которым принято производить классификацию видов тестирования. Все <strong>виды тестирования</strong> программного обеспечения можно условно классифицировать по следующему виду:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>По степени автоматизации</p>
</li>
<li>
<p>По уровню доступа</p>
</li>
<li>
<p>В зависимости от преследуемых целей</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/testing/testing-diagram.png" alt="testing diagram"></span></p>
</div>
<div class="sect4">
<h5 id="_по_степени_автоматизации">По степени автоматизации</h5>
<div class="ulist">
<ul>
<li>
<p>Ручное тестирование;</p>
</li>
<li>
<p>Автоматизированное тестирование.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Ручное тестирование</strong> (<strong>manual testing</strong>) – тестирование при котором не используются программные средства для выполнения тестов и проверки результатов выполнения.</p>
</div>
<div class="paragraph">
<p><strong>Автоматизированное тестирование</strong> (<strong>automated testing</strong>) – тестирование, при котором используются программные средства для выполнения тестов и проверки результатов выполнения. <strong>Автоматизированное тестирование</strong>, несомненно, приносит пользу и экономит время и ресурсы компании.</p>
</div>
<div class="paragraph">
<p>В процессе разработки часто бывает так, что новая версия с исправленными ошибками выпускается каждый день, а иногда, и несколько раз в день. <strong>Smoke testing</strong> прежде всего должно быть <strong>автоматизировано</strong>, потому что сразу после сборки новой версии программы нам необходимо в кратчайшие сроки убедиться в том, что программа запускается. Автоматический тест справится с подобной задачей за считанные секунды, и сборку можно будет считать успешной. Если же этим будет заниматься человек, то времени на проверку будет уходить гораздо больше. Таким образом, автоматизация <strong>smoke testing</strong> – это неплохая экономия времени отдела тестирования.</p>
</div>
<div class="paragraph">
<p>Для <strong>автоматизации тестирования</strong> существует большое количество приложений. Наиболее популярные из них:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Selenium</p>
</li>
<li>
<p>TestComplete</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Автоматизация</strong> в целом не только экономит время на разработку, но и увеличивает надежность и безопасность создаваемых продуктов. Очевидны также преимущества для тестировщиков:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>надёжность проверки продукта возрастает</p>
</li>
<li>
<p>время на тестирование сокращается</p>
</li>
<li>
<p>работа тестирующего становится менее стрессовой</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Конечно, автоматические тесты никогда не смогут заменить человека, но могут облегчить работу инженера-тестировщика ПО.</p>
</div>
</div>
<div class="sect4">
<h5 id="_по_уровню_доступа">По уровню доступа</h5>
<div class="ulist">
<ul>
<li>
<p>Тестирование чёрного ящика;</p>
</li>
<li>
<p>Тестирование белого ящика.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_тестирование_чёрного_ящика">Тестирование чёрного ящика</h6>
<div class="paragraph">
<p><strong>Тестирование чёрного ящика</strong> (<strong>black box</strong>) - тестирование ПО, при котором тестировщик имеет доступ к ПО только через интерфейсы заказчика, либо через внешние интерфейсы, позволяющие другому компьютеру или процессу подключиться к системе для тестирования. Этот подход до сих пор является самым распространенным в повседневной практике, но у него есть целый ряд недостатков. Например, некоторые ошибки возникают достаточно редко и потому их трудно найти и воспроизвести.</p>
</div>
</div>
<div class="sect5">
<h6 id="_тестирование_белого_ящика">Тестирование белого ящика</h6>
<div class="paragraph">
<p><strong>Тестирование белого ящика</strong> (<strong>white box</strong>) - тестирование ПО, при котором тестировщик имеет доступ к исходному коду программы и может писать код, связанный с библиотеками тестируемого ПО. К тестированию белого ящика относят методики:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>чтение программ</p>
</li>
<li>
<p>формальный просмотр программ</p>
</li>
<li>
<p>инспекция</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Этот метод позволяет заглянуть внутрь <strong>"чёрного ящика"</strong> и сосредоточиться на внутренней информации, которая и определяет поведение программы. Основной трудностью является сложность отслеживания вычислений времени выполнения. При тестировании программы происходит проверка логики программы. Полным тестированием в этом случае будет такое, которое приведет к перебору всех возможных путей. Даже для средних по сложности программ число таких путей может достигать десятки тысяч.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_в_зависимости_от_преследуемых_целей">В зависимости от преследуемых целей</h5>
<div class="paragraph">
<p>Все <strong>виды тестирования</strong> программного обеспечения, в зависимости от преследуемых целей, можно условно разделить на следующие группы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Функциональные</strong></p>
</li>
<li>
<p><strong>Нефункциональные</strong></p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_функциональные_виды_тестирования">Функциональные виды тестирования</h6>
<div class="paragraph">
<p><strong>Функциональные тесты</strong> базируются на функциях и особенностях, а также взаимодействии с другими системами, и могут быть представлены на всех уровнях тестирования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>компонентном</strong> или <strong>модульном</strong> (<strong>Component</strong>/<strong>Unit testing</strong>)</p>
</li>
<li>
<p><strong>интеграционном</strong> (<strong>Integration testing</strong>),</p>
</li>
<li>
<p><strong>системном</strong> (<strong>System testing</strong>)</p>
</li>
<li>
<p><strong>приемочном</strong> (<strong>Acceptance testing</strong>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Функциональные виды тестирования рассматривают внешнее поведение системы. После проведения необходимых изменений, таких как исправление бага/дефекта, программное обеспечение должно быть протестировано повторно для подтверждения того факта, что проблема была действительно решена. Ниже перечислены виды функционального тестирования, которые необходимо проводить после установки программного обеспечения, для подтверждения работоспособности приложения или правильности осуществленного исправления дефекта:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Функциональное тестирование</strong> (<strong>Functional testing</strong>)</p>
</li>
<li>
<p><strong>Тестирование взаимодействия</strong> (<strong>Interoperability Testing</strong>)</p>
</li>
<li>
<p><strong>Дымовое тестирование</strong> <strong>(Smoke Testing</strong>)</p>
</li>
<li>
<p><strong>Регрессионное тестирование</strong> (<strong>Regression Testing</strong>)</p>
</li>
<li>
<p><strong>Тестирование сборки</strong> (<strong>Build Verification Test</strong>)</p>
</li>
<li>
<p><strong>Санитарное тестирование или проверка согласованности/исправности</strong> (<strong>Sanity Testing</strong>)</p>
</li>
<li>
<p><strong>Альфа-тестирование</strong></p>
</li>
<li>
<p><strong>Бета-тестирование</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Функциональное тестирование</strong> (<strong>functional testing</strong>) – тестирование ПО, направленное на проверку реализуемости функциональных требований.
При функциональном тестировании проверяется способность ПО правильно решать задачи, необходимые пользователям.</p>
</div>
<div class="paragraph">
<p><strong>Альфа-тестирование</strong> – это процесс имитации реальной работы разработчиков с программным продуктом, или реальная работа потенциальных пользователей с системой.</p>
</div>
<div class="paragraph">
<p><strong>Бета-тестирование</strong> – это распространение версий с ограничениями для некоторой группы лиц, с целью проверки содержания допустимо минимального количества ошибок в программном продукте.</p>
</div>
<div class="paragraph">
<p><strong>Регрессионное тестирование</strong> (<strong>regression testing</strong>) – тестирование ПО, при котором проводится проверка ранее найденных ошибок, а также проверка основной функциональности.</p>
</div>
<div class="paragraph">
<p>Проводится, как правило, на каждой новой версии программного продукта. <strong>Регрессивное тестирование является наиболее важной фазой тестирования</strong> непосредственно перед окончанием работ над продуктом, так как непосредственно перед релизом продукта крайне необходимо проверить не только основную функциональность, но и то, что ни одна из ранее найденных ошибок не повторяется в финальной версии. Являясь неотъемлемой частью функционального тестирования, регрессионное тестирование позволяет гарантировать, что изменения, связанные с устранением дефектов, не оказали негативного воздействия на остальные функциональные области приложения.</p>
</div>
<div class="paragraph">
<p><strong>Дымовое тестирование</strong> (<strong>smoke testing</strong>) - тестирование ПО, при котором выполняется набор тестов, после чего можно сказать, что программный продукт запускается.</p>
</div>
<div class="paragraph">
<p>Если ошибок при запуске не происходит, то дымовой тест считается пройденным. Если программа не прошла дымовой тест, то её отправляют на доработку. Дело в том, что разработчики пишут отдельные компоненты одного приложения, но когда эти компоненты объединяют, нередко получается так, что совместно они работать не могут, следовательно, нет смысла тестировать продукт в целом.</p>
</div>
</div>
<div class="sect5">
<h6 id="_нефункциональные_виды_тестирования">Нефункциональные виды тестирования</h6>
<div class="paragraph">
<p>Нефункциональное тестирование описывает тесты, необходимые для определения характеристик программного обеспечения, которые могут быть измерены различными величинами. В целом, это тестирование того, "Как система работает". Далее перечислены основные <strong>виды нефункциональных тестов</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Тестирование производительности</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>нагрузочное тестирование</strong> (<strong>Performance and Load Testing</strong>)</p>
</li>
<li>
<p><strong>стрессовое тестирование</strong> (<strong>Stress Testing</strong>)</p>
</li>
<li>
<p><strong>тестирование стабильности или надежности</strong> (<strong>Stability/Reliability Testing</strong>)</p>
</li>
<li>
<p><strong>объемное тестирование</strong> (<strong>Volume Testing</strong>)</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Тестирование установки</strong> (<strong>Installation testing</strong>)</p>
</li>
<li>
<p><strong>Тестирование удобства пользования</strong> (<strong>Usability Testing</strong>)</p>
</li>
<li>
<p><strong>Тестирование на отказ и восстановление</strong> (<strong>Failover and Recovery Testing</strong>)</p>
</li>
<li>
<p><strong>Конфигурационное тестирование</strong> (<strong>Configuration Testing</strong>)</p>
</li>
<li>
<p><strong>Тестирование безопасности</strong> (<strong>Security and Access Control Testing</strong>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Тестирование производительности</strong> (<strong>performance testing</strong>) – тестирование ПО, позволяющее осуществлять оценку быстродействия программного продукта при определённой нагрузке. Тест производительности выполняется до и после проведения оптимизации с целью выявить изменения в производительности. Если оптимизация не удается, и производительность снижается, то программист может отказаться от неудачной оптимизации. В случае повышения производительности величину этого повышения можно сравнить с ожидаемыми результатами, чтобы убедиться в успешности оптимизации. Задачей теста производительности является выявление фактов повышения и понижения производительности, чтобы можно было избежать неудачных модернизаций.</p>
</div>
<div class="paragraph">
<p><strong>Нагрузочное тестирование</strong> (<strong>load testing</strong>) – тестирование ПО, позволяющее осуществлять оценку быстродействия программного продукта при плановых, повышенных и пиковых нагрузках. Осуществление нагрузочного тестирования перед вводом системы в промышленную эксплуатацию позволяет избегать неожиданных потерь в производительности через полгода - год, когда система будет заполнена данными.</p>
</div>
<div class="paragraph">
<p><strong>Стресс-тестирование</strong> (<strong>stress testing</strong>) – тестирование ПО, которое оценивает надёжность и устойчивость системы в условиях превышения пределов нормального функционирования. Это проверка программы в таких стрессовых ситуациях как наличие большого объёма входных параметров, нехватка дискового пространства или маломощный процессор. <strong>Стресс тестирование</strong> предназначено для проверки настроенного решения и серверной группы на одновременное обслуживание большого количества пользователей. При таком тестировании проверяется не только серверная группа, но и влияние, оказываемое настройками на производительность системы в целом и ее отказоустойчивость. Для проведения такого тестирования необходимо иметь набор компьютеров, эмулирующих работу групп пользователей.</p>
</div>
<div class="paragraph">
<p><strong>Тестирование стабильности</strong> (<strong>stability/endurance/soak testing</strong>) – тестирование ПО, при котором проверяется работоспособность ПО при длительном тестировании со среднем уровнем нагрузки.</p>
</div>
<div class="paragraph">
<p><strong>Тестирование безопасности (security testing)</strong> – тестирование ПО, которое проверяет фактическую реакцию защитных механизмов, встроенных в систему на проникновение злоумышленников.</p>
</div>
<div class="paragraph">
<p><strong>Тестирование совместимости</strong> (<strong>compatibility testing</strong>) - тестирование ПО, которое проверяет работоспособность ПО в определенном окружении.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_уровни_тестирования">9.2.2. Уровни тестирования</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Модульное тестирование;</p>
</li>
<li>
<p>Интеграционное тестирование;</p>
</li>
<li>
<p>Системное тестирование;</p>
</li>
<li>
<p>Приемочное тестирование.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_пирамида_тестирования">Пирамида тестирования</h5>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/testing/test-pyramid.jpeg" alt="test pyramid"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/testing/test-hierarchy.png" alt="test hierarchy"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="_модульное_тестирование">Модульное тестирование</h5>
<div class="paragraph">
<p><strong>Модульное тестирование</strong> – это процесс исследования ПО, при котором тестируется минимально возможный компонент, например, отдельный класс или функция.
Часто модульное тестирование осуществляется разработчиками ПО.</p>
</div>
</div>
<div class="sect4">
<h5 id="_интеграционное_тестирование">Интеграционное тестирование</h5>
<div class="paragraph">
<p><strong>Интеграционное тестирование</strong> – это процесс исследования ПО, при котором тестируется интерфейсы между компонентами или подсистемами.</p>
</div>
</div>
<div class="sect4">
<h5 id="_системное_тестирование">Системное тестирование</h5>
<div class="paragraph">
<p><strong>Системное тестирование</strong> – это процесс исследования ПО, при котором тестируется интегрированная система на её соответствие требованиям заказчика. <strong>Альфа</strong> и <strong>Бета</strong> тестирование относятся к подкатегориям системного тестирования.</p>
</div>
</div>
<div class="sect4">
<h5 id="_приемочное_тестирование_acceptance_testing">Приемочное тестирование (Acceptance Testing)</h5>
<div class="paragraph">
<p><strong>Приемочное тестирование</strong> - формальный процесс тестирования, который проверяет соответствие системы требованиям и проводится с целью:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>определения удовлетворяет ли система приемочным критериям;</p>
</li>
<li>
<p>вынесения решения заказчиком или другим уполномоченным лицом принимается приложение или нет.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Приемочное тестирование</strong> выполняется на основании набора типичных тестовых случаев и сценариев, разработанных на основании требований к данному приложению. Решение о проведении приемочного тестирования принимается, когда:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>продукт достиг необходимого уровня качества;</p>
</li>
<li>
<p>заказчик ознакомлен с <strong>Планом Приемочных Работ</strong> (<strong>Product Acceptance Plan</strong>) или иным документом, где описан набор действий, связанных с проведением приемочного тестирования, дата проведения, ответственные и т.д.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Фаза приемочного тестирования</strong> длится до тех пор, пока заказчик не выносит решение об отправлении приложения на доработку или выдаче приложения.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_динамический_и_статический_анализ_кода">9.2.3. Динамический и статический анализ кода</h4>
<div class="paragraph">
<p>По мере продвижения проекта стоимость устранения дефектов ПО может экспоненциально возрастать. Инструменты <strong>статического</strong> и <strong>динамического</strong> анализа помогают предотвратить эти затраты благодаря обнаружению программных ошибок на ранних этапах жизненного цикла ПО.</p>
</div>
<div class="paragraph">
<p><strong>Динамический анализ кода</strong> (<strong>runtime analysis</strong>) – способ анализа программы непосредственно при ее выполнении. При динамическом анализе проблемы в исходном коде находятся по мере их возникновения. Процесс анализа можно разбить на несколько этапов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>подготовка исходных данных</p>
</li>
<li>
<p>проведение тестового запуска программы</p>
</li>
<li>
<p>сбор необходимых параметров</p>
</li>
<li>
<p>анализ полученных данных</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Статический анализ кода</strong> (<strong>static analysis</strong>) - анализ программы, производимый без реального выполнения исследуемых программ. Статический анализ кода позволяет обнаружить дефекты в исходном коде до того, как код будет готов для запуска.</p>
</div>
<div class="paragraph">
<p>На практике разработчики могут использовать как статический, так и динамический анализ для ускорения процессов разработки и тестирования, а также для повышения качества исходного продукта.</p>
</div>
</div>
<div class="sect3">
<h4 id="_links_6">9.2.4. Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.protesting.ru/testing/testtypes.html">Виды тестирования программного обеспечения</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Википедия. Модульное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/levels/component.html">Компонентное или модульное тестирование.</a></p>
</li>
<li>
<p><a href="https://www.bluej.org/tutorial/testing-tutorial.pdf">Unit Testing in BlueJ.</a></p>
</li>
<li>
<p><a href="https://msdn.microsoft.com/ru-ru/library/windows/apps/jj159318.aspx">Модульное тестирование кода Visual C# в приложениях для Магазина Windows.</a></p>
</li>
<li>
<p><a href="http://rsdn.org/article/testing/UnitTesting.xml">Модульное тестирование: 2+2 = 4?</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D0%BE%D0%B5_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Википедия. Интеграционное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/levels/system.html">Системное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.softwaretestingclass.com/system-testing-what-why-how/">System Testing: What? Why? &amp; How?</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Википедия. Функциональное тестирование.</a></p>
</li>
<li>
<p><a href="https://symfony.com/legacy/doc/jobeet/1_4/ru/09?orm=doctrine">День 9: Функциональное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/types/functional.html">Функциональное тестирование.</a></p>
</li>
<li>
<p>StackOverflow. <a href="https://stackoverflow.com/questions/2741832/unit-tests-vs-functional-tests">Unit tests vs Functional Testing.</a></p>
</li>
<li>
<p><a href="">Unit, Integration, and Functional Testing</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8">Википедия. Тестирование производительности.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/types/loadtesttypes.html">Нагрузочное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/automation/performance.html">Автоматизация нагрузочного тестирования.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%9D%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%BE%D0%B5_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Википедия. Нагрузочное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/types/loadtesttypes.html">Нагрузочное тестирование.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A1%D1%82%D1%80%D0%B5%D1%81%D1%81-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BE%D0%B1%D0%B5%D1%81%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D1%8F">Википедия. Стресс-тестирование программного обеспечения.</a></p>
</li>
<li>
<p><a href="https://devblogs.microsoft.com/cppblog/vc-ide-design-time-stress-testing/">VC++ IDE / Design Time Stress Testing</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8">Википедия. Тестирование стабильности.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D0%B8">Википедия. Тестирование безопасности.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE_%D1%81%D1%82%D1%80%D0%B0%D1%82%D0%B5%D0%B3%D0%B8%D0%B8_%D1%87%D1%91%D1%80%D0%BD%D0%BE%D0%B3%D0%BE_%D1%8F%D1%89%D0%B8%D0%BA%D0%B0">Википедия. Тестирование по стратегии чёрного ящика.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE_%D1%81%D1%82%D1%80%D0%B0%D1%82%D0%B5%D0%B3%D0%B8%D0%B8_%D0%B1%D0%B5%D0%BB%D0%BE%D0%B3%D0%BE_%D1%8F%D1%89%D0%B8%D0%BA%D0%B0">Википедия. Стратегия тестирования по принципу "Белого ящика".</a></p>
</li>
<li>
<p><a href="https://dic.academic.ru/dic.nsf/ruwiki/392944">Альфа тестирование.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%91%D0%B5%D1%82%D0%B0-%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Википедия. Бета-тестирование.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B3%D1%80%D0%B5%D1%81%D1%81%D0%B8%D0%BE%D0%BD%D0%BD%D0%BE%D0%B5_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Википедия. Регрессивное тестирование.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/types/regression.html">Регрессивное тестирование.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/Smoke_test">Википедия. Smoke test.</a></p>
</li>
<li>
<p><a href="http://www.protesting.ru/testing/types/smoke.html">Дымовое тестирование.</a></p>
</li>
<li>
<p><a href="https://tpl-it.wikispaces.com/%d0%a0%d1%83%d1%87%d0%bd%d0%be%d0%b5+%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5+(manual+testing)">Ручное тестирование.</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/145974/">Тестирование: Ручное или Автоматизированное?</a></p>
</li>
<li>
<p><a href="">Автоматизированное тестирование.</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/145974/">Тестирование: Ручное или Автоматизированное?</a></p>
</li>
<li>
<p><a href="https://pvs-studio.com/ru/blog/terms/0070/">Динамический анализ кода.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%94%D0%B8%D0%BD%D0%B0%D0%BC%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7_%D0%BA%D0%BE%D0%B4%D0%B0">Википедия. Динамический анализ кода.</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/%D0%A1%D1%82%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7_%D0%BA%D0%BE%D0%B4%D0%B0">Википедия. Статический анализ кода.</a></p>
</li>
<li>
<p><a href="https://pvs-studio.com/ru/blog/terms/0046/">Статический анализ кода.</a></p>
</li>
<li>
<p><a href="https://pvs-studio.com/ru/blog/posts/a0087/">Джон Кармак о статическом анализе кода.</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_web_services">9.3. Web services</h3>
<div class="paragraph">
<p>В каждой отрасли бизнеса, каждой компании, как правило, используется огромное количество ПО, которым нужно взаимодействовать между собой. За десятилетия существования <strong>Web</strong> как отрасли сформировались следующие практики межсетевого взаимодействия:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Обмен файлами по <strong>FTP</strong>.</p>
</li>
<li>
<p>Неструктурированные <strong>HTTP</strong>-запросы, договорённости между разработчиками.</p>
</li>
<li>
<p><strong>Web services</strong>.</p>
</li>
<li>
<p><strong>Sockets</strong>, порты, бинарные объекты.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Web services</strong> (<strong>веб сервисы</strong>, <strong>веб службы</strong>) - это технология, позволяющая системам обмениваться данными друг с другом через сетевое подключение. Обычно веб-сервисы работают поверх протокола <strong>HTTP</strong> или протокола более высокого уровня. <strong>Web service</strong> — просто адрес, ссылка, обращение к которому позволяет получить данные или выполнить действие.</p>
</div>
<div class="paragraph">
<p>Другими словами <strong>web service</strong> это код, доступный по протоколу (например <strong>HTTP</strong>) и возвращающий информацию в каком-то формате (например <strong>XML</strong>, <strong>JSON</strong>) конкретному приложению.</p>
</div>
<div class="paragraph">
<p><strong>Web service</strong> можно использовать для одного приложения на компьютере или предоставить к нему доступ через <strong>Интернет</strong> любому числу приложений. Поскольку доступ к <strong>web service</strong> выполняется через стандартный интерфейс, с нем могут работать различные системы, образуя единую вычислительную сеть.</p>
</div>
<div class="paragraph">
<p>В <strong>web services</strong> всегда есть клиент и сервер. Сервер – это и есть наш <strong>web service</strong> и иногда его называют <strong>endpoint</strong> (типа как, конечная точка, куда доходят сообщения от клиента).</p>
</div>
<div class="paragraph">
<p>Самые известные способы реализации веб-сервисов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>XML-RPC</strong> (<strong>XML Remote Procedure Call</strong>) — протокол удаленного вызова процедур с использованием <strong>XML</strong>. Прародитель <strong>SOAP</strong>. Предельно прост в реализации.</p>
</li>
<li>
<p><strong>SOAP</strong> (<strong>Simple Object Access Protocol</strong>) — стандартный протокол по версии <strong>W3C</strong>. Четко структурирован и задокументирован.</p>
</li>
<li>
<p><strong>JSON-RPC</strong> (<strong>JSON Remote Procedure Call</strong>) — более современный аналог <strong>XML-RPC</strong>. Основное отличие — данные передаются в формате <strong>JSON</strong>.</p>
</li>
<li>
<p><strong>REST</strong> (<strong>Representational State Transfer</strong>) — архитектурный стиль взаимодействия компьютерных систем в сети основанный на методах протокола <strong>HTTP</strong>.</p>
</li>
<li>
<p>Специализированные протоколы для конкретного вида задач, такие как <strong>GraphQL</strong>.</p>
</li>
<li>
<p>Менее распространенный, но более эффективный <strong>gRPC</strong>, передающий данные в бинарном виде и использующий <strong>HTTP/2</strong> в качестве транспорта.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Главное отличие web service</strong> от других способов передачи данных: <strong>стандартизированность</strong>. Приняв решение использовать веб-сервисы, можно сразу переходить к структуре данных и доступным функциям. Например, В <strong>SOAP</strong> (как более строгом протоколе), уже решён вопрос уведомления об ошибках.</p>
</div>
<div class="sect3">
<h4 id="_soap_web_services">9.3.1. SOAP web-services</h4>
<div class="paragraph">
<p><strong>SOAP</strong> <strong>web-services</strong> ("<strong>Big web-service</strong>", классический <strong>web-service</strong>) - это протокол, предназначенный для обмена структурированной информацией в децентрализованной распределенной среде. Первоначально <strong>SOAP</strong> расшифровывался как <strong>Simple Object Access Protocol</strong> и предназначался в основном для реализации удалённого вызова процедур (<strong>RPC</strong>). Сейчас протокол используется для обмена произвольными сообщениями в формате <strong>XML</strong>, а не только для вызова процедур.</p>
</div>
<div class="paragraph">
<p><strong>SOAP</strong> использует технологии <strong>XML</strong> для определения расширяемой инфраструктуры обмена сообщениями, обеспечивающей конструкцию сообщения, которой можно обмениваться по множеству базовых протоколов. Платформа была разработана так, чтобы быть независимой от какого-либо языка программирования и другой специфической семантики реализации.</p>
</div>
<div class="paragraph">
<p>Протокол <strong>SOAP</strong> не различает вызов процедуры и ответ на него, а просто определяет формат послания (<strong>message</strong>) в виде документа <strong>XML</strong>. Послание может содержать вызов процедуры, ответ на него, запрос на выполнение каких-то других действий или просто текст. Спецификацию <strong>SOAP</strong> не интересует содержимое послания, она задает только его оформление.</p>
</div>
<div class="paragraph">
<p>Две основные цели разработки <strong>SOAP</strong> - это простота и расширяемость. <strong>SOAP</strong> пытается достичь этих целей, исключая из инфраструктуры обмена сообщениями функции, которые часто встречаются в распределенных системах. Такие функции включают, помимо прочего, «надежность», «безопасность», «корреляцию», «маршрутизацию» и «шаблоны обмена сообщениями» (<strong>MEP</strong>). Хотя ожидается, что будут определены многие функции, эта спецификация предоставляет подробные сведения только для двух <strong>MEP</strong>. Остальные функции оставлены для определения как расширения другими спецификациями.</p>
</div>
<div class="paragraph">
<p>Как было сказано выше, <strong>SOAP</strong> является протоколом и имеет спецификацию. В качестве транспортного протокола может использовать <strong>HTTP</strong>, <strong>SMTP</strong>, <strong>FTP</strong>, <strong>JMS</strong>. Все детали сообщений (в обе стороны – от клиента к серверу и обратно) передаются в стандартизованном <strong>XML</strong>-документе. <strong>SOAP</strong> чаще всего применяется поверх <strong>HTTP</strong>(<strong>S</strong>).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/web-services/soap-architecture.png" alt="soap architecture"></span></p>
</div>
<div class="paragraph">
<p><strong>SOAP</strong> – это базовая однонаправленная модель соединения, обеспечивающая согласованную передачу сообщения от отправителя к получателю, потенциально допускающая наличие посредников, которые могут обрабатывать часть сообщения или добавлять к нему дополнительные элементы. Спецификация <strong>SOAP</strong> содержит соглашения по преобразованию однонаправленного обмена сообщениями в соответствии с принципом «запрос/ответ», а также определяет как осуществлять передачу всего <strong>XML</strong>-документа.</p>
</div>
<div class="paragraph">
<p>Нужно отметить, что определение <strong>SOAP</strong> <strong>web-services</strong> состоит из набора протоколов (спецификаций):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Протокол <strong>SOAP</strong> необходим для реализации возможностей обратного вызова</p>
</li>
<li>
<p>Протокол <strong>WSDL</strong> (<strong>Web-Service Description Language</strong>) язык определения <strong>web-services</strong> или язык описания внешних интерфейсов web-службы на базе <strong>XML</strong></p>
</li>
<li>
<p>Протокол <strong>UDDI</strong> (<strong>необязательный</strong>) (<strong>Universal Description, Discovery, Interoperability</strong>) универсальное описание или каталог веб-служб и сведений предоставляющих <strong>WSDL</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/web-services/web-service-soap.png" alt="web service soap"></span></p>
</div>
<div class="sect4">
<h5 id="_soap_message">SOAP message</h5>
<div class="paragraph">
<p>Любое сообщение в протоколе <strong>SOAP</strong> — это <strong>XML</strong> документ.</p>
</div>
<div class="paragraph">
<p>Данный документ состоит из следующих элементов (тегов):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>SOAP Envelope</strong> — конверт (корневой обязательный элемент), который определяет сообщение и пространство имен, использованное в документе.</p>
</li>
<li>
<p><strong>SOAP Header</strong> — заголовок, необязательный элемент, содержит атрибуты сообщения, например: информация о безопасности или о сетевой маршрутизации.</p>
</li>
<li>
<p><strong>SOAP Body</strong> — основной элемент, содержит сообщение, которым обмениваются приложения.</p>
</li>
<li>
<p><strong>Fault</strong> — необязательный элемент, предоставляет информацию об ошибках, которые произошли при обработке сообщений.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/web-services/soap-message.png" alt="soap message"></span></p>
</div>
<div class="paragraph">
<p>Конверт является самым «верхним» элементом <strong>SOAP</strong> сообщения. Описывается с помощью элемента <code>Envelope</code> с обязательным пространством имен <code><a href="http://www.w3.org/2003/05/soap-envelope" class="bare">http://www.w3.org/2003/05/soap-envelope</a></code> для версии 1.2 и <code><a href="http://schemas.xmlsoap.org/soap/" class="bare">http://schemas.xmlsoap.org/soap/</a></code> для версии 1.1. У элемента <code>Envelope</code> могут быть атрибуты <code>xmlns</code>, определяющие пространства имен, и другие атрибуты, снабженные префиксами.</p>
</div>
<div class="paragraph">
<p>Заголовок <strong>SOAP</strong> является не обязательный. Заголовок кроме атрибутов <code>xmlns</code> может содержать 0 или более стандартных атрибутов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>encodingStyle</code></p>
</li>
<li>
<p><code>actor</code> (или role для версии 1.2)</p>
</li>
<li>
<p><code>mustUnderstand</code></p>
</li>
<li>
<p><code>relay</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Элемент <code>Body</code> обязательно записывается сразу за элементом <code>Header</code>, если он есть в сообщении, или первым в <strong>SOAP</strong>-сообщении, если заголовок отсутствует. В элемент <code>Body</code> можно вложить произвольные элементы, спецификация никак не определяет их структуру. Определен только один стандартный элемент, который может быть в теле сообщения - <code>Fault</code>, содержащий сообщение об ошибке.</p>
</div>
<div class="paragraph">
<p>Если <strong>SOAP</strong>-сервер, обрабатывая поступившее <strong>SOAP</strong>-сообщение, обнаружит ошибку, то он прекратит обработку и отправит клиенту <strong>SOAP</strong>-сообщение, содержащее один элемент <code>Fault</code> с сообщением об ошибке.</p>
</div>
<div class="paragraph">
<p>Пример запроса на сервер:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:soap=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;soap:Body&gt;</span>
     <span class="nt">&lt;getProductDetails</span> <span class="na">xmlns=</span><span class="s">"www.example.com"</span><span class="nt">&gt;</span>
       <span class="nt">&lt;productID&gt;</span>12345<span class="nt">&lt;/productID&gt;</span>
     <span class="nt">&lt;/getProductDetails&gt;</span>
   <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Пример ответа:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:soap=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;soap:Body&gt;</span>
     <span class="nt">&lt;getProductDetailsResponse</span> <span class="na">xmlns=</span><span class="s">"www.example.com"</span><span class="nt">&gt;</span>
       <span class="nt">&lt;getProductDetailsResult&gt;</span>
         <span class="nt">&lt;productID&gt;</span>12345<span class="nt">&lt;/productID&gt;</span>
         <span class="nt">&lt;productName&gt;</span>Стакан граненый<span class="nt">&lt;/productName&gt;</span>
         <span class="nt">&lt;description&gt;</span>Стакан граненый. 250 мл.<span class="nt">&lt;/description&gt;</span>
         <span class="nt">&lt;price&gt;</span>9.95<span class="nt">&lt;/price&gt;</span>
         <span class="nt">&lt;currency&gt;</span>
             <span class="nt">&lt;code&gt;</span>840<span class="nt">&lt;/code&gt;</span>
             <span class="nt">&lt;alpha3&gt;</span>USD<span class="nt">&lt;/alpha3&gt;</span>
             <span class="nt">&lt;sign&gt;</span>$<span class="nt">&lt;/sign&gt;</span>
             <span class="nt">&lt;name&gt;</span>US dollar<span class="nt">&lt;/name&gt;</span>
             <span class="nt">&lt;accuracy&gt;</span>2<span class="nt">&lt;/accuracy&gt;</span>
         <span class="nt">&lt;/currency&gt;</span>
         <span class="nt">&lt;inStock&gt;</span>true<span class="nt">&lt;/inStock&gt;</span>
       <span class="nt">&lt;/getProductDetailsResult&gt;</span>
     <span class="nt">&lt;/getProductDetailsResponse&gt;</span>
   <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_wsdl">WSDL</h5>
<div class="paragraph">
<p><strong>WSDL</strong> (<strong>Web Services Description Language</strong>) — язык описания веб-сервисов и доступа к ним, основанный на языке <strong>XML</strong>.</p>
</div>
<div class="paragraph">
<p>Другими словами, определения <strong>WSDL</strong> описывают, как получить доступ к веб-службе и какие операции она будет выполнять.</p>
</div>
<div class="paragraph">
<p>Каждый документ <strong>WSDL 1.1</strong> можно разбить на следующие логические части:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Определение типов данных (<strong>types</strong>) — определение вида отправляемых и получаемых сервисом <strong>XML</strong>-сообщений</p>
</li>
<li>
<p>Элементы данных (<strong>message</strong>) — сообщения, используемые web-сервисом</p>
</li>
<li>
<p>Абстрактные операции (<strong>portType</strong>) — список операций, которые могут быть выполнены с сообщениями</p>
</li>
<li>
<p>Связывание сервисов (<strong>binding</strong>) — способ, которым сообщение будет доставлено</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/common/web-services/wsdl-file.png" alt="wsdl file"></span></p>
</div>
<div class="paragraph">
<p>Документ WSDL содержит следующие элементы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Определение</strong> — это корневой элемент всех документов <strong>WSDL</strong>. Он определяет имя веб-службы, объявляет несколько пространств имен, используемых в оставшейся части документа, и содержит все элементы службы, описанные здесь.</p>
</li>
<li>
<p><strong>Типы данных</strong> — типы данных, которые будут использоваться в сообщениях, представлены в форме схем <strong>XML</strong>.</p>
</li>
<li>
<p><strong>Сообщение — это абстрактное определение данных в форме сообщения, представленного либо в виде всего документа, либо в качестве аргументов, которые</strong> должны быть сопоставлены с вызовом метода.</p>
</li>
<li>
<p><strong>Операция</strong> — это абстрактное определение операции для сообщения, например, присвоение имени методу, очереди сообщений или бизнес-процессу, которое примет и обработает сообщение.</p>
</li>
<li>
<p><strong>Тип порта</strong> — это абстрактный набор операций, сопоставленный с одной или несколькими конечными точками, определяющий набор операций для привязки; коллекция операций, как она абстрактна, может быть сопоставлена с несколькими транспортными средствами через различные привязки.</p>
</li>
<li>
<p><strong>Связывание</strong> — это конкретный протокол и форматы данных для операций и сообщений, определенных для определенного типа порта.</p>
</li>
<li>
<p><strong>Порт</strong> — это сочетание привязки и сетевого адреса, обеспечивающее целевой адрес службы связи.</p>
</li>
<li>
<p><strong>Сервис</strong> — это набор связанных конечных точек, охватывающий определения сервиса в файле; службы сопоставляют привязку с портом и включают любые определения расширяемости.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>В дополнение к этим основным элементам спецификация <strong>WSDL</strong> также определяет следующие служебные элементы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Документация</strong> — Этот элемент используется для предоставления удобочитаемой документации и может быть включен в любой другой элемент <strong>WSDL</strong>.</p>
</li>
<li>
<p><strong>Импорт</strong> — этот элемент используется для импорта других документов WSDL или схем XML.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Файл <strong>WSDL</strong> выглядит следующим образом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;definitions</span> <span class="na">name =</span> <span class="s">"HelloService"</span>
   <span class="na">targetNamespace =</span> <span class="s">"http://www.examples.com/wsdl/HelloService.wsdl"</span>
   <span class="na">xmlns =</span> <span class="s">"http://schemas.xmlsoap.org/wsdl/"</span>
   <span class="na">xmlns:soap =</span> <span class="s">"http://schemas.xmlsoap.org/wsdl/soap/"</span>
   <span class="na">xmlns:tns =</span> <span class="s">"http://www.examples.com/wsdl/HelloService.wsdl"</span>
   <span class="na">xmlns:xsd =</span> <span class="s">"http://www.w3.org/2001/XMLSchema"</span><span class="nt">&gt;</span>

   <span class="nt">&lt;message</span> <span class="na">name =</span> <span class="s">"SayHelloRequest"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;part</span> <span class="na">name =</span> <span class="s">"firstName"</span> <span class="na">type =</span> <span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/message&gt;</span>

   <span class="nt">&lt;message</span> <span class="na">name =</span> <span class="s">"SayHelloResponse"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;part</span> <span class="na">name =</span> <span class="s">"greeting"</span> <span class="na">type =</span> <span class="s">"xsd:string"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/message&gt;</span>

   <span class="nt">&lt;portType</span> <span class="na">name =</span> <span class="s">"Hello_PortType"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;operation</span> <span class="na">name =</span> <span class="s">"sayHello"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;input</span> <span class="na">message =</span> <span class="s">"tns:SayHelloRequest"</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;output</span> <span class="na">message =</span> <span class="s">"tns:SayHelloResponse"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/operation&gt;</span>
   <span class="nt">&lt;/portType&gt;</span>

   <span class="nt">&lt;binding</span> <span class="na">name =</span> <span class="s">"Hello_Binding"</span> <span class="na">type =</span> <span class="s">"tns:Hello_PortType"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;soap:binding</span> <span class="na">style =</span> <span class="s">"rpc"</span>
         <span class="na">transport =</span> <span class="s">"http://schemas.xmlsoap.org/soap/http"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;operation</span> <span class="na">name =</span> <span class="s">"sayHello"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;soap:operation</span> <span class="na">soapAction =</span> <span class="s">"sayHello"</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;input&gt;</span>
            <span class="nt">&lt;soap:body</span>
               <span class="na">encodingStyle =</span> <span class="s">"http://schemas.xmlsoap.org/soap/encoding/"</span>
               <span class="na">namespace =</span> <span class="s">"urn:examples:helloservice"</span>
               <span class="na">use =</span> <span class="s">"encoded"</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;/input&gt;</span>

         <span class="nt">&lt;output&gt;</span>
            <span class="nt">&lt;soap:body</span>
               <span class="na">encodingStyle =</span> <span class="s">"http://schemas.xmlsoap.org/soap/encoding/"</span>
               <span class="na">namespace =</span> <span class="s">"urn:examples:helloservice"</span>
               <span class="na">use =</span> <span class="s">"encoded"</span><span class="nt">/&gt;</span>
         <span class="nt">&lt;/output&gt;</span>
      <span class="nt">&lt;/operation&gt;</span>
   <span class="nt">&lt;/binding&gt;</span>

   <span class="nt">&lt;service</span> <span class="na">name =</span> <span class="s">"Hello_Service"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;documentation&gt;</span>WSDL File for HelloService<span class="nt">&lt;/documentation&gt;</span>
      <span class="nt">&lt;port</span> <span class="na">binding =</span> <span class="s">"tns:Hello_Binding"</span> <span class="na">name =</span> <span class="s">"Hello_Port"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;soap:address</span>
            <span class="na">location =</span> <span class="s">"http://www.examples.com/SayHello/"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/port&gt;</span>
   <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/definitions&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Definitions</strong> - <code>HelloService</code></p>
</li>
<li>
<p><strong>Type</strong> - использование встроенных типов данных, которые определены в <strong>XMLSchema</strong>.</p>
</li>
<li>
<p><strong>Message</strong></p>
<div class="ulist">
<ul>
<li>
<p><code>sayHelloRequest</code> - параметр firstName</p>
</li>
<li>
<p><code>sayHelloresponse</code> - возвращаемое значение приветствия</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Port Type</strong> - операция <code>sayHello</code>, состоящая из службы запроса и ответа.</p>
</li>
<li>
<p><strong>Binding</strong>  - Направление использования транспортного протокола <strong>SOAP</strong> <strong>HTTP</strong>.</p>
</li>
<li>
<p><strong>Service</strong>  - Сервис доступен по адресу <code><a href="http://www.examples.com/SayHello/" class="bare">http://www.examples.com/SayHello/</a></code>.</p>
</li>
<li>
<p><strong>Port</strong>  - связывает привязку с <strong>URI</strong> <code><a href="http://www.examples.com/SayHello/" class="bare">http://www.examples.com/SayHello/</a></code>, по которому можно получить доступ к работающей службе.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_преимущества">Преимущества</h5>
<div class="paragraph">
<p>Преимущества:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Работа с методами</p>
</li>
<li>
<p>Наличие строгой спецификации</p>
</li>
<li>
<p>Большое количества спецификаций</p>
</li>
<li>
<p>Поддержка транзакций, уровней безопасности и пр.</p>
</li>
<li>
<p>Различные транспортные уровни (<strong>HTTP</strong>, <strong>SMTP</strong>, <strong>FTP</strong>, <strong>JMS</strong>)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_недостатки">Недостатки</h5>
<div class="paragraph">
<p>Недостатки:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Сложность реализации (по сравнению с <strong>REST</strong>);</p>
</li>
<li>
<p>Работа только через <strong>XML</strong></p>
</li>
<li>
<p>Сложность/ресурсоемкость парсинга XML-данных</p>
</li>
<li>
<p>При изменениях необходимо обновлять <strong>WSDL</strong>, и, следовательно, вносить изменения на клиенте</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_restful">9.3.2. RESTful</h4>
<div class="paragraph">
<p><strong>REST</strong> (<strong>Representational State Transfer</strong>) — на самом деле архитектурный стиль, а не протокол. Фактически, он основывается на соглашениях. Сервис построенный в стиле REST называется REST-сервисом. Веб-сервис, построенный с учетом всех требований и ограничений архитектурного стиля, можно назвать <strong>RESTful</strong> веб-сервисом.</p>
</div>
<div class="paragraph">
<p><strong>REST</strong> не зависит от какого-либо протокола, но почти каждый <strong>RESTful</strong> сервис использует <strong>HTTP</strong> как основной протокол.</p>
</div>
<div class="paragraph">
<p>Существует шесть обязательных ограничений для построения распределённых <strong>REST</strong>-приложений:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Модель клиент-сервер</p>
</li>
<li>
<p>Отсутствие состояния</p>
</li>
<li>
<p>Кэширование</p>
</li>
<li>
<p>Единообразие интерфейса</p>
</li>
<li>
<p>Слои</p>
</li>
<li>
<p>Код по требованию (необязательное ограничение)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_модель_клиент_сервер">Модель клиент-сервер</h5>
<div class="paragraph">
<p>Первым ограничением, применимым к гибридной модели, является приведение архитектуры к модели клиент-сервер. Разграничение потребностей является принципом, лежащим в основе данного накладываемого ограничения. Отделение потребности интерфейса клиента от потребностей сервера, хранящего данные, повышает переносимость кода клиентского интерфейса на другие платформы, а упрощение серверной части улучшает масштабируемость. Наибольшее же влияние на всемирную паутину, пожалуй, имеет само разграничение, которое позволяет отдельным частям развиваться независимо друг от друга, поддерживая потребности в развитии интернета со стороны различных организаций.</p>
</div>
</div>
<div class="sect4">
<h5 id="_отсутствие_состояния">Отсутствие состояния</h5>
<div class="paragraph">
<p>Протокол взаимодействия между клиентом и сервером требует соблюдения следующего условия: в период между запросами клиента никакая информация о состоянии клиента на сервере не хранится (Stateless protocol или «протокол без сохранения состояния»). Все запросы от клиента должны быть составлены так, чтобы сервер получил всю необходимую информацию для выполнения запроса. Состояние сессии при этом сохраняется на стороне клиента. Информация о состоянии сессии может быть передана сервером какому-либо другому сервису (например, в службу базы данных) для поддержания устойчивого состояния, например, на период установления аутентификации. Клиент инициирует отправку запросов, когда он готов (возникает необходимость) перейти в новое состояние.</p>
</div>
<div class="paragraph">
<p>Во время обработки клиентских запросов считается, что клиент находится в переходном состоянии. Каждое отдельное состояние приложения представлено связями, которые могут быть задействованы при следующем обращении клиента.</p>
</div>
</div>
<div class="sect4">
<h5 id="_кэширование">Кэширование</h5>
<div class="paragraph">
<p>Как и во Всемирной паутине, клиенты, а также промежуточные узлы, могут выполнять кэширование ответов сервера. Ответы сервера, в свою очередь, должны иметь явное или неявное обозначение как кэшируемые или некэшируемые с целью предотвращения получения клиентами устаревших или неверных данных в ответ на последующие запросы. Правильное использование кэширования способно частично или полностью устранить некоторые клиент-серверные взаимодействия, ещё больше повышая производительность и масштабируемость системы.</p>
</div>
</div>
<div class="sect4">
<h5 id="_единообразие_интерфейса">Единообразие интерфейса</h5>
<div class="paragraph">
<p>К фундаментальным требованиям <strong>REST</strong> архитектуры относится и унифицированный, единообразный интерфейс. Клиент должен всегда понимать, в каком формате и на какие адреса ему нужно слать запрос, а сервер, в свою очередь, также должен понимать, в каком формате ему следует отвечать на запросы клиента. Этот единый формат клиент-серверного взаимодействия, который описывает, что, куда, в каком виде и как отсылать и является унифицированным интерфейсом.</p>
</div>
<div class="paragraph">
<p>Наличие унифицированного интерфейса является фундаментальным требованием дизайна <strong>REST</strong>-сервисов. Унифицированные интерфейсы позволяют каждому из сервисов развиваться независимо.</p>
</div>
<div class="paragraph">
<p>К унифицированным интерфейсам предъявляются следующие четыре ограничительных условия:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Идентификация ресурсов</strong>. Все ресурсы идентифицируются в запросах, например, с использованием <strong>URI</strong> в интернет-системах. Ресурсы концептуально отделены от представлений, которые возвращаются клиентам. Например, сервер может отсылать данные из базы данных в виде <strong>HTML</strong>, <strong>XML</strong> или <strong>JSON</strong>, ни один из которых не является типом хранения внутри сервера.</p>
</li>
<li>
<p><strong>Манипуляция ресурсами через представление</strong>. Если клиент хранит представление ресурса, включая метаданные — он обладает достаточной информацией для модификации или удаления ресурса.</p>
</li>
<li>
<p><strong>«Самоописываемые» сообщения</strong>. Каждое сообщение содержит достаточно информации, чтобы понять, каким образом его обрабатывать. К примеру, обработчик сообщения (<strong>parser</strong>), необходимый для извлечения данных, может быть указан в списке <strong>MIME</strong>-типов.</p>
</li>
<li>
<p><strong>Гипермедиа как средство изменения состояния приложения</strong> (<strong>HATEOAS</strong>). Клиенты изменяют состояние системы только через действия, которые динамически определены в гипермедиа на сервере (к примеру, гиперссылки в гипертексте). Исключая простые точки входа в приложение, клиент не может предположить, что доступна какая-то операция над каким-то ресурсом, если не получил информацию об этом в предыдущих запросах к серверу. Не существует универсального формата для предоставления ссылок между ресурсами, <strong>Web Linking</strong> (<strong>RFC 5988</strong> &#8594; <strong>RFC 8288</strong>) и J<strong>SON Hypermedia API Language</strong> являются двумя популярными форматами предоставления ссылок в <strong>REST HYPERMEDIA</strong> сервисах.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_слои">Слои</h5>
<div class="paragraph">
<p>Клиент обычно не способен точно определить, взаимодействует он напрямую с сервером или же с промежуточным узлом, в связи с иерархической структурой сетей (подразумевая, что такая структура образует слои). Применение промежуточных серверов способно повысить масштабируемость за счёт балансировки нагрузки и распределённого кэширования. Промежуточные узлы также могут подчиняться политике безопасности с целью обеспечения конфиденциальности информации</p>
</div>
</div>
<div class="sect4">
<h5 id="_код_по_требованию_необязательное_ограничение">Код по требованию (необязательное ограничение)</h5>
<div class="paragraph">
<p><strong>REST</strong> может позволить расширить функциональность клиента за счёт загрузки кода с сервера в виде апплетов или сценариев. Филдинг утверждает, что дополнительное ограничение позволяет проектировать архитектуру, поддерживающую желаемую функциональность в общем случае, но, возможно, за исключением некоторых контекстов.</p>
</div>
</div>
<div class="sect4">
<h5 id="_преимущества_2">Преимущества</h5>
<div class="paragraph">
<p>Преимущества:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Легко разрабатывать</p>
</li>
<li>
<p>Производительность (за счёт использования кэша);</p>
</li>
<li>
<p>Может возвращать ответ в разных видах (<strong>HTML</strong>, <strong>XML</strong>, <strong>JSON</strong>, строка и т.д.)</p>
</li>
<li>
<p>Легко вносить изменения без изменения клиента</p>
</li>
<li>
<p>Надёжность (за счёт отсутствия необходимости сохранять информацию о состоянии клиента, которая может быть утеряна);</p>
</li>
<li>
<p>Масштабируемость;</p>
</li>
<li>
<p>Простота интерфейсов;</p>
</li>
<li>
<p>Портативность компонентов;</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_недостатки_2">Недостатки</h5>
<div class="paragraph">
<p>Недостатки:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Не сохраняет состояния (<strong>HTTP</strong> не сохраняет состояние)</p>
</li>
<li>
<p>Важный недостаток <strong>REST API</strong> — слабая устойчивость к взлому.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_отличия_rest_от_soap">9.3.3. Отличия <code>REST</code> от <code>SOAP</code></h4>
<div class="paragraph">
<p><strong>REST</strong> и <strong>SOAP</strong> на самом деле не сопоставимы. <strong>REST</strong> — это архитектурный стиль. <strong>SOAP</strong> — это протокол отправки сообщения. Давайте сравним популярные реализации стилей <strong>REST</strong> и <strong>SOAP</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>SOAP</strong> это протокол, <strong>REST</strong> – это архитектурный стиль, <strong>SOAP</strong> имеет веб-сервис <strong>WSDL</strong> с прописанными методами, которые можно удаленно вызывать.</p>
</li>
<li>
<p><strong>REST</strong> использует <strong>JSON</strong> и <strong>XML</strong>, <strong>SOAP</strong> только <strong>XML</strong>.</p>
</li>
<li>
<p><strong>REST</strong> работает только по <strong>HTTP/HTTPS</strong>, <strong>SOAP</strong> с любым протоколом прикладного уровня: <strong>SMPT</strong>, <strong>FTP</strong>, <strong>HTTP</strong>, <strong>HTTPS</strong>, <strong>POP3</strong></p>
</li>
<li>
<p><strong>REST</strong> более простой, гибкий и быстрый, <strong>SOAP</strong> типизированный, но в некоторых случаях лучше визуализируется за счет применения им синтаксиса похожего на <strong>HTML</strong> разметку.</p>
</li>
<li>
<p><strong>RESTFful</strong> веб-сервисы, как правило, гораздо проще реализовать, чем веб-сервисы на основе <strong>SOAP</strong>.</p>
</li>
<li>
<p>В <strong>REST</strong> легко изменять функционал без изменения клиента, в то время в <strong>SOAP</strong> после изменений необходимо изменять WSDL и, следовательно, вносить изменения на клиенте.</p>
</li>
<li>
<p><strong>REST</strong> может работать с ресурсами. Каждый <strong>URL</strong> это представление какого-либо ресурса. <strong>SOAP</strong> работает с операциями, которые реализуют какую-то бизнес-логику с помощью нескольких интерфейсов.</p>
</li>
<li>
<p><strong>SOAP</strong> на основе чтения не может быть помещена в кэш, а <strong>REST</strong> в этом случае может быть закэширован.</p>
</li>
<li>
<p><strong>SOAP</strong> поддерживает <strong>TLS</strong> и <strong>WS-security</strong>, в то время как <strong>REST</strong> - только <strong>TLS</strong>.</p>
</li>
<li>
<p><strong>SOAP</strong> поддерживает <strong>ACID</strong> (<strong>Atomicity</strong>, <strong>Consistency</strong>, <strong>Isolation</strong>, <strong>Durability</strong>). <strong>REST</strong> поддерживает транзакции, но не один из <strong>ACID</strong> не совместим с двух фазовым коммитом.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_links_7">9.3.4. Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://habr.com/ru/post/46374/">Веб-сервисы в теории и на практике для начинающих</a></p>
</li>
<li>
<p><a href="https://javarush.ru/groups/posts/1168-veb-servisih-shag-1-chto-takoe-veb-servis-i-kak-s-nim-rabotatjh">Веб-сервисы. Шаг 1. Что такое веб-сервис и как с ним работать?</a></p>
</li>
<li>
<p><a href="https://ru.wikipedia.org/wiki/SOAP">Wikipedia: SOAP</a></p>
</li>
<li>
<p><a href="http://khpi-iip.mipk.kharkiv.edu/library/sotii/lectures/Lecture5.pdf">Стандарт SOAP – протокол взаимодействия сервисов</a></p>
</li>
<li>
<p><a href="https://www.tutorialspoint.com/wsdl/wsdl_example.htm">WSDL - Example</a></p>
</li>
<li>
<p><a href="https://coderlessons.com/tutorials/xml-tekhnologii/uznaite-wsdl/wsdl-kratkoe-rukovodstvo">WSDL — Краткое руководство</a></p>
</li>
<li>
<p><a href="http://java-online.ru/web-service.xhtml">Описание WEB-сервисов, XML-RPC</a></p>
</li>
<li>
<p><a href="https://glebradchenko.susu.ru/courses/bachelor/odp/2013/SUSU_Distr_09_SOAP_01.pdf">Распределенные вычислительные системы</a></p>
</li>
<li>
<p><a href="http://art-in-stamps.ru/development/restful-web-services.shtml">Веб-сервисы RESTful</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/483202/">Введение в REST API — RESTful веб-сервисы</a></p>
</li>
<li>
<p><a href="https://javarush.ru/groups/posts/2486-obzor-rest-chastjh-1-chto-takoe-rest">Обзор REST. Часть 1: что такое REST</a></p>
</li>
<li>
<p><a href="https://www.intervolga.ru/blog/projects/relsy-veb-integratsii-rest-i-soap/">Рельсы веб-интеграции. REST и SOAP</a></p>
</li>
<li>
<p><a href="http://citforum.ru/internet/webservice/soap_rest/">SOAP и REST, вместе или порознь?</a></p>
</li>
<li>
<p><a href="https://qastart.by/class-2/23-rest-soap">REST / SOAP</a></p>
</li>
<li>
<p><a href="https://habr.com/ru/post/483204/">Различия REST и SOAP</a></p>
</li>
<li>
<p><a href="https://jsehelper.blogspot.com/2016/04/web-services.html">Ответы на вопросы на собеседование Web services</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=P2wA_JehjK8&amp;ab_channel=SergeyNemchinskiy">YouTube: Rest web-services vs SOAP Services</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=oetMZo2PEFc&amp;t=794s&amp;ab_channel=javabegin">YouTube: Введение в веб сервисы</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=2YWfJHDNQy0&amp;t=40s&amp;ab_channel=okiseleva">YouTube: Введение в SOAP и REST: что это и с чем едят</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-05-12 07:51:36 UTC
</div>
</div>
</body>
</html>